<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>üí§ Ultimate Sleep Tracker PRO - –ú–∞—Ä–∫—É—Å –∏ –í–∏–ª—å—è–º</title>

    <!-- PWA Configuration -->
    <link rel="manifest" href="data:application/json;base64,eyJuYW1lIjoi8J2kIFVsdGltYXRlIFNsZWVwIFRyYWNrZXIgUFJPIiwic2hvcnRfbmFtZSI6IlNsZWVwIFBSTyIsInN0YXJ0X3VybCI6Ii8iLCJkaXNwbGF5Ijoic3RhbmRhbG9uZSIsImJhY2tncm91bmRfY29sb3IiOiIjZmZmZmZmIiwidGhlbWVfY29sb3IiOiIjNjY3ZWVhIn0=">

    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="üí§ Sleep PRO">
    <meta name="theme-color" content="#667eea">

<style>
:root {
    --primary: #667eea; --secondary: #764ba2; --success: #10b981; --warning: #f59e0b; --danger: #ef4444; --critical: #dc2626; --gold: #f59e0b;
    --bg-primary: #ffffff; --bg-secondary: #f8fafc; --bg-card: #ffffff; --text-primary: #1f2937; --text-secondary: #6b7280; --border: #e5e7eb; --border-light: #f3f4f6;
    --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05); --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1); --radius: 12px; --radius-sm: 8px;
    --marcus: #667eea; --william: #10b981;
}

@media (prefers-color-scheme: dark) {
    :root { --bg-primary: #111827; --bg-secondary: #1f2937; --bg-card: #374151; --text-primary: #f9fafb; --text-secondary: #9ca3af; --border: #4b5563; --border-light: #374151; }
}

* { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

body {
    font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Display', 'Helvetica Neue', Arial, sans-serif;
    background: var(--bg-primary); color: var(--text-primary); line-height: 1.5; min-height: 100vh;
    -webkit-font-smoothing: antialiased; -moz-osx-font-smoothing: grayscale; overflow-x: hidden; padding-bottom: 120px;
}

.app-container { max-width: 428px; margin: 0 auto; background: var(--bg-primary); min-height: 100vh; position: relative; }

/* Header */
.header {
    background: linear-gradient(135deg, var(--primary), var(--secondary)); color: white; padding: 20px 16px 16px;
    text-align: center; position: sticky; top: 0; z-index: 100; box-shadow: var(--shadow-md);
}
.header.marcus { background: linear-gradient(135deg, var(--marcus), #5a67d8); }
.header.william { background: linear-gradient(135deg, var(--william), #059669); }
.header h1 { font-size: 22px; font-weight: 700; margin-bottom: 4px; letter-spacing: -0.025em; }
.header .subtitle { font-size: 14px; opacity: 0.9; font-weight: 500; }

/* Child Selection */
.child-selector { display: flex; justify-content: center; gap: 8px; margin: 16px 16px 0; }
.child-btn {
    flex: 1; padding: 12px 16px; border: none; border-radius: var(--radius); font-size: 16px; font-weight: 600;
    cursor: pointer; transition: all 0.2s ease; background: var(--bg-card); color: var(--text-secondary); border: 2px solid var(--border);
}
.child-btn.active.marcus { background: var(--marcus); color: white; border-color: var(--marcus); box-shadow: var(--shadow-md); }
.child-btn.active.william { background: var(--william); color: white; border-color: var(--william); box-shadow: var(--shadow-md); }
.child-btn:hover { transform: translateY(-1px); }

/* Multi Child Dropdown */
.multi-child-selector { position: relative; margin: 16px 16px 0; }
.selected-child { 
    width: 100%; padding: 12px 16px; border: 2px solid var(--border); border-radius: var(--radius); 
    background: var(--bg-card); color: var(--text-primary); font-size: 16px; font-weight: 600; cursor: pointer;
    display: flex; align-items: center; justify-content: space-between;
}
.child-dropdown {
    position: absolute; top: 100%; left: 0; right: 0; background: var(--bg-card); border: 2px solid var(--border);
    border-radius: var(--radius); margin-top: 4px; box-shadow: var(--shadow-md); z-index: 200; max-height: 200px; overflow-y: auto;
    display: none;
}
.child-dropdown.show { display: block; }
.child-option {
    padding: 12px 16px; cursor: pointer; font-size: 14px; font-weight: 500; border-bottom: 1px solid var(--border-light);
    transition: background 0.2s ease;
}
.child-option:hover { background: var(--bg-secondary); }
.child-option:last-child { border-bottom: none; }

/* PRO Controls */
.pro-controls { display: flex; justify-content: center; gap: 6px; margin: 12px 16px; flex-wrap: wrap; }
.pro-btn {
    flex: 1; min-width: 80px; padding: 8px 10px; border: none; border-radius: var(--radius); font-size: 11px; font-weight: 600;
    cursor: pointer; transition: all 0.2s ease; background: var(--bg-card); color: var(--text-secondary); border: 2px solid var(--border);
}
.pro-btn.active { background: var(--success); color: white; border-color: var(--success); }

/* Time Widget */
.time-widget {
    background: var(--bg-card); margin: 16px; padding: 20px; border-radius: var(--radius);
    box-shadow: var(--shadow-sm); border: 1px solid var(--border-light); text-align: center;
}
.current-time { font-size: 28px; font-weight: 700; color: var(--primary); font-variant-numeric: tabular-nums; margin-bottom: 4px; }
.time-label { font-size: 13px; color: var(--text-secondary); font-weight: 500; }

/* Schedule Cards */
.schedule-section { padding: 0 16px 20px; }
.section-title { font-size: 18px; font-weight: 700; color: var(--text-primary); margin-bottom: 16px; text-align: left; letter-spacing: -0.025em; }

.schedule-card {
    background: var(--bg-card); border-radius: var(--radius); padding: 20px; margin-bottom: 12px;
    box-shadow: var(--shadow-sm); border: 1px solid var(--border-light); transition: all 0.2s ease;
}
.schedule-card:active { transform: scale(0.98); }
.schedule-card.sleep { border-left: 4px solid var(--primary); }
.schedule-card.wake { border-left: 4px solid var(--warning); }
.schedule-card.critical { border-left: 4px solid var(--critical); animation: subtle-pulse 2s infinite; }
.schedule-card.danger-window { border-left: 4px solid var(--danger); background: rgba(239, 68, 68, 0.05); }

@keyframes subtle-pulse {
    0%, 100% { background-color: var(--bg-card); }
    50% { background-color: rgba(239, 68, 68, 0.05); }
}

.card-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 16px; }
.activity-info { display: flex; align-items: center; gap: 8px; }
.activity-emoji { font-size: 20px; }
.activity-name { font-size: 16px; font-weight: 600; color: var(--text-primary); }

.time-inputs { display: flex; align-items: center; gap: 8px; font-size: 15px; font-weight: 600; color: var(--primary); }
.time-input {
    border: none; background: var(--bg-secondary); padding: 8px 12px; border-radius: var(--radius-sm);
    font-size: 15px; font-weight: 600; color: var(--text-primary); text-align: center; min-width: 70px; font-variant-numeric: tabular-nums;
}
.time-input:focus { outline: 2px solid var(--primary); outline-offset: 0; }

.card-content { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 16px; }
.metric { text-align: center; }
.metric-label {
    font-size: 11px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.05em;
    color: var(--text-secondary); margin-bottom: 4px;
}
.metric-value { font-size: 14px; font-weight: 700; color: var(--text-primary); font-variant-numeric: tabular-nums; }

.status-row { display: flex; align-items: center; justify-content: space-between; padding-top: 16px; border-top: 1px solid var(--border-light); }
.status-badge { padding: 6px 12px; border-radius: 20px; font-size: 12px; font-weight: 700; text-align: center; }
.status-success { background: rgba(16, 185, 129, 0.1); color: var(--success); }
.status-warning { background: rgba(245, 158, 11, 0.1); color: var(--warning); }
.status-danger { background: rgba(239, 68, 68, 0.1); color: var(--danger); }
.status-gold { background: rgba(245, 158, 11, 0.15); color: var(--gold); position: relative; overflow: hidden; }

.status-gold::before {
    content: ''; position: absolute; top: 0; left: -100%; width: 100%; height: 100%;
    background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent); animation: shimmer 2s infinite;
}
@keyframes shimmer { 0% { left: -100%; } 100% { left: 100%; } }

.timer-info { font-size: 12px; font-weight: 600; color: var(--text-secondary); text-align: right; }

.recommendation {
    background: var(--bg-secondary); padding: 12px; border-radius: var(--radius-sm); margin-top: 12px; border-left: 3px solid var(--primary);
}
.recommendation-text { font-size: 13px; font-weight: 500; color: var(--text-primary); line-height: 1.4; }
.recommendation.warning { border-left-color: var(--warning); }
.recommendation.danger { border-left-color: var(--danger); animation: gentle-shake 0.5s ease-in-out; }
@keyframes gentle-shake { 0%, 100% { transform: translateX(0); } 25% { transform: translateX(-2px); } 75% { transform: translateX(2px); } }

/* Smart Recommendations */
.smart-rec {
    background: linear-gradient(135deg, rgba(16, 185, 129, 0.1), rgba(16, 185, 129, 0.05));
    border: 1px solid rgba(16, 185, 129, 0.2); padding: 12px; border-radius: var(--radius-sm); margin-top: 8px;
}
.smart-rec-title { font-size: 12px; font-weight: 700; color: var(--success); margin-bottom: 4px; text-transform: uppercase; letter-spacing: 0.05em; }
.smart-rec-text { font-size: 12px; color: var(--text-secondary); line-height: 1.3; }

/* Wake Window Indicator */
.wake-window-bar {
    width: 100%; height: 6px; background: var(--border-light); border-radius: 3px; margin: 8px 0; overflow: hidden;
}
.wake-window-fill {
    height: 100%; border-radius: 3px; transition: all 0.3s ease;
}
.wake-window-fill.safe { background: var(--success); }
.wake-window-fill.warning { background: var(--warning); }
.wake-window-fill.danger { background: var(--danger); }

/* Wake Window Alert */
.window-alert {
    background: var(--danger); color: white; padding: 12px 16px; border-radius: var(--radius); margin: 8px 0; text-align: center;
    font-size: 13px; font-weight: 700; animation: urgent-pulse 1s infinite;
}
.window-alert.warning { background: var(--warning); }
@keyframes urgent-pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.8; } }

/* Settings Panel */
.settings-panel { display: none; padding: 0 16px 20px; }
.settings-panel.active { display: block; }
.settings-title { font-size: 18px; font-weight: 700; color: var(--text-primary); margin-bottom: 16px; }

.setting-item {
    background: var(--bg-card); border-radius: var(--radius); padding: 16px; margin-bottom: 12px;
    box-shadow: var(--shadow-sm); border: 1px solid var(--border-light);
}
.setting-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 8px; }
.setting-label { font-size: 14px; font-weight: 600; color: var(--text-primary); }

.toggle { position: relative; display: inline-block; width: 42px; height: 24px; }
.toggle input { opacity: 0; width: 0; height: 0; }
.slider {
    position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0;
    background-color: #ccc; transition: 0.3s; border-radius: 24px;
}
.slider:before {
    position: absolute; content: ""; height: 18px; width: 18px; left: 3px; top: 3px;
    background-color: white; transition: 0.3s; border-radius: 50%;
}
input:checked + .slider { background-color: var(--success); }
input:checked + .slider:before { transform: translateX(18px); }

.setting-description { font-size: 12px; color: var(--text-secondary); line-height: 1.4; }

/* Kids Management */
.kids-panel { display: none; padding: 0 16px 20px; }
.kids-panel.active { display: block; }

.add-kid-form {
    background: var(--bg-card); border-radius: var(--radius); padding: 16px; margin-bottom: 16px;
    box-shadow: var(--shadow-sm); border: 1px solid var(--border-light);
}
.form-row { display: flex; gap: 8px; margin-bottom: 12px; }
.form-input {
    flex: 1; padding: 10px 12px; border: 1px solid var(--border); border-radius: var(--radius-sm);
    font-size: 14px; background: var(--bg-primary); color: var(--text-primary);
}
.add-btn {
    padding: 10px 16px; background: var(--primary); color: white; border: none;
    border-radius: var(--radius-sm); font-size: 14px; font-weight: 600; cursor: pointer;
}

.kids-list { display: flex; flex-wrap: wrap; gap: 8px; }
.kid-chip {
    background: var(--bg-secondary); padding: 8px 12px; border-radius: 20px; font-size: 12px; font-weight: 600;
    cursor: pointer; transition: all 0.2s ease; position: relative; display: flex; align-items: center; gap: 8px;
}
.kid-chip:hover { background: var(--danger); color: white; }
.kid-chip .delete-btn { 
    font-size: 16px; font-weight: 700; color: var(--danger); cursor: pointer;
    width: 20px; height: 20px; display: flex; align-items: center; justify-content: center;
    border-radius: 50%; background: rgba(239, 68, 68, 0.1); transition: all 0.2s ease;
}
.kid-chip:hover .delete-btn { color: white; background: rgba(255,255,255,0.2); }

/* Import Panel */
.import-panel { display: none; padding: 0 16px 20px; }
.import-panel.active { display: block; }

.file-input {
    width: 100%; padding: 12px; border: 2px dashed var(--border); border-radius: var(--radius);
    text-align: center; cursor: pointer; transition: all 0.2s ease;
}
.file-input:hover { border-color: var(--primary); background: var(--bg-secondary); }

/* Analytics Panel */
.analytics-panel { display: none; padding: 0 16px 20px; }
.analytics-panel.active { display: block; }

.stat-card {
    background: var(--bg-card); border-radius: var(--radius); padding: 16px; margin-bottom: 12px;
    box-shadow: var(--shadow-sm); border: 1px solid var(--border-light);
}
.stat-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 12px; }
.stat-title { font-size: 14px; font-weight: 600; color: var(--text-primary); }
.stat-value { font-size: 24px; font-weight: 700; color: var(--primary); }
.stat-change {
    font-size: 12px; font-weight: 600; padding: 4px 8px; border-radius: 12px;
}
.stat-change.positive { background: rgba(16, 185, 129, 0.1); color: var(--success); }
.stat-change.negative { background: rgba(239, 68, 68, 0.1); color: var(--danger); }

/* Bottom Navigation - FIXED */
.bottom-nav {
    position: fixed; bottom: 0; left: 50%; transform: translateX(-50%); width: 100%; max-width: 428px;
    background: var(--bg-card); border-top: 1px solid var(--border); padding: 8px 0 12px; display: flex; 
    justify-content: space-around; z-index: 1000; box-shadow: 0 -2px 8px rgba(0,0,0,0.1);
}
.nav-item {
    display: flex; flex-direction: column; align-items: center; padding: 6px 8px; cursor: pointer;
    transition: all 0.2s ease; border-radius: var(--radius-sm); flex: 1; text-align: center;
}
.nav-item.active { color: var(--primary); }
.nav-icon { font-size: 18px; margin-bottom: 2px; }
.nav-label { font-size: 9px; font-weight: 600; }

/* Toast */
.toast {
    position: fixed; bottom: 120px; left: 50%; transform: translateX(-50%); background: var(--text-primary); color: var(--bg-primary);
    padding: 12px 20px; border-radius: 25px; font-size: 14px; font-weight: 600; z-index: 1000; opacity: 0;
    pointer-events: none; transition: all 0.3s ease;
}
.toast.show { opacity: 1; }
.toast.success { background: var(--success); }
.toast.warning { background: var(--warning); }
.toast.danger { background: var(--danger); }

/* Action Banner */
.action-banner {
    background: linear-gradient(135deg, var(--primary), var(--secondary)); color: white; margin: 0 16px 16px;
    padding: 16px 20px; border-radius: var(--radius); text-align: center;
}
.action-banner.warning { background: linear-gradient(135deg, var(--warning), #d97706); }
.action-banner.danger { background: linear-gradient(135deg, var(--danger), var(--critical)); animation: urgent-pulse 1s infinite; }

.action-text { font-size: 16px; font-weight: 700; margin-bottom: 4px; }
.action-timer { font-size: 24px; font-weight: 900; font-variant-numeric: tabular-nums; }

/* Responsive - FIXED */
@media (max-width: 428px) {
    .app-container { max-width: 100%; margin: 0; }
    .bottom-nav { max-width: 100%; width: 100%; }
}
@media (max-width: 320px) {
    .header { padding: 16px 12px 12px; }
    .header h1 { font-size: 20px; }
    .schedule-section, .settings-panel, .kids-panel, .import-panel, .analytics-panel { padding: 0 12px 16px; }
    .time-widget { margin: 12px; padding: 16px; }
    .current-time { font-size: 24px; }
}
</style>
</head>

<body>
    <div class="app-container">
        <!-- Header -->
        <div class="header" id="header">
            <h1 id="headerTitle">üí§ Ultimate Sleep Tracker PRO</h1>
            <div class="subtitle" id="headerSubtitle">–ú–∞—Ä–∫—É—Å –∏ –í–∏–ª—å—è–º ‚Ä¢ 6 –º–µ—Å—è—Ü–µ–≤ ‚Ä¢ –õ—É—á—à–∏–π —Ç—Ä–µ–∫–µ—Ä —Å–Ω–∞</div>
        </div>

        <!-- Child Selection (2 children) -->
        <div class="child-selector" id="childSelector">
            <button class="child-btn active marcus" id="marcusBtn">üë∂ –ú–∞—Ä–∫—É—Å</button>
            <button class="child-btn william" id="williamBtn">üë∂ –í–∏–ª—å—è–º</button>
        </div>

        <!-- Multi Child Dropdown (3+ children) -->
        <div class="multi-child-selector" id="multiChildSelector" style="display: none;">
            <div class="selected-child" id="selectedChild">
                üë∂ –í—ã–±–µ—Ä–∏—Ç–µ —Ä–µ–±—ë–Ω–∫–∞ <span>‚ñº</span>
            </div>
            <div class="child-dropdown" id="childDropdown"></div>
        </div>

        <!-- PRO Controls -->
        <div class="pro-controls">
            <button class="pro-btn" id="autoWakeBtn">üîÑ –ê–≤—Ç–æ-–ø–æ–¥—ä—ë–º</button>
            <button class="pro-btn" id="cascadeBtn">‚¨áÔ∏è –ö–∞—Å–∫–∞–¥</button>
            <button class="pro-btn" id="ageRecsBtn">üìä –ü–æ –≤–æ–∑—Ä–∞—Å—Ç—É</button>
            <button class="pro-btn" id="smartBtn">üß† –£–º–Ω—ã–µ —Å–æ–≤–µ—Ç—ã</button>
            <button class="pro-btn" id="resetBtn">‚Ü©Ô∏è –°–±—Ä–æ—Å</button>
        </div>

        <!-- Current Time Widget -->
        <div class="time-widget">
            <div class="current-time" id="currentTime">15:18:30</div>
            <div class="time-label">–¢–µ–∫—É—â–µ–µ –≤—Ä–µ–º—è</div>
        </div>

        <!-- Current Action Banner -->
        <div class="action-banner" id="actionBanner">
            <div class="action-text" id="actionText">–î–Ω–µ–≤–Ω–æ–µ –±–æ–¥—Ä—Å—Ç–≤–æ–≤–∞–Ω–∏–µ</div>
            <div class="action-timer" id="actionTimer">–î–æ —Å–ª–µ–¥—É—é—â–µ–≥–æ —Å–Ω–∞: 1—á 23–º</div>
        </div>

        <!-- Schedule Section -->
        <div class="schedule-section" id="scheduleSection">
            <h2 class="section-title">üïê –†–∞—Å–ø–∏—Å–∞–Ω–∏–µ –¥–Ω—è</h2>

            <!-- Wakeup -->
            <div class="schedule-card wake">
                <div class="card-header">
                    <div class="activity-info">
                        <span class="activity-emoji">üåÖ</span>
                        <span class="activity-name">–ü–æ–¥—ä—ë–º</span>
                    </div>
                    <div class="time-inputs">
                        <input type="time" class="time-input" id="wakeup" value="07:30">
                    </div>
                </div>
                <div class="status-row">
                    <div class="status-badge status-success" id="statusWakeup">‚úÖ –û–ø—Ç–∏–º–∞–ª—å–Ω–æ</div>
                    <div class="timer-info" id="timerWakeup">–û–∫–Ω–æ: 07:00-08:00</div>
                </div>
                <div class="recommendation" id="recWakeup">
                    <div class="recommendation-text">–û—Ç–ª–∏—á–Ω–æ–µ –≤—Ä–µ–º—è –¥–ª—è –ø–æ–¥—ä—ë–º–∞! –ü–ª–∞–≤–Ω–æ–µ –ø—Ä–æ–±—É–∂–¥–µ–Ω–∏–µ —Å –º—è–≥–∫–∏–º —Å–≤–µ—Ç–æ–º.</div>
                </div>
                <div class="smart-rec" id="smartWakeup" style="display: none;">
                    <div class="smart-rec-title">üí° –£–º–Ω—ã–π —Å–æ–≤–µ—Ç</div>
                    <div class="smart-rec-text">–û—Å–Ω–æ–≤–∞–Ω–æ –Ω–∞ –∞–Ω–∞–ª–∏–∑–µ –ø–æ—Å–ª–µ–¥–Ω–∏—Ö 7 –¥–Ω–µ–π: –æ–ø—Ç–∏–º–∞–ª—å–Ω–æ–µ –≤—Ä–µ–º—è –ø–æ–¥—ä—ë–º–∞ 07:25 ¬±15–º–∏–Ω –¥–ª—è —Å—Ç–∞–±–∏–ª—å–Ω–æ–≥–æ —Ä–µ–∂–∏–º–∞.</div>
                </div>
            </div>

            <!-- Nap 1 -->
            <div class="schedule-card sleep" id="nap1Card">
                <div class="card-header">
                    <div class="activity-info">
                        <span class="activity-emoji">üò¥</span>
                        <span class="activity-name">–î—Ä–µ–º–∞ 1</span>
                    </div>
                    <div class="time-inputs">
                        <input type="time" class="time-input" id="nap1start" value="10:30">
                        <span>‚Äî</span>
                        <input type="time" class="time-input" id="nap1end" value="12:00">
                    </div>
                </div>
                <div class="card-content">
                    <div class="metric">
                        <div class="metric-label">–î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å</div>
                        <div class="metric-value" id="nap1Duration">1—á 30–º</div>
                    </div>
                    <div class="metric">
                        <div class="metric-label">–û–∫–Ω–æ –±–æ–¥—Ä—Å—Ç–≤–æ–≤–∞–Ω–∏—è</div>
                        <div class="metric-value" id="window1">3—á 00–º</div>
                    </div>
                </div>
                <div class="wake-window-bar">
                    <div class="wake-window-fill safe" id="wakeBar1" style="width: 85%;"></div>
                </div>
                <div id="windowAlert1"></div>
                <div class="status-row">
                    <div class="status-badge status-success" id="statusNap1">‚úÖ –ò–¥–µ–∞–ª—å–Ω–æ</div>
                    <div class="timer-info" id="timerNap1">–ú–æ–∂–Ω–æ —Å–ø–∞—Ç—å –¥–æ 12:15</div>
                </div>
                <div class="recommendation" id="recNap1">
                    <div class="recommendation-text">–û—Å–Ω–æ–≤–Ω–æ–π —É—Ç—Ä–µ–Ω–Ω–∏–π —Å–æ–Ω –≤ –Ω–æ—Ä–º–µ. –ü—Ä–∏–∑–Ω–∞–∫–∏ –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏: —Ç—Ä—ë—Ç –≥–ª–∞–∑–∫–∏, –∑–µ–≤–∞–µ—Ç, —Ç–µ—Ä—è–µ—Ç –∏–Ω—Ç–µ—Ä–µ—Å –∫ –∏–≥—Ä–∞–º.</div>
                </div>
                <div class="smart-rec" id="smartNap1" style="display: none;">
                    <div class="smart-rec-title">üéØ –û–ø—Ç–∏–º–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ</div>
                    <div class="smart-rec-text">–õ—É—á—à–µ–µ –≤—Ä–µ–º—è –¥–ª—è –∑–∞—Å—ã–ø–∞–Ω–∏—è: 10:20-10:40. –î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å —Å–Ω–∞: 1—á15–º-1—á45–º. –ü—Ä–∏ –∫–æ—Ä–æ—Ç–∫–æ–º —Å–Ω–µ –ø—Ä–æ–¥–ª–∏—Ç—å –ª—é–±—ã–º —Å–ø–æ—Å–æ–±–æ–º.</div>
                </div>
            </div>

            <!-- Nap 2 -->
            <div class="schedule-card sleep" id="nap2Card">
                <div class="card-header">
                    <div class="activity-info">
                        <span class="activity-emoji">üí§</span>
                        <span class="activity-name">–î—Ä–µ–º–∞ 2</span>
                    </div>
                    <div class="time-inputs">
                        <input type="time" class="time-input" id="nap2start" value="14:00">
                        <span>‚Äî</span>
                        <input type="time" class="time-input" id="nap2end" value="14:45">
                    </div>
                </div>
                <div class="card-content">
                    <div class="metric">
                        <div class="metric-label">–î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å</div>
                        <div class="metric-value" id="nap2Duration">45–º</div>
                    </div>
                    <div class="metric">
                        <div class="metric-label">–û–∫–Ω–æ –±–æ–¥—Ä—Å—Ç–≤–æ–≤–∞–Ω–∏—è</div>
                        <div class="metric-value" id="window2">2—á 00–º</div>
                    </div>
                </div>
                <div class="wake-window-bar">
                    <div class="wake-window-fill safe" id="wakeBar2" style="width: 75%;"></div>
                </div>
                <div id="windowAlert2"></div>
                <div class="status-row">
                    <div class="status-badge status-success" id="statusNap2">‚úÖ –•–æ—Ä–æ—à–æ</div>
                    <div class="timer-info" id="timerNap2">–ë—É–¥–∏—Ç—å —á–µ—Ä–µ–∑ 1 —á–∞—Å –º–∞–∫—Å–∏–º—É–º</div>
                </div>
                <div class="recommendation" id="recNap2">
                    <div class="recommendation-text">–ö–æ—Ä–æ—Ç–∫–∏–π –¥–Ω–µ–≤–Ω–æ–π —Å–æ–Ω. –ï—Å–ª–∏ —Å–ø–∏—Ç –º–µ–Ω—å—à–µ 30 –º–∏–Ω—É—Ç ‚Äî –ø—Ä–æ–¥–ª–∏—Ç—å –ø–æ–∫–∞—á–∏–≤–∞–Ω–∏–µ–º –∏–ª–∏ –∫–æ–Ω—Ç–∞–∫—Ç–Ω—ã–º —Å–Ω–æ–º.</div>
                </div>
                <div class="smart-rec" id="smartNap2" style="display: none;">
                    <div class="smart-rec-title">‚è∞ –¢–∞–π–º–∏–Ω–≥ –≤–∞–∂–µ–Ω</div>
                    <div class="smart-rec-text">–ò–¥–µ–∞–ª—å–Ω–æ–µ –≤—Ä–µ–º—è: 13:50-14:10. –ú–∞–∫—Å–∏–º—É–º 1 —á–∞—Å —Å–Ω–∞, –∏–Ω–∞—á–µ —Å–¥–≤–∏–Ω–µ—Ç—Å—è –≤–µ—á–µ—Ä–Ω–∏–π —Ä–µ–∂–∏–º. –ü—Ä–∏ –∫–∞–ø—Ä–∏–∑–∞—Ö ‚Äî –∫–æ—Ä–æ—Ç–∫–∞—è –ø—Ä–æ–≥—É–ª–∫–∞.</div>
                </div>
            </div>

            <!-- Nap 3 -->
            <div class="schedule-card critical" id="nap3Card">
                <div class="card-header">
                    <div class="activity-info">
                        <span class="activity-emoji">‚è∞</span>
                        <span class="activity-name">–î—Ä–µ–º–∞ 3 (–ö—Ä–∏—Ç–∏—á–Ω–æ!)</span>
                    </div>
                    <div class="time-inputs">
                        <input type="time" class="time-input" id="nap3start" value="17:00">
                        <span>‚Äî</span>
                        <input type="time" class="time-input" id="nap3end" value="18:15">
                    </div>
                </div>
                <div class="card-content">
                    <div class="metric">
                        <div class="metric-label">–î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å</div>
                        <div class="metric-value" id="nap3Duration">1—á 15–º</div>
                    </div>
                    <div class="metric">
                        <div class="metric-label">–î–æ –ª–∏–º–∏—Ç–∞</div>
                        <div class="metric-value" id="timeToLimit">–°–¢–†–û–ì–û –¥–æ 18:15!</div>
                    </div>
                </div>
                <div class="wake-window-bar">
                    <div class="wake-window-fill danger" id="wakeBar3" style="width: 95%;"></div>
                </div>
                <div id="windowAlert3"></div>
                <div class="status-row">
                    <div class="status-badge status-warning" id="statusNap3">‚ö†Ô∏è –ù–∞ –≥—Ä–∞–Ω–∏</div>
                    <div class="timer-info" id="timerNap3">–ë—É–¥–∏—Ç—å –û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û –≤ 18:15</div>
                </div>
                <div class="recommendation danger" id="recNap3">
                    <div class="recommendation-text">–ö–†–ò–¢–ò–ß–ù–û! –ü—Ä–µ–≤—ã—à–µ–Ω–∏–µ –ª–∏–º–∏—Ç–∞ 18:15 —Ä–∞–∑—Ä—É—à–∏—Ç –Ω–æ—á–Ω–æ–π —Å–æ–Ω. –°—Ç–∞–≤–∏—Ç—å –±—É–¥–∏–ª—å–Ω–∏–∫!</div>
                </div>
                <div class="smart-rec" id="smartNap3" style="display: none;">
                    <div class="smart-rec-title">üö® –°—Ç—Ä–∞—Ç–µ–≥–∏—è –ø—Ä–æ–±—É–∂–¥–µ–Ω–∏—è</div>
                    <div class="smart-rec-text">–ó–∞ 10 –º–∏–Ω: –æ—Ç–∫—Ä—ã—Ç—å —à—Ç–æ—Ä—ã. –ó–∞ 5 –º–∏–Ω: –º—è–≥–∫–∏–µ –ø—Ä–∏–∫–æ—Å–Ω–æ–≤–µ–Ω–∏—è. –í —Å—Ä–æ–∫: –ø–æ–¥—ä—ë–º. –ü–æ—Å–ª–µ: –∞–∫—Ç–∏–≤–Ω—ã–µ –∏–≥—Ä—ã, —Å–≤–µ—Ç, –æ–±—â–µ–Ω–∏–µ.</div>
                </div>
            </div>

            <!-- Bedtime -->
            <div class="schedule-card wake">
                <div class="card-header">
                    <div class="activity-info">
                        <span class="activity-emoji">üåô</span>
                        <span class="activity-name">–û—Ç–±–æ–π –Ω–∞ –Ω–æ—á—å</span>
                    </div>
                    <div class="time-inputs">
                        <span id="bedtimeCalc" style="font-size: 15px; font-weight: 600;">21:00</span>
                    </div>
                </div>
                <div class="card-content">
                    <div class="metric">
                        <div class="metric-label">–ù–æ—á–Ω–æ–π —Å–æ–Ω</div>
                        <div class="metric-value" id="nightDuration">10—á 30–º</div>
                    </div>
                    <div class="metric">
                        <div class="metric-label">–í–µ—á–µ—Ä–Ω–µ–µ –æ–∫–Ω–æ</div>
                        <div class="metric-value" id="eveningWindow">2—á 45–º</div>
                    </div>
                </div>
                <div class="status-row">
                    <div class="status-badge status-gold" id="statusBedtime">‚ú® –ó–æ–ª–æ—Ç–æ–µ –æ–∫–Ω–æ!</div>
                    <div class="timer-info" id="timerBedtime">–ò–¥–µ–∞–ª—å–Ω–æ–µ –≤—Ä–µ–º—è: 20:30-21:30</div>
                </div>
                <div class="recommendation" id="recBedtime">
                    <div class="recommendation-text">–ó–æ–ª–æ—Ç–æ–µ –æ–∫–Ω–æ –¥–ª—è –æ—Ç–±–æ—è! –†–∏—Ç—É–∞–ª: –∫—É–ø–∞–Ω–∏–µ (19:30) ‚Üí –º–∞—Å—Å–∞–∂ ‚Üí –∫–æ—Ä–º–ª–µ–Ω–∏–µ ‚Üí –∫–æ–ª—ã–±–µ–ª—å–Ω–∞—è ‚Üí –≤ –∫—Ä–æ–≤–∞—Ç–∫—É.</div>
                </div>
                <div class="smart-rec" id="smartBedtime" style="display: none;">
                    <div class="smart-rec-title">üõÅ –ò–¥–µ–∞–ª—å–Ω—ã–π –≤–µ—á–µ—Ä–Ω–∏–π —Ä–∏—Ç—É–∞–ª</div>
                    <div class="smart-rec-text">19:30 –∫—É–ø–∞–Ω–∏–µ ‚Üí 19:45 –º–∞—Å—Å–∞–∂/–∫—Ä–µ–º ‚Üí 20:00 –ø–∏–∂–∞–º–∞ ‚Üí 20:15 –∫–æ—Ä–º–ª–µ–Ω–∏–µ ‚Üí 20:45 –∫–æ–ª—ã–±–µ–ª—å–Ω–∞—è ‚Üí 21:00 –≤ –∫—Ä–æ–≤–∞—Ç–∫—É —Å –±–µ–ª—ã–º —à—É–º–æ–º.</div>
                </div>
            </div>
        </div>

        <!-- Settings Panel -->
        <div class="settings-panel" id="settingsPanel">
            <h2 class="settings-title">‚öôÔ∏è PRO –ù–∞—Å—Ç—Ä–æ–π–∫–∏</h2>

            <div class="setting-item">
                <div class="setting-header">
                    <div class="setting-label">–ê–≤—Ç–æ–∫–æ—Ä—Ä–µ–∫—Ü–∏—è –ø–æ–¥—ä—ë–º–∞ –æ—Ç –æ—Ç–±–æ—è</div>
                    <label class="toggle">
                        <input type="checkbox" id="autoWakeToggle">
                        <span class="slider"></span>
                    </label>
                </div>
                <div class="setting-description">
                    –ü–æ–¥—ä—ë–º –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä—É–µ—Ç—Å—è: –≤—Ä–µ–º—è –æ—Ç–±–æ—è + —Ü–µ–ª–µ–≤–∞—è –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –Ω–æ—á–∏ (–≤ —Ä–∞–º–∫–∞—Ö –æ–∫–Ω–∞ 07:00-08:00)
                </div>
            </div>

            <div class="setting-item">
                <div class="setting-header">
                    <div class="setting-label">–ö–∞—Å–∫–∞–¥–Ω–∞—è –∫–æ—Ä—Ä–µ–∫—Ü–∏—è –≤—Ä–µ–º–µ–Ω–∏</div>
                    <label class="toggle">
                        <input type="checkbox" id="cascadeToggle">
                        <span class="slider"></span>
                    </label>
                </div>
                <div class="setting-description">
                    –ò–∑–º–µ–Ω–µ–Ω–∏–µ –ª—é–±–æ–≥–æ –≤—Ä–µ–º–µ–Ω–∏ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä—É–µ—Ç –ø–æ—Å–ª–µ–¥—É—é—â–∏–µ –∑–Ω–∞—á–µ–Ω–∏—è –≤ –ø—Ä–µ–¥–µ–ª–∞—Ö –¥–æ–ø—É—Å–∫–æ–≤ (¬±15 –º–∏–Ω)
                </div>
            </div>

            <div class="setting-item">
                <div class="setting-header">
                    <div class="setting-label">–£–º–Ω–∞—è –∫–æ—Ä—Ä–µ–∫—Ü–∏—è –æ–∫–æ–Ω—á–∞–Ω–∏–π –¥—Ä–µ–º</div>
                    <label class="toggle">
                        <input type="checkbox" id="smartEndToggle" checked>
                        <span class="slider"></span>
                    </label>
                </div>
                <div class="setting-description">
                    –ü—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ –Ω–∞—á–∞–ª–∞ –¥—Ä–µ–º—ã –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä—É–µ—Ç—Å—è –µ—ë –æ–∫–æ–Ω—á–∞–Ω–∏–µ —Å —É—á—ë—Ç–æ–º –æ–ø—Ç–∏–º–∞–ª—å–Ω–æ–π –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
                </div>
            </div>

            <div class="setting-item">
                <div class="setting-header">
                    <div class="setting-label">–ö–æ–Ω—Ç—Ä–æ–ª—å –æ–∫–æ–Ω –±–æ–¥—Ä—Å—Ç–≤–æ–≤–∞–Ω–∏—è</div>
                    <label class="toggle">
                        <input type="checkbox" id="windowControlToggle" checked>
                        <span class="slider"></span>
                    </label>
                </div>
                <div class="setting-description">
                    –ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è –æ –ø—Ä–µ–≤—ã—à–µ–Ω–∏–∏ –º–∞–∫—Å–∏–º–∞–ª—å–Ω—ã—Ö –æ–∫–æ–Ω –±–æ–¥—Ä—Å—Ç–≤–æ–≤–∞–Ω–∏—è (3—á30–º ‚Üí 2—á30–º ‚Üí 3—á ‚Üí –≤–µ—á–µ—Ä 3—á30–º)
                </div>
            </div>

            <div class="setting-item">
                <div class="setting-header">
                    <div class="setting-label">–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ –≤–æ–∑—Ä–∞—Å—Ç—É</div>
                    <select id="ageRecMode" class="form-input">
                        <option value="off">–í—ã–∫–ª—é—á–µ–Ω–æ</option>
                        <option value="brackets">–ü–æ–∫–∞–∑—ã–≤–∞—Ç—å –≤ —Å–∫–æ–±–∫–∞—Ö</option>
                        <option value="replace">–ó–∞–º–µ–Ω–∏—Ç—å —Ç–µ–∫—É—â–∏–µ –∑–Ω–∞—á–µ–Ω–∏—è</option>
                    </select>
                </div>
                <div class="setting-description">
                    –ü–æ–∫–∞–∑—ã–≤–∞—Ç—å –∏–ª–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –≤–æ–∑—Ä–∞—Å—Ç–Ω—ã–µ –Ω–æ—Ä–º—ã –¥–ª—è –æ–∫–æ–Ω –±–æ–¥—Ä—Å—Ç–≤–æ–≤–∞–Ω–∏—è –∏ –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ —Å–Ω–æ–≤
                </div>
            </div>

            <div class="setting-item">
                <div class="setting-header">
                    <div class="setting-label">–£–º–Ω—ã–µ —Å–æ–≤–µ—Ç—ã –∏ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏</div>
                    <label class="toggle">
                        <input type="checkbox" id="smartRecsToggle">
                        <span class="slider"></span>
                    </label>
                </div>
                <div class="setting-description">
                    –ü–æ–∫–∞–∑—ã–≤–∞—Ç—å –ø–µ—Ä—Å–æ–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ —Å–æ–≤–µ—Ç—ã –Ω–∞ –æ—Å–Ω–æ–≤–µ —Ç–µ–∫—É—â–µ–≥–æ –≤—Ä–µ–º–µ–Ω–∏ –∏ —Ä–µ–∂–∏–º–∞ —Ä–µ–±—ë–Ω–∫–∞
                </div>
            </div>

            <div class="setting-item">
                <div class="setting-header">
                    <div class="setting-label">–¶–µ–ª–µ–≤–∞—è –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –Ω–æ—á–∏</div>
                    <select id="nightTarget" class="form-input">
                        <option value="600">10—á 00–º</option>
                        <option value="630" selected>10—á 30–º</option>
                        <option value="660">11—á 00–º</option>
                        <option value="690">11—á 30–º</option>
                    </select>
                </div>
                <div class="setting-description">
                    –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è –∞–≤—Ç–æ–∫–æ—Ä—Ä–µ–∫—Ü–∏–∏ –≤—Ä–µ–º–µ–Ω–∏ –ø–æ–¥—ä—ë–º–∞ (–æ—Ç–±–æ–π + –≤—ã–±—Ä–∞–Ω–Ω–∞—è –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å)
                </div>
            </div>
        </div>

        <!-- Kids Panel -->
        <div class="kids-panel" id="kidsPanel">
            <h2 class="settings-title">üë™ –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –¥–µ—Ç—å–º–∏</h2>

            <div class="add-kid-form">
                <div class="form-row">
                    <input type="text" class="form-input" id="kidName" placeholder="–ò–º—è —Ä–µ–±—ë–Ω–∫–∞">
                    <input type="date" class="form-input" id="kidDob">
                    <button class="add-btn" id="addKidBtn">–î–æ–±–∞–≤–∏—Ç—å</button>
                </div>
                <div class="setting-description">
                    –í–æ–∑—Ä–∞—Å—Ç —Ä–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏. –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä—É—é—Ç—Å—è –ø–æ –≤–æ–∑—Ä–∞—Å—Ç—É. –î–ª—è —É–¥–∞–ª–µ–Ω–∏—è –Ω–∞–∂–º–∏—Ç–µ –Ω–∞ –∫—Ä–∞—Å–Ω—ã–π –∫—Ä–µ—Å—Ç–∏–∫.
                </div>
            </div>

            <div class="kids-list" id="kidsList"></div>
        </div>

        <!-- Import Panel -->
        <div class="import-panel" id="importPanel">
            <h2 class="settings-title">üì• –ò–º–ø–æ—Ä—Ç –¥–∞–Ω–Ω—ã—Ö —Å–Ω–∞</h2>

            <div class="setting-item">
                <input type="file" id="fileInput" accept=".csv,.json" class="file-input">
                <div class="setting-description" style="margin-top: 12px;">
                    –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º—ã–µ —Ñ–æ—Ä–º–∞—Ç—ã: CSV (date,start,end,type) –∏–ª–∏ JSON –º–∞—Å—Å–∏–≤ –∑–∞–ø–∏—Å–µ–π. 
                    –°—Ä–µ–¥–Ω–∏–µ –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ –∏ –æ–∫–Ω–∞ –±—É–¥—É—Ç —Ä–∞—Å—Å—á–∏—Ç–∞–Ω—ã –∏ –ø—Ä–∏–º–µ–Ω–µ–Ω—ã –∫–∞–∫ –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏.
                </div>
            </div>

            <div class="setting-item">
                <div class="setting-header">
                    <div class="setting-label">–≠–∫—Å–ø–æ—Ä—Ç –¥–∞–Ω–Ω—ã—Ö</div>
                    <button class="add-btn" id="exportBtn">–°–∫–∞—á–∞—Ç—å CSV</button>
                </div>
                <div class="setting-description">
                    –≠–∫—Å–ø–æ—Ä—Ç –≤—Å–µ—Ö –¥–∞–Ω–Ω—ã—Ö —Å–Ω–∞ –≤ —Ñ–æ—Ä–º–∞—Ç–µ CSV –¥–ª—è —Ä–µ–∑–µ—Ä–≤–Ω–æ–≥–æ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è –∏–ª–∏ –∞–Ω–∞–ª–∏–∑–∞ –≤ –¥—Ä—É–≥–∏—Ö –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è—Ö
                </div>
            </div>
        </div>

        <!-- Analytics Panel -->
        <div class="analytics-panel" id="analyticsPanel">
            <h2 class="settings-title">üìä –ê–Ω–∞–ª–∏—Ç–∏–∫–∞ —Å–Ω–∞</h2>

            <div class="stat-card">
                <div class="stat-header">
                    <div class="stat-title">–°—Ä–µ–¥–Ω–µ–µ –≤—Ä–µ–º—è –ø–æ–¥—ä—ë–º–∞</div>
                    <div class="stat-change positive" id="wakeupTrend">+5 –º–∏–Ω</div>
                </div>
                <div class="stat-value" id="avgWakeup">07:32</div>
                <div class="setting-description">–ó–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–µ 7 –¥–Ω–µ–π –≤ —Å—Ä–∞–≤–Ω–µ–Ω–∏–∏ —Å –ø—Ä–µ–¥—ã–¥—É—â–µ–π –Ω–µ–¥–µ–ª–µ–π</div>
            </div>

            <div class="stat-card">
                <div class="stat-header">
                    <div class="stat-title">–û–±—â–∏–π –¥–Ω–µ–≤–Ω–æ–π —Å–æ–Ω</div>
                    <div class="stat-change positive" id="daySleepTrend">+23 –º–∏–Ω</div>
                </div>
                <div class="stat-value" id="avgDaySleep">3—á 42–º</div>
                <div class="setting-description">–°—É–º–º–∞ –≤—Å–µ—Ö –¥—Ä–µ–º –≤ —Å—Ä–µ–¥–Ω–µ–º –∑–∞ –Ω–µ–¥–µ–ª—é</div>
            </div>

            <div class="stat-card">
                <div class="stat-header">
                    <div class="stat-title">–ù–æ—á–Ω–æ–π —Å–æ–Ω</div>
                    <div class="stat-change negative" id="nightSleepTrend">-12 –º–∏–Ω</div>
                </div>
                <div class="stat-value" id="avgNightSleep">10—á 18–º</div>
                <div class="setting-description">–û—Ç –æ—Ç–±–æ—è –¥–æ –ø–æ–¥—ä—ë–º–∞ —Å —É—á—ë—Ç–æ–º –ø—Ä–æ–±—É–∂–¥–µ–Ω–∏–π</div>
            </div>

            <div class="stat-card">
                <div class="stat-header">
                    <div class="stat-title">–°—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç—å —Ä–µ–∂–∏–º–∞</div>
                    <div class="stat-change positive" id="stabilityTrend">+8%</div>
                </div>
                <div class="stat-value" id="stabilityScore">87%</div>
                <div class="setting-description">–ü—Ä–æ—Ü–µ–Ω—Ç —Å–æ–±–ª—é–¥–µ–Ω–∏—è —Ä–µ–∫–æ–º–µ–Ω–¥–æ–≤–∞–Ω–Ω—ã—Ö –æ–∫–æ–Ω –±–æ–¥—Ä—Å—Ç–≤–æ–≤–∞–Ω–∏—è</div>
            </div>
        </div>

        <!-- Toast -->
        <div class="toast" id="toast"></div>

        <!-- Bottom Navigation - FIXED POSITION -->
        <div class="bottom-nav">
            <div class="nav-item active" id="navSchedule">
                <div class="nav-icon">üè†</div>
                <div class="nav-label">–†–µ–∂–∏–º</div>
            </div>
            <div class="nav-item" id="navAnalytics">
                <div class="nav-icon">üìä</div>
                <div class="nav-label">–ê–Ω–∞–ª–∏—Ç–∏–∫–∞</div>
            </div>
            <div class="nav-item" id="navSettings">
                <div class="nav-icon">‚öôÔ∏è</div>
                <div class="nav-label">–ù–∞—Å—Ç—Ä–æ–π–∫–∏</div>
            </div>
            <div class="nav-item" id="navKids">
                <div class="nav-icon">üë™</div>
                <div class="nav-label">–î–µ—Ç–∏</div>
            </div>
            <div class="nav-item" id="navImport">
                <div class="nav-icon">üì•</div>
                <div class="nav-label">–î–∞–Ω–Ω—ã–µ</div>
            </div>
        </div>
    </div>

<script>
// ================== GLOBAL STATE ==================
let currentChild = 'marcus';
let scheduleData = {
    marcus: {
        wakeup: '07:20', nap1start: '10:20', nap1end: '11:50', nap2start: '13:50', nap2end: '14:35', nap3start: '16:50', nap3end: '18:05'
    },
    william: {
        wakeup: '07:40', nap1start: '10:40', nap1end: '12:10', nap2start: '14:10', nap2end: '14:55', nap3start: '17:10', nap3end: '18:15'
    }
};

let proSettings = {
    autoWake: false, cascade: false, smartEnd: true, windowControl: true, ageRecMode: 'off', smartRecs: false, nightTarget: 630
};

let kidsData = [
    {id: 'marcus', name: '–ú–∞—Ä–∫—É—Å', dob: '2025-03-09'},
    {id: 'william', name: '–í–∏–ª—å—è–º', dob: '2025-03-09'}
];

// ================== UTILITY FUNCTIONS ==================
const timeToMinutes = (timeString) => {
    if (!timeString) return 0;
    const [hours, minutes] = timeString.split(':').map(Number);
    return hours * 60 + minutes;
};

const minutesToTime = (minutes) => {
    minutes = (minutes + 1440) % 1440; // Handle negative values
    const hours = Math.floor(minutes / 60);
    const mins = minutes % 60;
    return String(hours).padStart(2, '0') + ':' + String(mins).padStart(2, '0');
};

const calculateDuration = (startMinutes, endMinutes) => {
    let duration = endMinutes - startMinutes;
    if (duration < 0) duration += 24 * 60;
    return duration;
};

const formatDuration = (totalMinutes) => {
    const hours = Math.floor(totalMinutes / 60);
    const minutes = totalMinutes % 60;
    if (hours > 0) return hours + '—á ' + (minutes > 0 ? minutes + '–º' : '');
    return minutes + '–º';
};

const getCurrentTime = () => {
    const now = new Date();
    return now.getHours() * 60 + now.getMinutes();
};

const updateCurrentTime = () => {
    const now = new Date();
    const timeStr = now.getHours().toString().padStart(2, '0') + ':' + 
                   now.getMinutes().toString().padStart(2, '0') + ':' + 
                   now.getSeconds().toString().padStart(2, '0');
    document.getElementById('currentTime').textContent = timeStr;
};

// ================== STORAGE ==================
const saveData = () => {
    try {
        localStorage.setItem('ultimateSleepTrackerData', JSON.stringify({
            scheduleData, proSettings, kidsData, currentChild
        }));
    } catch (error) {
        console.error('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è:', error);
    }
};

const loadData = () => {
    try {
        const saved = localStorage.getItem('ultimateSleepTrackerData');
        if (saved) {
            const data = JSON.parse(saved);
            scheduleData = data.scheduleData || scheduleData;
            proSettings = data.proSettings || proSettings;
            kidsData = data.kidsData || kidsData;
            currentChild = data.currentChild || currentChild;
        }
    } catch (error) {
        console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏:', error);
    }
};

// ================== CHILD MANAGEMENT ==================
const updateChildSelector = () => {
    const childSelector = document.getElementById('childSelector');
    const multiChildSelector = document.getElementById('multiChildSelector');

    if (kidsData.length <= 2) {
        childSelector.style.display = 'flex';
        multiChildSelector.style.display = 'none';

        childSelector.innerHTML = '';
        kidsData.forEach(kid => {
            const btn = document.createElement('button');
            btn.className = `child-btn ${currentChild === kid.id ? 'active' : ''} ${kid.id}`;
            btn.innerHTML = `üë∂ ${kid.name}`;
            btn.onclick = () => selectChild(kid.id);
            childSelector.appendChild(btn);
        });
    } else {
        childSelector.style.display = 'none';
        multiChildSelector.style.display = 'block';

        const selectedChild = document.getElementById('selectedChild');
        const currentKid = kidsData.find(k => k.id === currentChild);
        selectedChild.innerHTML = `üë∂ ${currentKid ? currentKid.name : '–í—ã–±–µ—Ä–∏—Ç–µ —Ä–µ–±—ë–Ω–∫–∞'} <span>‚ñº</span>`;

        selectedChild.onclick = () => {
            const dropdown = document.getElementById('childDropdown');
            dropdown.classList.toggle('show');
        };

        const dropdown = document.getElementById('childDropdown');
        dropdown.innerHTML = '';
        kidsData.forEach(kid => {
            const option = document.createElement('div');
            option.className = 'child-option';
            option.innerHTML = `üë∂ ${kid.name} (${getAgeInMonths(kid.dob)} –º–µ—Å)`;
            option.onclick = () => {
                selectChild(kid.id);
                dropdown.classList.remove('show');
            };
            dropdown.appendChild(option);
        });
    }
};

const selectChild = (childId) => {
    currentChild = childId;

    const header = document.getElementById('header');
    const headerTitle = document.getElementById('headerTitle');
    const headerSubtitle = document.getElementById('headerSubtitle');

    const kid = kidsData.find(k => k.id === childId);
    if (kid) {
        if (childId === 'marcus') {
            header.className = 'header marcus';
            headerTitle.textContent = 'üí§ Ultimate Sleep Tracker PRO - –ú–∞—Ä–∫—É—Å';
        } else if (childId === 'william') {
            header.className = 'header william';
            headerTitle.textContent = 'üí§ Ultimate Sleep Tracker PRO - –í–∏–ª—å—è–º';
        } else {
            header.className = 'header';
            headerTitle.textContent = `üí§ Ultimate Sleep Tracker PRO - ${kid.name}`;
        }
        headerSubtitle.textContent = `${kid.name} ‚Ä¢ ${getAgeInMonths(kid.dob)} –º–µ—Å ‚Ä¢ –õ—É—á—à–∏–π —Ç—Ä–µ–∫–µ—Ä —Å–Ω–∞`;
    }

    updateChildSelector();
    loadChildData();
    calculate();
    saveData();
    showToast(`–ü–µ—Ä–µ–∫–ª—é—á–∏–ª–∏—Å—å –Ω–∞ ${kid.name}`, 'success');
};

const loadChildData = () => {
    const data = scheduleData[currentChild];
    if (data) {
        ['wakeup', 'nap1start', 'nap1end', 'nap2start', 'nap2end', 'nap3start', 'nap3end'].forEach(field => {
            const element = document.getElementById(field);
            if (element) {
                element.value = data[field];
            }
        });
    }
};

// ================== WAKE WINDOW CONTROL ==================
const checkWakeWindowLimits = () => {
    if (!proSettings.windowControl) return;

    const data = scheduleData[currentChild];
    const kid = kidsData.find(k => k.id === currentChild);
    const ageMonths = getAgeInMonths(kid.dob);

    // Age-based maximum wake windows (in minutes)
    const maxWindows = {
        1: ageMonths <= 4 ? 180 : ageMonths <= 6 ? 210 : 240,  // 3h ‚Üí 3h30m ‚Üí 4h
        2: ageMonths <= 4 ? 120 : ageMonths <= 6 ? 150 : 180,  // 2h ‚Üí 2h30m ‚Üí 3h
        3: ageMonths <= 4 ? 135 : ageMonths <= 6 ? 165 : 195   // 2h15m ‚Üí 2h45m ‚Üí 3h15m
    };

    const windows = [
        calculateDuration(timeToMinutes(data.wakeup), timeToMinutes(data.nap1start)),
        calculateDuration(timeToMinutes(data.nap1end), timeToMinutes(data.nap2start)),
        calculateDuration(timeToMinutes(data.nap2end), timeToMinutes(data.nap3start))
    ];

    windows.forEach((window, index) => {
        const napNum = index + 1;
        const alertDiv = document.getElementById(`windowAlert${napNum}`);
        const cardElement = document.getElementById(`nap${napNum}Card`);

        if (window > maxWindows[napNum]) {
            // Show critical window alert
            alertDiv.innerHTML = `<div class="window-alert">üö® –ö–†–ò–¢–ò–ß–ù–û! –û–∫–Ω–æ –±–æ–¥—Ä—Å—Ç–≤–æ–≤–∞–Ω–∏—è ${formatDuration(window)} –ø—Ä–µ–≤—ã—à–∞–µ—Ç –º–∞–∫—Å–∏–º—É–º ${formatDuration(maxWindows[napNum])} –¥–ª—è –≤–æ–∑—Ä–∞—Å—Ç–∞ ${ageMonths} –º–µ—Å. –†–∏—Å–∫ –ø–µ—Ä–µ—É—Ç–æ–º–ª–µ–Ω–∏—è!</div>`;
            cardElement.classList.add('danger-window');
        } else if (window > maxWindows[napNum] * 0.9) {
            // Show warning
            alertDiv.innerHTML = `<div class="window-alert warning">‚ö†Ô∏è –û–∫–Ω–æ –±–æ–¥—Ä—Å—Ç–≤–æ–≤–∞–Ω–∏—è ${formatDuration(window)} –±–ª–∏–∑–∫–æ –∫ –º–∞–∫—Å–∏–º—É–º—É ${formatDuration(maxWindows[napNum])}. –°–ª–µ–¥–∏—Ç–µ –∑–∞ –ø—Ä–∏–∑–Ω–∞–∫–∞–º–∏ —É—Å—Ç–∞–ª–æ—Å—Ç–∏.</div>`;
            cardElement.classList.remove('danger-window');
        } else {
            // Clear alerts
            alertDiv.innerHTML = '';
            cardElement.classList.remove('danger-window');
        }
    });
};

// ================== SMART NAP END CORRECTION ==================
const correctNapEnd = (napNumber, startTime) => {
    if (!proSettings.smartEnd) return;

    const startMin = timeToMinutes(startTime);
    const kid = kidsData.find(k => k.id === currentChild);
    const ageMonths = getAgeInMonths(kid.dob);

    // Age-based optimal durations
    let optimalDuration;
    if (napNumber === 1) {
        optimalDuration = ageMonths <= 4 ? 90 : ageMonths <= 6 ? 90 : 75;
    } else if (napNumber === 2) {
        optimalDuration = 45;
    } else if (napNumber === 3) {
        optimalDuration = ageMonths <= 6 ? 75 : 60;
    }

    let endMin = startMin + optimalDuration;

    // Special limit for nap 3
    if (napNumber === 3) {
        endMin = Math.min(endMin, timeToMinutes('18:15'));
    }

    const endField = `nap${napNumber}end`;
    const newEndTime = minutesToTime(endMin);
    const endElement = document.getElementById(endField);
    if (endElement) {
        endElement.value = newEndTime;
        scheduleData[currentChild][endField] = newEndTime;
    }
};

// ================== CASCADE LOGIC ==================
const applyCascade = (changedField) => {
    if (!proSettings.cascade) return;

    const data = scheduleData[currentChild];
    const idealWindows = {1: 180, 2: 120, 3: 135};
    const idealDurations = {1: 90, 2: 45, 3: 75};
    const tolerance = 15;

    const clamp = (value, target, tol = tolerance) => Math.max(target - tol, Math.min(target + tol, value));

    if (changedField === 'wakeup') {
        const wakeupMin = timeToMinutes(data.wakeup);

        const n1Start = wakeupMin + clamp(idealWindows[1], idealWindows[1]);
        const n1End = n1Start + clamp(idealDurations[1], idealDurations[1]);
        const n2Start = n1End + clamp(idealWindows[2], idealWindows[2]);
        const n2End = n2Start + clamp(idealDurations[2], idealDurations[2]);
        const n3Start = n2End + clamp(idealWindows[3], idealWindows[3]);
        const n3End = Math.min(n3Start + clamp(idealDurations[3], idealDurations[3]), timeToMinutes('18:15'));

        data.nap1start = minutesToTime(n1Start);
        data.nap1end = minutesToTime(n1End);
        data.nap2start = minutesToTime(n2Start);
        data.nap2end = minutesToTime(n2End);
        data.nap3start = minutesToTime(n3Start);
        data.nap3end = minutesToTime(n3End);

        loadChildData();
    }

    if (changedField.includes('nap1')) {
        const n1End = timeToMinutes(data.nap1end);
        const n2Start = n1End + clamp(idealWindows[2], idealWindows[2]);
        const n2End = n2Start + clamp(idealDurations[2], idealDurations[2]);
        const n3Start = n2End + clamp(idealWindows[3], idealWindows[3]);
        const n3End = Math.min(n3Start + clamp(idealDurations[3], idealDurations[3]), timeToMinutes('18:15'));

        data.nap2start = minutesToTime(n2Start);
        data.nap2end = minutesToTime(n2End);
        data.nap3start = minutesToTime(n3Start);
        data.nap3end = minutesToTime(n3End);

        loadChildData();
    }

    if (changedField.includes('nap2')) {
        const n2End = timeToMinutes(data.nap2end);
        const n3Start = n2End + clamp(idealWindows[3], idealWindows[3]);
        const n3End = Math.min(n3Start + clamp(idealDurations[3], idealDurations[3]), timeToMinutes('18:15'));

        data.nap3start = minutesToTime(n3Start);
        data.nap3end = minutesToTime(n3End);

        loadChildData();
    }
};

// ================== AUTO WAKE CORRECTION ==================
const applyAutoWake = () => {
    if (!proSettings.autoWake) return;

    const data = scheduleData[currentChild];
    const nap3EndMin = timeToMinutes(data.nap3end);
    const eveningWindow = 165; // 2h45m
    const bedtimeMin = (nap3EndMin + eveningWindow) % (24 * 60);

    let newWakeupMin = (bedtimeMin + proSettings.nightTarget) % (24 * 60);

    // Keep within bounds (06:50-08:10)
    const minWake = timeToMinutes('06:50');
    const maxWake = timeToMinutes('08:10');

    if (newWakeupMin < minWake) newWakeupMin = minWake;
    if (newWakeupMin > maxWake) newWakeupMin = maxWake;

    data.wakeup = minutesToTime(newWakeupMin);
    const wakeupElement = document.getElementById('wakeup');
    if (wakeupElement) {
        wakeupElement.value = data.wakeup;
    }
};

// ================== AGE CALCULATIONS ==================
const getAgeInMonths = (dobString) => {
    const dob = new Date(dobString);
    const now = new Date();
    const months = (now.getFullYear() - dob.getFullYear()) * 12 + (now.getMonth() - dob.getMonth());
    return Math.max(0, months);
};

const getAgeRecommendations = (ageMonths) => {
    if (ageMonths <= 4) {
        return {window1: 150, nap1: 90, window2: 120, nap2: 45, window3: 135, nap3: 75, nightSleep: 630};
    } else if (ageMonths <= 6) {
        return {window1: 180, nap1: 90, window2: 120, nap2: 45, window3: 135, nap3: 75, nightSleep: 630};
    } else if (ageMonths <= 8) {
        return {window1: 195, nap1: 75, window2: 135, nap2: 45, window3: 150, nap3: 60, nightSleep: 600};
    } else {
        return {window1: 210, nap1: 75, window2: 150, nap2: 45, window3: 180, nap3: 45, nightSleep: 600};
    }
};

// ================== WAKE WINDOW BAR UPDATE ==================
const updateWakeWindowBar = (napNumber, windowDuration) => {
    const barId = `wakeBar${napNumber}`;
    const bar = document.getElementById(barId);
    if (!bar) return;

    const kid = kidsData.find(k => k.id === currentChild);
    const ageRecs = getAgeRecommendations(getAgeInMonths(kid.dob));
    const optimal = ageRecs[`window${napNumber}`];

    const percentage = Math.min(100, (windowDuration / optimal) * 100);
    let className, width;

    if (percentage <= 80) {
        className = 'wake-window-fill safe';
        width = percentage;
    } else if (percentage <= 110) {
        className = 'wake-window-fill warning';  
        width = percentage;
    } else {
        className = 'wake-window-fill danger';
        width = Math.min(100, percentage);
    }

    bar.className = className;
    bar.style.width = width + '%';
};

// ================== SMART RECOMMENDATIONS ==================
const updateSmartRecommendations = () => {
    const smartElements = ['smartWakeup', 'smartNap1', 'smartNap2', 'smartNap3', 'smartBedtime'];

    if (!proSettings.smartRecs) {
        smartElements.forEach(id => {
            const element = document.getElementById(id);
            if (element) element.style.display = 'none';
        });
        return;
    }

    smartElements.forEach(id => {
        const element = document.getElementById(id);
        if (element) element.style.display = 'block';
    });

    // Context-aware recommendations could be added here
};

// ================== ENHANCED RECOMMENDATIONS ==================
const updateEnhancedRecommendations = (field, status) => {
    const recommendations = {
        wakeup: {
            success: "–û—Ç–ª–∏—á–Ω–æ–µ –≤—Ä–µ–º—è –¥–ª—è –ø–æ–¥—ä—ë–º–∞! –ü–ª–∞–≤–Ω–æ–µ –ø—Ä–æ–±—É–∂–¥–µ–Ω–∏–µ —Å –º—è–≥–∫–∏–º —Å–≤–µ—Ç–æ–º, –∫–æ—Ä–º–ª–µ–Ω–∏–µ —á–µ—Ä–µ–∑ 15-20 –º–∏–Ω—É—Ç.",
            warning: "–†–∞–Ω–æ–≤–∞—Ç–æ –∏–ª–∏ –ø–æ–∑–¥–Ω–æ–≤–∞—Ç–æ. –û–ø—Ç–∏–º–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ 07:00-08:00. –ü–æ—Å—Ç–µ–ø–µ–Ω–Ω–æ —Å–¥–≤–∏–≥–∞–π—Ç–µ —Ä–µ–∂–∏–º –ø–æ 10-15 –º–∏–Ω—É—Ç –≤ –¥–µ–Ω—å.",
            danger: "–ö—Ä–∏—Ç–∏—á–µ—Å–∫–æ–µ –≤—Ä–µ–º—è! –≠—Ç–æ –º–æ–∂–µ—Ç –Ω–∞—Ä—É—à–∏—Ç—å –≤–µ—Å—å —Ä–µ–∂–∏–º –¥–Ω—è. –°—Ä–æ—á–Ω–∞—è –∫–æ—Ä—Ä–µ–∫—Ü–∏—è –Ω–µ–æ–±—Ö–æ–¥–∏–º–∞."
        },
        nap1: {
            success: "–û—Å–Ω–æ–≤–Ω–æ–π —É—Ç—Ä–µ–Ω–Ω–∏–π —Å–æ–Ω –≤ –Ω–æ—Ä–º–µ. –ü—Ä–∏–∑–Ω–∞–∫–∏ –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏: —Ç—Ä—ë—Ç –≥–ª–∞–∑–∫–∏, –∑–µ–≤–∞–µ—Ç, —Ç–µ—Ä—è–µ—Ç –∏–Ω—Ç–µ—Ä–µ—Å –∫ –∏–≥—Ä–∞–º. –¢—ë–º–Ω–∞—è –∫–æ–º–Ω–∞—Ç–∞, –±–µ–ª—ã–π —à—É–º.",
            warning: "–û–∫–Ω–æ –±–æ–¥—Ä—Å—Ç–≤–æ–≤–∞–Ω–∏—è –Ω–µ –æ–ø—Ç–∏–º–∞–ª—å–Ω–æ. –°–ª–∏—à–∫–æ–º –∫–æ—Ä–æ—Ç–∫–æ–µ - —Ä–µ–±—ë–Ω–æ–∫ –Ω–µ —É—Å—Ç–∞–Ω–µ—Ç, —Å–ª–∏—à–∫–æ–º –¥–ª–∏–Ω–Ω–æ–µ - –ø–µ—Ä–µ—É—Ç–æ–º–∏—Ç—Å—è.",
            danger: "–ö—Ä–∏—Ç–∏—á–µ—Å–∫–æ–µ –Ω–∞—Ä—É—à–µ–Ω–∏–µ –æ–∫–Ω–∞! –†–∏—Å–∫ –ø–µ—Ä–µ—É—Ç–æ–º–ª–µ–Ω–∏—è –∏–ª–∏ –Ω–µ–¥–æ—Å—Ç–∞—Ç–∫–∞ —Å–Ω–∞. –°–∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä—É–π—Ç–µ –Ω–µ–º–µ–¥–ª–µ–Ω–Ω–æ."
        },
        nap2: {
            success: "–ö–æ—Ä–æ—Ç–∫–∏–π –¥–Ω–µ–≤–Ω–æ–π —Å–æ–Ω –≤ –Ω–æ—Ä–º–µ. –ï—Å–ª–∏ —Å–ø–∏—Ç –º–µ–Ω—å—à–µ 30 –º–∏–Ω—É—Ç ‚Äî –ø—Ä–æ–¥–ª–∏—Ç—å –ø–æ–∫–∞—á–∏–≤–∞–Ω–∏–µ–º –∏–ª–∏ –∫–æ–Ω—Ç–∞–∫—Ç–Ω—ã–º —Å–Ω–æ–º.",
            warning: "–í—Ç–æ—Ä–æ–π —Å–æ–Ω —Ç—Ä–µ–±—É–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ü–∏–∏. –û–ø—Ç–∏–º–∞–ª—å–Ω–æ–µ –≤—Ä–µ–º—è 13:30-14:30, –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å 30-60 –º–∏–Ω—É—Ç.",
            danger: "–í—Ç–æ—Ä–æ–π —Å–æ–Ω –Ω–∞—Ä—É—à–∞–µ—Ç —Ä–µ–∂–∏–º! –°–ª–∏—à–∫–æ–º –ø–æ–∑–¥–Ω–æ –∏–ª–∏ —Å–ª–∏—à–∫–æ–º –¥–æ–ª–≥–æ - —ç—Ç–æ –ø–æ–≤–ª–∏—è–µ—Ç –Ω–∞ —Ç—Ä–µ—Ç–∏–π —Å–æ–Ω –∏ –Ω–æ—á—å."
        },
        nap3: {
            success: "–¢—Ä–µ—Ç–∏–π —Å–æ–Ω –≤ –¥–æ–ø—É—Å—Ç–∏–º—ã—Ö —Ä–∞–º–∫–∞—Ö. –°–ª–µ–¥–∏—Ç–µ –∑–∞ –≤—Ä–µ–º–µ–Ω–µ–º –æ–∫–æ–Ω—á–∞–Ω–∏—è - —Å—Ç—Ä–æ–≥–æ –¥–æ 18:15!",
            warning: "–ù–∞ –≥—Ä–∞–Ω–∏ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–æ–≥–æ –≤—Ä–µ–º–µ–Ω–∏! –ì–æ—Ç–æ–≤—å—Ç–µ –±—É–¥–∏–ª—å–Ω–∏–∫, –ø—Ä–æ–≤–µ—Ä—è–π—Ç–µ –∫–∞–∂–¥—ã–µ 10-15 –º–∏–Ω—É—Ç.",
            danger: "–ö–†–ò–¢–ò–ß–ù–û! –ü—Ä–µ–≤—ã—à–µ–Ω–∏–µ –ª–∏–º–∏—Ç–∞ 18:15 —Ä–∞–∑—Ä—É—à–∏—Ç –Ω–æ—á–Ω–æ–π —Å–æ–Ω. –ù–µ–º–µ–¥–ª–µ–Ω–Ω–æ–µ –ø—Ä–æ–±—É–∂–¥–µ–Ω–∏–µ —Ç—Ä–µ–±—É–µ—Ç—Å—è!"
        },
        bedtime: {
            success: "–ó–æ–ª–æ—Ç–æ–µ –æ–∫–Ω–æ –¥–ª—è –æ—Ç–±–æ—è! –ù–∞—á–∏–Ω–∞–π—Ç–µ —Ä–∏—Ç—É–∞–ª –∑–∞ —á–∞—Å: –∫—É–ø–∞–Ω–∏–µ ‚Üí –º–∞—Å—Å–∞–∂ ‚Üí –∫–æ—Ä–º–ª–µ–Ω–∏–µ ‚Üí –∫–æ–ª—ã–±–µ–ª—å–Ω–∞—è.",
            warning: "–í—Ä–µ–º—è –æ—Ç–±–æ—è —Ç—Ä–µ–±—É–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ü–∏–∏. –ò–¥–µ–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ 20:30-21:30 –¥–ª—è –≤–æ–∑—Ä–∞—Å—Ç–∞ 6 –º–µ—Å—è—Ü–µ–≤.",
            danger: "–ö—Ä–∏—Ç–∏—á–µ—Å–∫–æ–µ –≤—Ä–µ–º—è –æ—Ç–±–æ—è! –°–ª–∏—à–∫–æ–º —Ä–∞–Ω–æ - —Ä–µ–±—ë–Ω–æ–∫ –Ω–µ —É—Å—Ç–∞–Ω–µ—Ç, —Å–ª–∏—à–∫–æ–º –ø–æ–∑–¥–Ω–æ - –ø–µ—Ä–µ—É—Ç–æ–º–∏—Ç—Å—è."
        }
    };

    const recElement = document.getElementById(`rec${field.charAt(0).toUpperCase() + field.slice(1)}`);
    if (recElement && recommendations[field]) {
        const recText = recElement.querySelector('.recommendation-text');
        if (recText && recommendations[field][status]) {
            recText.textContent = recommendations[field][status];
        }

        recElement.className = `recommendation ${status === 'danger' ? 'danger' : status === 'warning' ? 'warning' : ''}`;
    }
};

// ================== MAIN CALCULATION ==================
const calculate = () => {
    const data = scheduleData[currentChild];
    if (!data) return;

    applyAutoWake();

    const wakeupMin = timeToMinutes(data.wakeup);
    const nap1StartMin = timeToMinutes(data.nap1start);
    const nap1EndMin = timeToMinutes(data.nap1end);
    const nap2StartMin = timeToMinutes(data.nap2start);
    const nap2EndMin = timeToMinutes(data.nap2end);
    const nap3StartMin = timeToMinutes(data.nap3start);
    const nap3EndMin = timeToMinutes(data.nap3end);

    const window1 = calculateDuration(wakeupMin, nap1StartMin);
    const nap1Duration = calculateDuration(nap1StartMin, nap1EndMin);
    const window2 = calculateDuration(nap1EndMin, nap2StartMin);
    const nap2Duration = calculateDuration(nap2StartMin, nap2EndMin);
    const window3 = calculateDuration(nap2EndMin, nap3StartMin);
    const nap3Duration = calculateDuration(nap3StartMin, nap3EndMin);

    const eveningWindow = 165;
    const bedtimeMin = (nap3EndMin + eveningWindow) % (24 * 60);
    const nightSleep = proSettings.nightTarget;

    // Update display
    const updateElement = (id, value) => {
        const element = document.getElementById(id);
        if (element) element.textContent = value;
    };

    updateElement('window1', formatDuration(window1));
    updateElement('nap1Duration', formatDuration(nap1Duration));
    updateElement('window2', formatDuration(window2));
    updateElement('nap2Duration', formatDuration(nap2Duration));
    updateElement('window3', formatDuration(window3));
    updateElement('nap3Duration', formatDuration(nap3Duration));
    updateElement('bedtimeCalc', minutesToTime(bedtimeMin));
    updateElement('eveningWindow', formatDuration(eveningWindow));
    updateElement('nightDuration', formatDuration(nightSleep));

    // Update wake window bars
    updateWakeWindowBar(1, window1);
    updateWakeWindowBar(2, window2);  
    updateWakeWindowBar(3, window3);

    // Check wake window limits
    checkWakeWindowLimits();

    // Apply age recommendations if enabled
    if (proSettings.ageRecMode !== 'off') {
        const kid = kidsData.find(k => k.id === currentChild);
        const ageMonths = getAgeInMonths(kid.dob);
        const recs = getAgeRecommendations(ageMonths);

        if (proSettings.ageRecMode === 'brackets') {
            updateElement('window1', formatDuration(window1) + ' (' + formatDuration(recs.window1) + ')');
            updateElement('nap1Duration', formatDuration(nap1Duration) + ' (' + formatDuration(recs.nap1) + ')');
            updateElement('window2', formatDuration(window2) + ' (' + formatDuration(recs.window2) + ')');
            updateElement('nap2Duration', formatDuration(nap2Duration) + ' (' + formatDuration(recs.nap2) + ')');
            updateElement('window3', formatDuration(window3) + ' (' + formatDuration(recs.window3) + ')');
            updateElement('nap3Duration', formatDuration(nap3Duration) + ' (' + formatDuration(recs.nap3) + ')');
            updateElement('nightDuration', formatDuration(nightSleep) + ' (' + formatDuration(recs.nightSleep) + ')');
        } else if (proSettings.ageRecMode === 'replace') {
            updateElement('window1', formatDuration(recs.window1));
            updateElement('nap1Duration', formatDuration(recs.nap1));
            updateElement('window2', formatDuration(recs.window2));
            updateElement('nap2Duration', formatDuration(recs.nap2));
            updateElement('window3', formatDuration(recs.window3));
            updateElement('nap3Duration', formatDuration(recs.nap3));
            updateElement('nightDuration', formatDuration(recs.nightSleep));
        }
    }

    // Enhanced status analysis
    const minWake = timeToMinutes('07:00');
    const maxWake = timeToMinutes('08:00');
    const criticalTime = timeToMinutes('18:15');

    // Wakeup status
    let wakeupStatus = 'success';
    const wakeupElement = document.getElementById('statusWakeup');
    const wakeupTimerElement = document.getElementById('timerWakeup');

    if (wakeupMin < minWake - 20 || wakeupMin > maxWake + 20) {
        wakeupStatus = 'danger';
        if (wakeupElement) {
            wakeupElement.className = 'status-badge status-danger';
            wakeupElement.textContent = '‚ùå –ö—Ä–∏—Ç–∏—á–Ω–æ';
        }
        if (wakeupTimerElement) wakeupTimerElement.textContent = '–¢—Ä–µ–±—É–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ü–∏–∏!';
    } else if (wakeupMin < minWake || wakeupMin > maxWake) {
        wakeupStatus = 'warning';
        if (wakeupElement) {
            wakeupElement.className = 'status-badge status-warning';
            wakeupElement.textContent = '‚ö†Ô∏è –ù–µ –æ–ø—Ç–∏–º–∞–ª—å–Ω–æ';
        }
        if (wakeupTimerElement) wakeupTimerElement.textContent = '–õ—É—á—à–µ 07:00-08:00';
    } else {
        if (wakeupElement) {
            wakeupElement.className = 'status-badge status-success';
            wakeupElement.textContent = '‚úÖ –û–ø—Ç–∏–º–∞–ª—å–Ω–æ';
        }
        if (wakeupTimerElement) wakeupTimerElement.textContent = '–ò–¥–µ–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ';
    }
    updateEnhancedRecommendations('wakeup', wakeupStatus);

    // Nap statuses with detailed analysis
    const updateNapStatus = (napNumber, windowDuration, napDuration, optimalWindow, optimalNapDuration) => {
        let status = 'success';
        const statusElement = document.getElementById(`statusNap${napNumber}`);
        const timerElement = document.getElementById(`timerNap${napNumber}`);

        if (windowDuration < optimalWindow * 0.6 || windowDuration > optimalWindow * 1.5 || 
            napDuration < optimalNapDuration * 0.6 || napDuration > optimalNapDuration * 1.4) {
            status = 'danger';
            if (statusElement) {
                statusElement.className = 'status-badge status-danger';
                statusElement.textContent = '‚ùå –ö—Ä–∏—Ç–∏—á–Ω–æ';
            }
            if (timerElement) timerElement.textContent = '–°—Ä–æ—á–Ω–æ –∏—Å–ø—Ä–∞–≤–∏—Ç—å!';
        } else if (windowDuration < optimalWindow * 0.8 || windowDuration > optimalWindow * 1.2 ||
                   napDuration < optimalNapDuration * 0.8 || napDuration > optimalNapDuration * 1.2) {
            status = 'warning';
            if (statusElement) {
                statusElement.className = 'status-badge status-warning';
                statusElement.textContent = '‚ö†Ô∏è –ö–æ—Ä—Ä–µ–∫—Ü–∏—è';
            }
            if (timerElement) timerElement.textContent = '–ú–æ–∂–Ω–æ —É–ª—É—á—à–∏—Ç—å';
        } else {
            if (statusElement) {
                statusElement.className = 'status-badge status-success';
                statusElement.textContent = '‚úÖ –ò–¥–µ–∞–ª—å–Ω–æ';
            }
            if (timerElement) {
                const maxEnd = timeToMinutes(data[`nap${napNumber}start`]) + optimalNapDuration * 1.2;
                timerElement.textContent = '–ú–æ–∂–Ω–æ —Å–ø–∞—Ç—å –¥–æ ' + minutesToTime(maxEnd);
            }
        }
        updateEnhancedRecommendations(`nap${napNumber}`, status);
    };

    updateNapStatus(1, window1, nap1Duration, 180, 90);
    updateNapStatus(2, window2, nap2Duration, 120, 45);

    // Nap 3 critical status
    let nap3Status = 'success';
    const nap3StatusElement = document.getElementById('statusNap3');
    const nap3TimerElement = document.getElementById('timerNap3');

    if (nap3EndMin > criticalTime) {
        nap3Status = 'danger';
        if (nap3StatusElement) {
            nap3StatusElement.className = 'status-badge status-danger';
            nap3StatusElement.textContent = 'üö® –ü–†–ï–í–´–®–ï–ù –õ–ò–ú–ò–¢!';
        }
        if (nap3TimerElement) nap3TimerElement.textContent = '–ë–£–î–ò–¢–¨ –ù–ï–ú–ï–î–õ–ï–ù–ù–û!';
    } else if (nap3EndMin > timeToMinutes('18:00')) {
        nap3Status = 'warning';
        if (nap3StatusElement) {
            nap3StatusElement.className = 'status-badge status-warning';
            nap3StatusElement.textContent = '‚ö†Ô∏è –ë–ª–∏–∑–∫–æ –∫ –ª–∏–º–∏—Ç—É';
        }
        const timeLeft = calculateDuration(nap3EndMin, criticalTime);
        if (nap3TimerElement) nap3TimerElement.textContent = '–û—Å—Ç–∞–ª–æ—Å—å ' + formatDuration(timeLeft);
    } else {
        if (nap3StatusElement) {
            nap3StatusElement.className = 'status-badge status-success';
            nap3StatusElement.textContent = '‚úÖ –í –±–µ–∑–æ–ø–∞—Å–Ω–æ–π –∑–æ–Ω–µ';
        }
        if (nap3TimerElement) nap3TimerElement.textContent = '–ë—É–¥–∏—Ç—å –¥–æ 18:15';
    }
    updateEnhancedRecommendations('nap3', nap3Status);

    // Bedtime status
    const actualEveningWindow = calculateDuration(nap3EndMin, bedtimeMin);
    let bedtimeStatus = 'success';
    const bedtimeStatusElement = document.getElementById('statusBedtime');
    const bedtimeTimerElement = document.getElementById('timerBedtime');

    if (actualEveningWindow < 135 || actualEveningWindow > 210) {
        bedtimeStatus = actualEveningWindow < 120 || actualEveningWindow > 240 ? 'danger' : 'warning';
        const statusClass = bedtimeStatus === 'danger' ? 'status-danger' : 'status-warning';
        const statusText = bedtimeStatus === 'danger' ? '‚ùå –ö—Ä–∏—Ç–∏—á–Ω–æ' : '‚ö†Ô∏è –ö–æ—Ä—Ä–µ–∫—Ü–∏—è';
        if (bedtimeStatusElement) {
            bedtimeStatusElement.className = `status-badge ${statusClass}`;
            bedtimeStatusElement.textContent = statusText;
        }
        if (bedtimeTimerElement) bedtimeTimerElement.textContent = bedtimeStatus === 'danger' ? '–°—Ä–æ—á–Ω–æ –∏—Å–ø—Ä–∞–≤–∏—Ç—å!' : '–ú–æ–∂–Ω–æ —É–ª—É—á—à–∏—Ç—å';
    } else if (actualEveningWindow >= 160 && actualEveningWindow <= 175) {
        if (bedtimeStatusElement) {
            bedtimeStatusElement.className = 'status-badge status-gold';
            bedtimeStatusElement.textContent = '‚ú® –ó–æ–ª–æ—Ç–æ–µ –æ–∫–Ω–æ!';
        }
        if (bedtimeTimerElement) bedtimeTimerElement.textContent = '–ò–¥–µ–∞–ª—å–Ω–æ–µ –≤—Ä–µ–º—è: ' + minutesToTime(bedtimeMin);
    } else {
        if (bedtimeStatusElement) {
            bedtimeStatusElement.className = 'status-badge status-success';
            bedtimeStatusElement.textContent = '‚úÖ –•–æ—Ä–æ—à–æ';
        }
        if (bedtimeTimerElement) bedtimeTimerElement.textContent = '–õ–æ–∂–∏—Ç—å –≤ ' + minutesToTime(bedtimeMin);
    }
    updateEnhancedRecommendations('bedtime', bedtimeStatus);

    updateActionBanner();
    updateSmartRecommendations();

    saveData();
};

// ================== ACTION BANNER ==================
const updateActionBanner = () => {
    const currentTime = getCurrentTime();
    const data = scheduleData[currentChild];

    const wakeupMin = timeToMinutes(data.wakeup);
    const nap1StartMin = timeToMinutes(data.nap1start);
    const nap1EndMin = timeToMinutes(data.nap1end);
    const nap2StartMin = timeToMinutes(data.nap2start);
    const nap2EndMin = timeToMinutes(data.nap2end);
    const nap3StartMin = timeToMinutes(data.nap3start);
    const nap3EndMin = timeToMinutes(data.nap3end);
    const bedtimeMin = (nap3EndMin + 165) % (24 * 60);
    const nextWakeupMin = (bedtimeMin + proSettings.nightTarget) % (24 * 60);

    const actionBanner = document.getElementById('actionBanner');
    const actionText = document.getElementById('actionText');
    const actionTimer = document.getElementById('actionTimer');

    if (!actionBanner || !actionText || !actionTimer) return;

    if (currentTime >= wakeupMin && currentTime < nap1StartMin) {
        actionText.textContent = '–£—Ç—Ä–µ–Ω–Ω–µ–µ –±–æ–¥—Ä—Å—Ç–≤–æ–≤–∞–Ω–∏–µ';
        const timeToNap = calculateDuration(currentTime, nap1StartMin);
        actionTimer.textContent = '–î–æ –¥—Ä–µ–º—ã 1: ' + formatDuration(timeToNap);
        actionBanner.className = 'action-banner';
    } else if (currentTime >= nap1StartMin && currentTime < nap1EndMin) {
        actionText.textContent = '–î—Ä–µ–º–∞ 1 ‚Äî –æ—Å–Ω–æ–≤–Ω–æ–π —Å–æ–Ω';
        const timeToWake = calculateDuration(currentTime, Math.min(nap1EndMin, nap1StartMin + 105));
        actionTimer.textContent = '–î–æ –ø—Ä–æ–±—É–∂–¥–µ–Ω–∏—è: ' + formatDuration(timeToWake);
        actionBanner.className = 'action-banner warning';
    } else if (currentTime >= nap1EndMin && currentTime < nap2StartMin) {
        actionText.textContent = '–î–Ω–µ–≤–Ω–æ–µ –±–æ–¥—Ä—Å—Ç–≤–æ–≤–∞–Ω–∏–µ';
        const timeToNap = calculateDuration(currentTime, nap2StartMin);
        actionTimer.textContent = '–î–æ –¥—Ä–µ–º—ã 2: ' + formatDuration(timeToNap);
        actionBanner.className = 'action-banner';
    } else if (currentTime >= nap2StartMin && currentTime < nap2EndMin) {
        actionText.textContent = '–î—Ä–µ–º–∞ 2 ‚Äî –∫–æ—Ä–æ—Ç–∫–∏–π —Å–æ–Ω';
        const timeToWake = calculateDuration(currentTime, Math.min(nap2EndMin, nap2StartMin + 60));
        actionTimer.textContent = '–î–æ –ø—Ä–æ–±—É–∂–¥–µ–Ω–∏—è: ' + formatDuration(timeToWake);
        actionBanner.className = 'action-banner warning';
    } else if (currentTime >= nap2EndMin && currentTime < nap3StartMin) {
        actionText.textContent = '–í–µ—á–µ—Ä–Ω–µ–µ –±–æ–¥—Ä—Å—Ç–≤–æ–≤–∞–Ω–∏–µ';
        const timeToNap = calculateDuration(currentTime, nap3StartMin);
        actionTimer.textContent = '–î–æ –¥—Ä–µ–º—ã 3: ' + formatDuration(timeToNap);
        actionBanner.className = 'action-banner';
    } else if (currentTime >= nap3StartMin && currentTime < Math.min(nap3EndMin, timeToMinutes('18:15'))) {
        actionText.textContent = '–î—Ä–µ–º–∞ 3 ‚Äî –°–õ–ï–î–ò–¢–¨ –ó–ê –õ–ò–ú–ò–¢–û–ú!';
        const timeToLimit = calculateDuration(currentTime, timeToMinutes('18:15'));
        actionTimer.textContent = '–î–æ –û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û–ì–û –ø–æ–¥—ä—ë–º–∞: ' + formatDuration(timeToLimit);
        actionBanner.className = 'action-banner danger';
    } else if (currentTime >= nap3EndMin && currentTime < bedtimeMin) {
        actionText.textContent = '–ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –∫ –Ω–æ—á–Ω–æ–º—É —Å–Ω—É';
        const timeToBed = calculateDuration(currentTime, bedtimeMin);
        actionTimer.textContent = '–î–æ —É–∫–ª–∞–¥—ã–≤–∞–Ω–∏—è: ' + formatDuration(timeToBed);
        actionBanner.className = 'action-banner';
    } else {
        actionText.textContent = '–ù–æ—á–Ω–æ–π —Å–æ–Ω';
        const timeToWakeup = calculateDuration(currentTime, nextWakeupMin);
        actionTimer.textContent = '–î–æ –ø–æ–¥—ä—ë–º–∞: ' + formatDuration(timeToWakeup);
        actionBanner.className = 'action-banner';
    }
};

// ================== EVENT HANDLERS ==================
const onTimeChange = (fieldId, value) => {
    scheduleData[currentChild][fieldId] = value;

    // Smart nap end correction
    if (fieldId.includes('start') && proSettings.smartEnd) {
        const napNumber = fieldId.includes('nap1') ? 1 : fieldId.includes('nap2') ? 2 : fieldId.includes('nap3') ? 3 : null;
        if (napNumber) {
            correctNapEnd(napNumber, value);
        }
    }

    applyCascade(fieldId);
    calculate();
};

// ================== PRO FUNCTIONS ==================
const toggleAutoWake = () => {
    proSettings.autoWake = !proSettings.autoWake;
    document.getElementById('autoWakeBtn').classList.toggle('active', proSettings.autoWake);
    document.getElementById('autoWakeToggle').checked = proSettings.autoWake;
    calculate();
    showToast(`–ê–≤—Ç–æ-–ø–æ–¥—ä—ë–º ${proSettings.autoWake ? '–≤–∫–ª—é—á–µ–Ω' : '–≤—ã–∫–ª—é—á–µ–Ω'}`, 'success');
};

const toggleCascade = () => {
    proSettings.cascade = !proSettings.cascade;
    document.getElementById('cascadeBtn').classList.toggle('active', proSettings.cascade);
    document.getElementById('cascadeToggle').checked = proSettings.cascade;
    showToast(`–ö–∞—Å–∫–∞–¥ ${proSettings.cascade ? '–≤–∫–ª—é—á–µ–Ω' : '–≤—ã–∫–ª—é—á–µ–Ω'}`, 'success');
};

const toggleSmartRecs = () => {
    proSettings.smartRecs = !proSettings.smartRecs;
    document.getElementById('smartBtn').classList.toggle('active', proSettings.smartRecs);
    document.getElementById('smartRecsToggle').checked = proSettings.smartRecs;
    calculate();
    showToast(`–£–º–Ω—ã–µ —Å–æ–≤–µ—Ç—ã ${proSettings.smartRecs ? '–≤–∫–ª—é—á–µ–Ω—ã' : '–≤—ã–∫–ª—é—á–µ–Ω—ã'}`, 'success');
};

const toggleAgeRecs = () => {
    const modes = ['off', 'brackets', 'replace'];
    const currentIndex = modes.indexOf(proSettings.ageRecMode);
    const nextIndex = (currentIndex + 1) % modes.length;
    proSettings.ageRecMode = modes[nextIndex];

    document.getElementById('ageRecsBtn').classList.toggle('active', proSettings.ageRecMode !== 'off');
    document.getElementById('ageRecMode').value = proSettings.ageRecMode;

    calculate();

    const modeNames = {off: '–≤—ã–∫–ª—é—á–µ–Ω—ã', brackets: '–≤ —Å–∫–æ–±–∫–∞—Ö', replace: '–∑–∞–º–µ–Ω—è—é—Ç –∑–Ω–∞—á–µ–Ω–∏—è'};
    showToast(`–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ –≤–æ–∑—Ä–∞—Å—Ç—É ${modeNames[proSettings.ageRecMode]}`, 'success');
};

const resetToDefaults = () => {
    const defaults = {
        marcus: { wakeup: '07:20', nap1start: '10:20', nap1end: '11:50', nap2start: '13:50', nap2end: '14:35', nap3start: '16:50', nap3end: '18:05' },
        william: { wakeup: '07:40', nap1start: '10:40', nap1end: '12:10', nap2start: '14:10', nap2end: '14:55', nap3start: '17:10', nap3end: '18:15' }
    };

    scheduleData = {...scheduleData, ...defaults};
    loadChildData();
    calculate();
    showToast('–°–±—Ä–æ—à–µ–Ω–æ –∫ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è–º', 'success');
};

// ================== NAVIGATION ==================
const switchToPanel = (panelId) => {
    ['scheduleSection', 'settingsPanel', 'kidsPanel', 'importPanel', 'analyticsPanel'].forEach(id => {
        const element = document.getElementById(id);
        if (element) element.style.display = 'none';
    });

    const targetPanel = document.getElementById(panelId);
    if (targetPanel) targetPanel.style.display = 'block';

    document.querySelectorAll('.nav-item').forEach(item => item.classList.remove('active'));

    const navMap = {
        scheduleSection: 'navSchedule',
        settingsPanel: 'navSettings', 
        kidsPanel: 'navKids',
        importPanel: 'navImport',
        analyticsPanel: 'navAnalytics'
    };

    if (navMap[panelId]) {
        const navElement = document.getElementById(navMap[panelId]);
        if (navElement) navElement.classList.add('active');
    }
};

// ================== KIDS MANAGEMENT ==================
const renderKidsList = () => {
    const list = document.getElementById('kidsList');
    if (!list) return;

    list.innerHTML = '';

    kidsData.forEach(kid => {
        const chip = document.createElement('div');
        chip.className = 'kid-chip';
        chip.innerHTML = `${kid.name} (${getAgeInMonths(kid.dob)} –º–µ—Å) <span class="delete-btn" onclick="deleteKid('${kid.id}')">√ó</span>`;
        list.appendChild(chip);
    });
};

const deleteKid = (kidId) => {
    const kid = kidsData.find(k => k.id === kidId);
    if (kid && confirm(`–£–¥–∞–ª–∏—Ç—å ${kid.name}?`)) {
        kidsData = kidsData.filter(k => k.id !== kidId);
        delete scheduleData[kidId];

        if (currentChild === kidId && kidsData.length > 0) {
            currentChild = kidsData[0].id;
            selectChild(currentChild);
        }

        renderKidsList();
        updateChildSelector();
        saveData();
        showToast(`${kid.name} —É–¥–∞–ª–µ–Ω(–∞)`, 'success');
    }
};

const addKid = () => {
    const nameElement = document.getElementById('kidName');
    const dobElement = document.getElementById('kidDob');

    if (!nameElement || !dobElement) return;

    const name = nameElement.value.trim();
    const dob = dobElement.value;

    if (!name || !dob) {
        showToast('–í–≤–µ–¥–∏—Ç–µ –∏–º—è –∏ –¥–∞—Ç—É —Ä–æ–∂–¥–µ–Ω–∏—è', 'warning');
        return;
    }

    const id = name.toLowerCase().replace(/\s+/g, '_') + '_' + Date.now();
    const newKid = {id, name, dob};

    kidsData.push(newKid);
    scheduleData[id] = JSON.parse(JSON.stringify(scheduleData.marcus));

    nameElement.value = '';
    dobElement.value = '';

    renderKidsList();
    updateChildSelector();
    saveData();
    showToast(`${name} –¥–æ–±–∞–≤–ª–µ–Ω(–∞)`, 'success');
};

// ================== FILE IMPORT/EXPORT ==================
const handleFileImport = (event) => {
    const file = event.target.files[0];
    if (!file) return;

    const reader = new FileReader();
    reader.onload = function(e) {
        try {
            let data;
            if (file.name.endsWith('.json')) {
                data = JSON.parse(e.target.result);
            } else {
                const lines = e.target.result.split('
');
                data = lines.slice(1).map(line => {
                    const [date, start, end, type] = line.split(',');
                    return {date, start, end, type};
                }).filter(row => row.start && row.end);
            }

            if (data.length === 0) {
                showToast('–§–∞–π–ª –ø—É—Å—Ç–æ–π –∏–ª–∏ –Ω–µ–≤–µ—Ä–Ω–æ–≥–æ —Ñ–æ—Ä–º–∞—Ç–∞', 'danger');
                return;
            }

            const naps = data.filter(item => item.type && item.type.toLowerCase().includes('nap'));

            if (naps.length > 0) {
                let totalDurations = [];
                naps.forEach(nap => {
                    const duration = calculateDuration(timeToMinutes(nap.start), timeToMinutes(nap.end));
                    totalDurations.push(duration);
                });

                if (totalDurations.length >= 3) {
                    const avgDuration = totalDurations.reduce((a, b) => a + b, 0) / totalDurations.length;

                    const childData = scheduleData[currentChild];
                    const n1Start = timeToMinutes(childData.nap1start);
                    const n2Start = timeToMinutes(childData.nap2start);
                    const n3Start = timeToMinutes(childData.nap3start);

                    childData.nap1end = minutesToTime(n1Start + Math.round(avgDuration));
                    childData.nap2end = minutesToTime(n2Start + Math.round(avgDuration * 0.5));
                    childData.nap3end = minutesToTime(Math.min(n3Start + Math.round(avgDuration * 0.8), timeToMinutes('18:15')));

                    loadChildData();
                    calculate();
                }
            }

            showToast(`–ò–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–æ –∑–∞–ø–∏—Å–µ–π: ${data.length}`, 'success');
        } catch (error) {
            showToast('–û—à–∏–±–∫–∞ —á—Ç–µ–Ω–∏—è —Ñ–∞–π–ª–∞', 'danger');
            console.error(error);
        }
    };

    reader.readAsText(file);
};

const exportData = () => {
    const csvContent = "data:text/csv;charset=utf-8,Child,Date,Activity,Start,End,Duration
" +
        Object.keys(scheduleData).map(childId => {
            const data = scheduleData[childId];
            const kid = kidsData.find(k => k.id === childId);
            const today = new Date().toISOString().split('T')[0];
            return [
                `${kid ? kid.name : childId},${today},Wakeup,${data.wakeup},,`,
                `${kid ? kid.name : childId},${today},Nap1,${data.nap1start},${data.nap1end},${formatDuration(calculateDuration(timeToMinutes(data.nap1start), timeToMinutes(data.nap1end)))}`,
                `${kid ? kid.name : childId},${today},Nap2,${data.nap2start},${data.nap2end},${formatDuration(calculateDuration(timeToMinutes(data.nap2start), timeToMinutes(data.nap2end)))}`,
                `${kid ? kid.name : childId},${today},Nap3,${data.nap3start},${data.nap3end},${formatDuration(calculateDuration(timeToMinutes(data.nap3start), timeToMinutes(data.nap3end)))}`
            ].join('
');
        }).join('
');

    const encodedUri = encodeURI(csvContent);
    const link = document.createElement("a");
    link.setAttribute("href", encodedUri);
    link.setAttribute("download", "sleep_data.csv");
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);

    showToast('–î–∞–Ω–Ω—ã–µ —ç–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω—ã –≤ CSV', 'success');
};

// ================== TOAST NOTIFICATIONS ==================
const showToast = (message, type = 'success', duration = 3000) => {
    const toast = document.getElementById('toast');
    if (!toast) return;

    toast.textContent = message;
    toast.className = `toast ${type} show`;

    setTimeout(() => {
        toast.className = 'toast';
    }, duration);
};

// ================== INITIALIZATION ==================
const init = () => {
    try {
        loadData();

        // Event listeners for time inputs
        ['wakeup', 'nap1start', 'nap1end', 'nap2start', 'nap2end', 'nap3start', 'nap3end'].forEach(id => {
            const element = document.getElementById(id);
            if (element) {
                element.addEventListener('change', (e) => onTimeChange(id, e.target.value));
            }
        });

        // PRO controls
        const proButtons = {
            'autoWakeBtn': toggleAutoWake,
            'cascadeBtn': toggleCascade,  
            'ageRecsBtn': toggleAgeRecs,
            'smartBtn': toggleSmartRecs,
            'resetBtn': resetToDefaults
        };

        Object.entries(proButtons).forEach(([id, handler]) => {
            const element = document.getElementById(id);
            if (element) element.addEventListener('click', handler);
        });

        // Settings toggles
        const settingsToggles = {
            'autoWakeToggle': (e) => {
                proSettings.autoWake = e.target.checked;
                const btn = document.getElementById('autoWakeBtn');
                if (btn) btn.classList.toggle('active', proSettings.autoWake);
                calculate();
            },
            'cascadeToggle': (e) => {
                proSettings.cascade = e.target.checked;
                const btn = document.getElementById('cascadeBtn');
                if (btn) btn.classList.toggle('active', proSettings.cascade);
            },
            'smartEndToggle': (e) => {
                proSettings.smartEnd = e.target.checked;
            },
            'windowControlToggle': (e) => {
                proSettings.windowControl = e.target.checked;
                calculate();
            },
            'smartRecsToggle': (e) => {
                proSettings.smartRecs = e.target.checked;
                const btn = document.getElementById('smartBtn');
                if (btn) btn.classList.toggle('active', proSettings.smartRecs);
                calculate();
            }
        };

        Object.entries(settingsToggles).forEach(([id, handler]) => {
            const element = document.getElementById(id);
            if (element) element.addEventListener('change', handler);
        });

        // Select elements
        const selectElements = {
            'ageRecMode': (e) => {
                proSettings.ageRecMode = e.target.value;
                const btn = document.getElementById('ageRecsBtn');
                if (btn) btn.classList.toggle('active', proSettings.ageRecMode !== 'off');
                calculate();
            },
            'nightTarget': (e) => {
                proSettings.nightTarget = Number(e.target.value);
                calculate();
            }
        };

        Object.entries(selectElements).forEach(([id, handler]) => {
            const element = document.getElementById(id);
            if (element) element.addEventListener('change', handler);
        });

        // Navigation
        const navItems = {
            'navSchedule': () => switchToPanel('scheduleSection'),
            'navSettings': () => switchToPanel('settingsPanel'),
            'navKids': () => switchToPanel('kidsPanel'),
            'navImport': () => switchToPanel('importPanel'),
            'navAnalytics': () => switchToPanel('analyticsPanel')
        };

        Object.entries(navItems).forEach(([id, handler]) => {
            const element = document.getElementById(id);
            if (element) element.addEventListener('click', handler);
        });

        // Kids management
        const addKidBtn = document.getElementById('addKidBtn');
        if (addKidBtn) addKidBtn.addEventListener('click', addKid);

        // File operations
        const fileInput = document.getElementById('fileInput');
        if (fileInput) fileInput.addEventListener('change', handleFileImport);

        const exportBtn = document.getElementById('exportBtn');
        if (exportBtn) exportBtn.addEventListener('click', exportData);

        // Initialize toggles state
        document.getElementById('autoWakeBtn')?.classList.toggle('active', proSettings.autoWake);
        document.getElementById('cascadeBtn')?.classList.toggle('active', proSettings.cascade);
        document.getElementById('ageRecsBtn')?.classList.toggle('active', proSettings.ageRecMode !== 'off');
        document.getElementById('smartBtn')?.classList.toggle('active', proSettings.smartRecs);

        // Set initial values
        if (document.getElementById('autoWakeToggle')) document.getElementById('autoWakeToggle').checked = proSettings.autoWake;
        if (document.getElementById('cascadeToggle')) document.getElementById('cascadeToggle').checked = proSettings.cascade;
        if (document.getElementById('smartEndToggle')) document.getElementById('smartEndToggle').checked = proSettings.smartEnd;
        if (document.getElementById('windowControlToggle')) document.getElementById('windowControlToggle').checked = proSettings.windowControl;
        if (document.getElementById('ageRecMode')) document.getElementById('ageRecMode').value = proSettings.ageRecMode;
        if (document.getElementById('smartRecsToggle')) document.getElementById('smartRecsToggle').checked = proSettings.smartRecs;
        if (document.getElementById('nightTarget')) document.getElementById('nightTarget').value = proSettings.nightTarget;

        // Initialize child selector and data
        updateChildSelector();
        selectChild(currentChild);
        renderKidsList();

        // Start time updates
        setInterval(updateCurrentTime, 1000);
        setInterval(calculate, 60000);

        calculate();
        showToast('Ultimate Sleep Tracker PRO –∑–∞–≥—Ä—É–∂–µ–Ω!', 'success');

    } catch (error) {
        console.error('–û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏:', error);
        showToast('–û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è', 'danger');
    }
};

// Close dropdowns on outside click
document.addEventListener('click', (e) => {
    if (!e.target.closest('.multi-child-selector')) {
        const dropdown = document.getElementById('childDropdown');
        if (dropdown) dropdown.classList.remove('show');
    }
});

// Start when DOM is ready
document.addEventListener('DOMContentLoaded', init);

// Make deleteKid globally accessible
window.deleteKid = deleteKid;
</script>

</body>
</html>