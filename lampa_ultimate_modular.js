/*
Lampa Ultimate Modular Plugin
============================

–ú–Ω–æ–≥–æ—Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–π –º–æ–¥—É–ª—å–Ω—ã–π –ø–ª–∞–≥–∏–Ω –¥–ª—è Lampa —Å –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π –ø—Ä–æ—Ñ–∏–ª–µ–π, –∫–æ–ª–ª–µ–∫—Ü–∏–π, —Ñ–∏–ª—å—Ç—Ä–æ–≤, –∞–Ω–∞–ª–∏—Ç–∏–∫–∏, Telegram, —Ç–µ–º, VPN –∏ –¥—Ä—É–≥–∏—Ö —Ä–∞—Å—à–∏—Ä–µ–Ω–∏–π.

---

# –£—Å—Ç–∞–Ω–æ–≤–∫–∞
1. –°–∫–æ–ø–∏—Ä—É–π—Ç–µ —ç—Ç–æ—Ç —Ñ–∞–π–ª (`lampa_ultimate_modular.js`) –≤ –ø–∞–ø–∫—É –ø–ª–∞–≥–∏–Ω–æ–≤ Lampa –∏–ª–∏ –ø–æ–¥–∫–ª—é—á–∏—Ç–µ —á–µ—Ä–µ–∑ –º–µ–Ω—é Lampa ("–î–æ–±–∞–≤–∏—Ç—å –ø–ª–∞–≥–∏–Ω").
2. –ü–æ—Å–ª–µ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∏ Lampa –ø–æ—è–≤–∏—Ç—Å—è –ø—É–Ω–∫—Ç –º–µ–Ω—é "Ultimate Modular".

# –û—Å–Ω–æ–≤–Ω—ã–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏
- –ú–æ–¥—É–ª—å–Ω–∞—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞: –≤—Å–µ —Ñ—É–Ω–∫—Ü–∏–∏ –º–æ–∂–Ω–æ –≤–∫–ª—é—á–∞—Ç—å/–≤—ã–∫–ª—é—á–∞—Ç—å –∏ –Ω–∞—Å—Ç—Ä–∞–∏–≤–∞—Ç—å.
- –ö–∞—Å—Ç–æ–º–Ω–æ–µ –º–µ–Ω—é —Å –≤–∫–ª–∞–¥–∫–∞–º–∏, drag&drop, –∞–¥–∞–ø—Ç–∏–≤–Ω–æ –¥–ª—è –¢–í, –ü–ö, —Å–º–∞—Ä—Ç—Ñ–æ–Ω–∞.
- –ü—Ä–æ—Ñ–∏–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –∏ —É—Å—Ç—Ä–æ–π—Å—Ç–≤, —ç–∫—Å–ø–æ—Ä—Ç/–∏–º–ø–æ—Ä—Ç, –æ–±–ª–∞—á–Ω–æ–µ –∏ –ª–æ–∫–∞–ª—å–Ω–æ–µ —Ö—Ä–∞–Ω–µ–Ω–∏–µ.
- –ö–æ–ª–ª–µ–∫—Ü–∏–∏, –∏–∑–±—Ä–∞–Ω–Ω–æ–µ, –±—ã—Å—Ç—Ä—ã–µ –¥–µ–π—Å—Ç–≤–∏—è –Ω–∞ –∫–∞—Ä—Ç–æ—á–∫–∞—Ö.
- –ë–µ–π–¥–∂–∏ –∫–∞—á–µ—Å—Ç–≤–∞ –∏ —Å–µ—Ä–∏–π, –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–µ –ª–æ–≥–æ—Ç–∏–ø—ã, —Ä–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–µ —Ñ–∏–ª—å—Ç—Ä—ã –∏ –±—ã—Å—Ç—Ä—ã–π –ø–æ–∏—Å–∫.
- –ê–Ω–∞–ª–∏—Ç–∏–∫–∞ –ø—Ä–æ—Å–º–æ—Ç—Ä–æ–≤, —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏, —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è, –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å Telegram-–±–æ—Ç–æ–º.
- –¢–µ–º—ã –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏—è, –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ —Ä–∞–∑–º–µ—Ä–æ–≤, —Å—Ç–∏–ª–µ–π –∫–Ω–æ–ø–æ–∫ –∏ –∏–∫–æ–Ω–æ–∫.
- VPN Checker —Å –Ω–µ—Å–∫–æ–ª—å–∫–∏–º–∏ API –∏ –≤–∏–∑—É–∞–ª—å–Ω—ã–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä–æ–º.
- –í—Å–µ —Ñ—É–Ω–∫—Ü–∏–∏ —Ä–∞–±–æ—Ç–∞—é—Ç –±—ã—Å—Ç—Ä–æ, –Ω–µ –Ω–∞–≥—Ä—É–∂–∞—é—Ç –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å.

# –ù–∞—Å—Ç—Ä–æ–π–∫–∞ Telegram-–±–æ—Ç–∞
1. –ü–æ–ª—É—á–∏—Ç–µ —Ç–æ–∫–µ–Ω —É @BotFather –∏ –≤—Å—Ç–∞–≤—å—Ç–µ –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ Telegram –≤ –º–µ–Ω—é –ø–ª–∞–≥–∏–Ω–∞.
2. –£–∑–Ω–∞–π—Ç–µ chat_id —á–µ—Ä–µ–∑ @userinfobot –∏–ª–∏ API –∏ –≤—Å—Ç–∞–≤—å—Ç–µ –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏.
3. –î–ª—è –ø–æ–¥–¥–µ—Ä–∂–∫–∏/–Ω–æ–≤–æ—Å—Ç–µ–π —É–∫–∞–∂–∏—Ç–µ —Å—Å—ã–ª–∫—É –Ω–∞ –∫–∞–Ω–∞–ª/—á–∞—Ç.

# –ö–∞—Å—Ç–æ–º–Ω—ã–µ –∏–∫–æ–Ω–∫–∏
- –î–æ–±–∞–≤—å—Ç–µ SVG/PNG –≤ –æ–±—ä–µ–∫—Ç `LampaUltimate.icons` (—Å–º. –ø—Ä–∏–º–µ—Ä –≤ –∫–æ–¥–µ).
- –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Å–≤–æ–∏ –∏–∫–æ–Ω–∫–∏ –≤ –º–µ–Ω—é –∏ UI.

# FAQ
- –í—Å–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –∏ –∫–æ–ª–ª–µ–∫—Ü–∏–∏ —Ö—Ä–∞–Ω—è—Ç—Å—è –≤ localStorage (–∏ –º–æ–≥—É—Ç —ç–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å—Å—è).
- –î–ª—è —Å–±—Ä–æ—Å–∞ –Ω–∞—Å—Ç—Ä–æ–µ–∫ ‚Äî —É–¥–∞–ª–∏—Ç–µ –∫–ª—é—á–∏ `lampa_ultimate_settings` –∏ `lampa_ultimate_profiles` –∏–∑ localStorage.
- –î–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –ø–ª–∞–≥–∏–Ω–∞ ‚Äî –ø—Ä–æ—Å—Ç–æ –∑–∞–º–µ–Ω–∏—Ç–µ —Ñ–∞–π–ª –Ω–∞ –Ω–æ–≤—É—é –≤–µ—Ä—Å–∏—é.

# –ü–æ–¥–¥–µ—Ä–∂–∫–∞ –∏ –∫–æ–Ω—Ç–∞–∫—Ç—ã
- Telegram: https://t.me/your_channel_or_chat
- GitHub: https://github.com/your-repo (–∑–∞–º–µ–Ω–∏—Ç–µ –Ω–∞ —Å–≤–æ–π)
- –í–æ–ø—Ä–æ—Å—ã –∏ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è ‚Äî –ø–∏—à–∏—Ç–µ –≤ Telegram –∏–ª–∏ —Å–æ–∑–¥–∞–π—Ç–µ issue –Ω–∞ GitHub.

---

*/

// Lampa Ultimate Modular Plugin
(function () {
    'use strict';

    // –ì–ª–æ–±–∞–ª—å–Ω—ã–π –æ–±—ä–µ–∫—Ç –ø–ª–∞–≥–∏–Ω–∞
    const LampaUltimate = {
        version: '1.0.0',
        modules: {}, // –ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –º–æ–¥—É–ª–∏
        settings: {}, // –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
        profiles: {}, // –ü—Ä–æ—Ñ–∏–ª–∏ –Ω–∞—Å—Ç—Ä–æ–µ–∫
        activeProfile: 'default',
        // –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –º–æ–¥—É–ª—è
        registerModule(name, module) {
            this.modules[name] = module;
        },
        // –ü–æ–ª—É—á–∏—Ç—å –∞–∫—Ç–∏–≤–Ω—ã–µ –º–æ–¥—É–ª–∏
        getActiveModules() {
            return Object.values(this.modules).filter(m => m.enabled);
        },
        // –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
        saveSettings() {
            localStorage.setItem('lampa_ultimate_settings', JSON.stringify(this.settings));
        },
        // –ó–∞–≥—Ä—É–∑–∏—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
        loadSettings() {
            const s = localStorage.getItem('lampa_ultimate_settings');
            if (s) this.settings = JSON.parse(s);
        },
        // –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –ø—Ä–æ—Ñ–∏–ª—å
        saveProfile(name) {
            this.profiles[name] = JSON.parse(JSON.stringify(this.settings));
            localStorage.setItem('lampa_ultimate_profiles', JSON.stringify(this.profiles));
        },
        // –ó–∞–≥—Ä—É–∑–∏—Ç—å –ø—Ä–æ—Ñ–∏–ª—å
        loadProfile(name) {
            if (this.profiles[name]) {
                this.settings = JSON.parse(JSON.stringify(this.profiles[name]));
                this.activeProfile = name;
                this.saveSettings();
            }
        },
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
        init() {
            this.loadSettings();
            this.loadProfiles();
            this.renderMenu();
            // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –º–æ–¥—É–ª–µ–π
            Object.values(this.modules).forEach(m => m.init && m.init());
        },
        // –ó–∞–≥—Ä—É–∑–∏—Ç—å –ø—Ä–æ—Ñ–∏–ª–∏
        loadProfiles() {
            const p = localStorage.getItem('lampa_ultimate_profiles');
            if (p) this.profiles = JSON.parse(p);
        },
        // –†–µ–Ω–¥–µ—Ä –º–µ–Ω—é –Ω–∞—Å—Ç—Ä–æ–µ–∫
        renderMenu() {
            // TODO: –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å –∫—Ä–∞—Å–∏–≤–æ–µ –∞–¥–∞–ø—Ç–∏–≤–Ω–æ–µ –º–µ–Ω—é —Å –≤–∫–ª–∞–¥–∫–∞–º–∏, drag&drop, –ø—Ä–æ—Ñ–∏–ª—è–º–∏ –∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞–º–∏ –º–æ–¥—É–ª–µ–π
            // –ü–æ–∫–∞ —á—Ç–æ –ø—Ä–æ—Å—Ç–∞—è –∑–∞–≥–ª—É—à–∫–∞
            if (window.Lampa && Lampa.SettingsApi) {
                Lampa.SettingsApi.addComponent({
                    component: 'lampa_ultimate',
                    name: 'Ultimate Modular',
                    icon: '<svg width="24" height="24" viewBox="0 0 24 24"><circle cx="12" cy="12" r="10" fill="#00dbde"/><text x="12" y="17" text-anchor="middle" font-size="10" fill="#fff">ULT</text></svg>'
                });
                Lampa.SettingsApi.addParam({
                    component: 'lampa_ultimate',
                    param: {
                        name: 'open_menu',
                        type: 'trigger',
                        default: false
                    },
                    field: {
                        name: '–û—Ç–∫—Ä—ã—Ç—å –º–µ–Ω—é Ultimate',
                        description: '–ù–∞—Å—Ç—Ä–æ–π—Ç–µ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å, –º–æ–¥—É–ª–∏, –ø—Ä–æ—Ñ–∏–ª–∏ –∏ –≤–Ω–µ—à–Ω–∏–π –≤–∏–¥'
                    },
                    onChange: () => {
                        // TODO: –û—Ç–∫—Ä—ã—Ç—å –∫–∞—Å—Ç–æ–º–Ω–æ–µ –º–µ–Ω—é –ø–ª–∞–≥–∏–Ω–∞
                        alert('Ultimate Modular: –º–µ–Ω—é –≤ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ!');
                    }
                });
            }
        }
    };

    // --- UI: –ë–∞–∑–æ–≤—ã–π —Ä–µ–Ω–¥–µ—Ä –º–µ–Ω—é —Å –≤–∫–ª–∞–¥–∫–∞–º–∏ –∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞–º–∏ –º–æ–¥—É–ª–µ–π ---
    LampaUltimate.renderCustomMenu = function() {
        // –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä–æ–µ –º–µ–Ω—é, –µ—Å–ª–∏ –æ–Ω–æ –µ—Å—Ç—å
        let old = document.getElementById('lampa-ultimate-menu');
        if (old) old.remove();

        // –°–æ–∑–¥–∞—ë–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –º–µ–Ω—é
        let menu = document.createElement('div');
        menu.id = 'lampa-ultimate-menu';
        menu.style = 'position:fixed;top:0;left:0;width:100vw;height:100vh;z-index:99999;background:rgba(10,10,30,0.98);color:#fff;overflow:auto;padding:0;margin:0;font-family:sans-serif;';

        // –ó–∞–≥–æ–ª–æ–≤–æ–∫ –∏ –∫–Ω–æ–ø–∫–∞ –∑–∞–∫—Ä—ã—Ç–∏—è
        let header = document.createElement('div');
        header.style = 'display:flex;align-items:center;justify-content:space-between;padding:20px 30px 10px 30px;font-size:2em;font-weight:bold;';
        header.innerHTML = '<span>Ultimate Modular</span>' +
            '<button id="lampa-ultimate-close" style="font-size:1.5em;background:none;border:none;color:#fff;cursor:pointer;">√ó</button>';
        menu.appendChild(header);

        // –í–∫–ª–∞–¥–∫–∏
        let tabs = [
            {id:'main', label:'–ì–ª–∞–≤–Ω–æ–µ'},
            {id:'modules', label:'–ú–æ–¥—É–ª–∏'},
            {id:'profiles', label:'–ü—Ä–æ—Ñ–∏–ª–∏'},
            {id:'appearance', label:'–í–Ω–µ—à–Ω–∏–π –≤–∏–¥'},
            {id:'analytics', label:'–ê–Ω–∞–ª–∏—Ç–∏–∫–∞'},
            {id:'experiments', label:'–≠–∫—Å–ø–µ—Ä–∏–º–µ–Ω—Ç—ã'}
        ];
        let tabsBar = document.createElement('div');
        tabsBar.style = 'display:flex;gap:20px;padding:0 30px 10px 30px;border-bottom:1px solid #333;';
        tabsBar.id = 'lampa-ultimate-tabs';
        tabs.forEach(tab => {
            let btn = document.createElement('button');
            btn.textContent = tab.label;
            btn.dataset.tab = tab.id;
            btn.style = 'background:none;border:none;color:#fff;font-size:1.1em;padding:10px 0 8px 0;cursor:pointer;';
            btn.onclick = () => renderTab(tab.id);
            tabsBar.appendChild(btn);
        });
        menu.appendChild(tabsBar);

        // –ö–æ–Ω—Ç–µ–Ω—Ç –≤–∫–ª–∞–¥–∫–∏
        let content = document.createElement('div');
        content.id = 'lampa-ultimate-content';
        content.style = 'padding:20px 30px;min-height:60vh;';
        menu.appendChild(content);

        // –î–æ–±–∞–≤–ª—è–µ–º –º–µ–Ω—é –≤ body
        document.body.appendChild(menu);

        // –ó–∞–∫—Ä—ã—Ç–∏–µ –º–µ–Ω—é
        document.getElementById('lampa-ultimate-close').onclick = () => menu.remove();

        // –†–µ–Ω–¥–µ—Ä –ø–µ—Ä–≤–æ–π –≤–∫–ª–∞–¥–∫–∏
        renderTab('main');

        // --- –í–Ω—É—Ç—Ä–µ–Ω–Ω—è—è —Ñ—É–Ω–∫—Ü–∏—è —Ä–µ–Ω–¥–µ—Ä–∞ –≤–∫–ª–∞–¥–∫–∏ ---
        function renderTab(tabId) {
            // –°–±—Ä–æ—Å –∞–∫—Ç–∏–≤–Ω–æ–π –≤–∫–ª–∞–¥–∫–∏
            Array.from(tabsBar.children).forEach(btn => btn.style.borderBottom = 'none');
            let activeBtn = Array.from(tabsBar.children).find(btn => btn.dataset.tab === tabId);
            if (activeBtn) activeBtn.style.borderBottom = '2px solid #00dbde';
            // –ö–æ–Ω—Ç–µ–Ω—Ç
            if (tabId === 'main') {
                content.innerHTML = `<h2>Ultimate Modular –¥–ª—è Lampa</h2>
                <p>–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å! –ó–¥–µ—Å—å –≤—ã –º–æ–∂–µ—Ç–µ –≥–∏–±–∫–æ –Ω–∞—Å—Ç—Ä–∞–∏–≤–∞—Ç—å –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å, –º–æ–¥—É–ª–∏, –ø—Ä–æ—Ñ–∏–ª–∏ –∏ –≤–Ω–µ—à–Ω–∏–π –≤–∏–¥ Lampa.</p>
                <ul>
                  <li>–í–∫–ª—é—á–∞–π—Ç–µ –∏ –≤—ã–∫–ª—é—á–∞–π—Ç–µ –º–æ–¥—É–ª–∏</li>
                  <li>–ú–µ–Ω—è–π—Ç–µ –ø–æ—Ä—è–¥–æ–∫ –∏ –≤–Ω–µ—à–Ω–∏–π –≤–∏–¥</li>
                  <li>–°–æ—Ö—Ä–∞–Ω—è–π—Ç–µ –ø—Ä–æ—Ñ–∏–ª–∏ –Ω–∞—Å—Ç—Ä–æ–µ–∫</li>
                  <li>–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –±—ã—Å—Ç—Ä—ã–µ —Ñ–∏–ª—å—Ç—Ä—ã –∏ –∞–Ω–∞–ª–∏—Ç–∏–∫—É</li>
                </ul>`;
            } else if (tabId === 'modules') {
                // –°–ø–∏—Å–æ–∫ –º–æ–¥—É–ª–µ–π —Å –ø–µ—Ä–µ–∫–ª—é—á–∞—Ç–µ–ª—è–º–∏
                let html = '<h3>–ú–æ–¥—É–ª–∏</h3><ul style="list-style:none;padding:0;">';
                Object.entries(LampaUltimate.modules).forEach(([key, mod]) => {
                    html += `<li style="margin-bottom:10px;">
                        <label style="display:flex;align-items:center;gap:10px;">
                            <input type="checkbox" data-mod="${key}" ${mod.enabled ? 'checked' : ''} style="width:20px;height:20px;">
                            <span style="font-size:1.1em;">${mod.name}</span>
                        </label>
                    </li>`;
                });
                html += '</ul>';
                content.innerHTML = html;
                // –ü–µ—Ä–µ–∫–ª—é—á–∞—Ç–µ–ª–∏ –º–æ–¥—É–ª–µ–π
                content.querySelectorAll('input[type=checkbox][data-mod]').forEach(chk => {
                    chk.onchange = function() {
                        let mod = chk.dataset.mod;
                        LampaUltimate.modules[mod].enabled = chk.checked;
                        LampaUltimate.saveSettings();
                    };
                });
            } else if (tabId === 'profiles') {
                // –ü—Ä–æ—Ñ–∏–ª–∏: —Å–ø–∏—Å–æ–∫, –≤—ã–±–æ—Ä, —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ, –∑–∞–≥—Ä—É–∑–∫–∞
                let html = `<h3>–ü—Ä–æ—Ñ–∏–ª–∏</h3>
                <div>–¢–µ–∫—É—â–∏–π –ø—Ä–æ—Ñ–∏–ª—å: <b>${LampaUltimate.activeProfile}</b></div>
                <button id="lampa-ultimate-save-profile" style="margin:10px 0;">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å —Ç–µ–∫—É—â–∏–π –ø—Ä–æ—Ñ–∏–ª—å</button>
                <ul style="list-style:none;padding:0;">`;
                Object.keys(LampaUltimate.profiles).forEach(name => {
                    html += `<li style="margin-bottom:8px;">
                        <button data-profile="${name}" style="margin-right:10px;">–ó–∞–≥—Ä—É–∑–∏—Ç—å</button>
                        <span>${name}</span>
                    </li>`;
                });
                html += '</ul>';
                content.innerHTML = html;
                // –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –ø—Ä–æ—Ñ–∏–ª—å
                content.querySelector('#lampa-ultimate-save-profile').onclick = function() {
                    let name = prompt('–í–≤–µ–¥–∏—Ç–µ –∏–º—è –ø—Ä–æ—Ñ–∏–ª—è:');
                    if (name) {
                        LampaUltimate.saveProfile(name);
                        renderTab('profiles');
                    }
                };
                // –ó–∞–≥—Ä—É–∑–∏—Ç—å –ø—Ä–æ—Ñ–∏–ª—å
                content.querySelectorAll('button[data-profile]').forEach(btn => {
                    btn.onclick = function() {
                        let name = btn.dataset.profile;
                        LampaUltimate.loadProfile(name);
                        renderTab('profiles');
                    };
                });
            } else if (tabId === 'appearance') {
                content.innerHTML = `<h3>–í–Ω–µ—à–Ω–∏–π –≤–∏–¥</h3>
                <p>–ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Ç–µ–º, —Ä–∞–∑–º–µ—Ä–æ–≤, —Å—Ç–∏–ª—è –∫–Ω–æ–ø–æ–∫ –∏ –∏–∫–æ–Ω–æ–∫ –ø–æ—è–≤—è—Ç—Å—è –∑–¥–µ—Å—å.</p>`;
            } else if (tabId === 'analytics') {
                content.innerHTML = `<h3>–ê–Ω–∞–ª–∏—Ç–∏–∫–∞</h3>
                <p>–ó–¥–µ—Å—å –±—É–¥–µ—Ç —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ –ø—Ä–æ—Å–º–æ—Ç—Ä–∞–º, –∂–∞–Ω—Ä–∞–º, –≤—Ä–µ–º–µ–Ω–∏ –∏ —Ç.–¥.</p>`;
            } else if (tabId === 'experiments') {
                content.innerHTML = `<h3>–≠–∫—Å–ø–µ—Ä–∏–º–µ–Ω—Ç—ã</h3>
                <p>–í–∫–ª—é—á–∞–π—Ç–µ –Ω–æ–≤—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ –¥–ª—è —Ç–µ—Å—Ç–∞!</p>`;
            }
        }
    };

    // --- –ü–µ—Ä–µ–æ–ø—Ä–µ–¥–µ–ª—è–µ–º onChange –¥–ª—è –∫–Ω–æ–ø–∫–∏ –º–µ–Ω—é ---
    LampaUltimate.renderMenu = function() {
        if (window.Lampa && Lampa.SettingsApi) {
            Lampa.SettingsApi.addComponent({
                component: 'lampa_ultimate',
                name: 'Ultimate Modular',
                icon: '<svg width="24" height="24" viewBox="0 0 24 24"><circle cx="12" cy="12" r="10" fill="#00dbde"/><text x="12" y="17" text-anchor="middle" font-size="10" fill="#fff">ULT</text></svg>'
            });
            Lampa.SettingsApi.addParam({
                component: 'lampa_ultimate',
                param: {
                    name: 'open_menu',
                    type: 'trigger',
                    default: false
                },
                field: {
                    name: '–û—Ç–∫—Ä—ã—Ç—å –º–µ–Ω—é Ultimate',
                    description: '–ù–∞—Å—Ç—Ä–æ–π—Ç–µ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å, –º–æ–¥—É–ª–∏, –ø—Ä–æ—Ñ–∏–ª–∏ –∏ –≤–Ω–µ—à–Ω–∏–π –≤–∏–¥'
                },
                onChange: () => {
                    LampaUltimate.renderCustomMenu();
                }
            });
        }
    };

    // --- –ú–æ–¥—É–ª—å "–ë–µ–π–¥–∂–∏ –∫–∞—á–µ—Å—Ç–≤–∞ –∏ —Å–µ—Ä–∏–π" ---
    LampaUltimate.modules.badges = {
        enabled: true,
        style: 'color', // color | minimal | icon
        show: 'both',   // quality | episodes | both | none
        init() {
            LampaUltimate.settings.badges = LampaUltimate.settings.badges || { enabled: true, style: 'color', show: 'both' };
            this.enabled = LampaUltimate.settings.badges.enabled;
            this.style = LampaUltimate.settings.badges.style;
            this.show = LampaUltimate.settings.badges.show;
            // –ü–∞—Ç—á–∏–º —Ä–µ–Ω–¥–µ—Ä –∫–∞—Ä—Ç–æ—á–µ–∫ –¥–ª—è –≤—Å–µ—Ö –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤
            const origRender = window.Lampa && Lampa.Card && Lampa.Card.render;
            if (origRender && !Lampa.Card._ultimateBadgesPatched) {
                Lampa.Card.render = function(cardData, ...args) {
                    let el = origRender.call(this, cardData, ...args);
                    setTimeout(() => {
                        try {
                            if (!el) return;
                            el.querySelectorAll('.ultimate-badge').forEach(b => b.remove());
                            let quality = cardData.quality || cardData.Quality || '';
                            let episodes = '';
                            if (cardData.number_of_episodes && cardData.number_of_seasons) {
                                episodes = `${cardData.number_of_episodes}/${cardData.number_of_seasons}`;
                            } else if (cardData.episodes) {
                                episodes = cardData.episodes;
                            }
                            if (LampaUltimate.modules.badges.enabled && LampaUltimate.modules.badges.show !== 'none') {
                                if ((LampaUltimate.modules.badges.show === 'quality' || LampaUltimate.modules.badges.show === 'both') && quality) {
                                    let badge = document.createElement('div');
                                    badge.className = 'ultimate-badge ultimate-badge-quality';
                                    badge.style = badgeStyle(LampaUltimate.modules.badges.style, 'quality');
                                    badge.textContent = quality;
                                    el.appendChild(badge);
                                }
                                if ((LampaUltimate.modules.badges.show === 'episodes' || LampaUltimate.modules.badges.show === 'both') && episodes) {
                                    let badge = document.createElement('div');
                                    badge.className = 'ultimate-badge ultimate-badge-episodes';
                                    badge.style = badgeStyle(LampaUltimate.modules.badges.style, 'episodes');
                                    badge.textContent = episodes;
                                    el.appendChild(badge);
                                }
                            }
                        } catch(e) {}
                    }, 0);
                    return el;
                };
                Lampa.Card._ultimateBadgesPatched = true;
            }
            function badgeStyle(style, type) {
                if (style === 'color') {
                    return `position:absolute;top:${type==='quality'?8:36}px;right:8px;background:linear-gradient(90deg,#00dbde,#fc00ff);color:#fff;padding:2px 8px;border-radius:8px;font-size:1em;font-weight:bold;z-index:10;`;
                } else if (style === 'minimal') {
                    return `position:absolute;top:${type==='quality'?8:36}px;right:8px;background:#222;color:#fff;padding:2px 8px;border-radius:8px;font-size:1em;z-index:10;`;
                } else if (style === 'icon') {
                    return `position:absolute;top:${type==='quality'?8:36}px;right:8px;background:#fff;color:#00dbde;padding:2px 8px;border-radius:8px;font-size:1em;z-index:10;display:flex;align-items:center;gap:4px;`;
                }
                return '';
            }
        }
    };

    // --- –ú–æ–¥—É–ª—å "–û—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–µ –ª–æ–≥–æ—Ç–∏–ø—ã" ---
    LampaUltimate.modules.logos = {
        enabled: true,
        style: 'color', // color | mono | outline
        fallback: 'poster', // poster | title
        cache: {},
        init() {
            LampaUltimate.settings.logos = LampaUltimate.settings.logos || { enabled: true, style: 'color', fallback: 'poster' };
            this.enabled = LampaUltimate.settings.logos.enabled;
            this.style = LampaUltimate.settings.logos.style;
            this.fallback = LampaUltimate.settings.logos.fallback;
            this.cache = {};
            // –ü–∞—Ç—á–∏–º —Ä–µ–Ω–¥–µ—Ä –∫–∞—Ä—Ç–æ—á–µ–∫ –¥–ª—è –ª–æ–≥–æ—Ç–∏–ø–æ–≤
            const origRender = window.Lampa && Lampa.Card && Lampa.Card.render;
            if (origRender && !Lampa.Card._ultimateLogoPatched) {
                Lampa.Card.render = function(cardData, ...args) {
                    let el = origRender.call(this, cardData, ...args);
                    setTimeout(() => {
                        try {
                            if (!el) return;
                            el.querySelectorAll('.ultimate-logo').forEach(b => b.remove());
                            let logoUrl = '';
                            if (cardData.logo_path) {
                                logoUrl = getLogoUrl(cardData.logo_path);
                            } else if (cardData.logos && cardData.logos.length) {
                                logoUrl = getLogoUrl(cardData.logos[0]);
                            }
                            if (LampaUltimate.modules.logos.enabled && logoUrl) {
                                let img = document.createElement('img');
                                img.className = 'ultimate-logo';
                                img.src = logoUrl;
                                img.alt = 'logo';
                                img.style = logoStyle(LampaUltimate.modules.logos.style);
                                img.onload = () => img.style.opacity = 1;
                                img.onerror = () => img.remove();
                                el.appendChild(img);
                                LampaUltimate.modules.logos.cache[logoUrl] = true;
                            } else if (LampaUltimate.modules.logos.enabled) {
                                if (LampaUltimate.modules.logos.fallback === 'poster' && cardData.poster_path) {
                                    // –£–∂–µ –µ—Å—Ç—å –ø–æ—Å—Ç–µ—Ä ‚Äî –Ω–∏—á–µ–≥–æ –Ω–µ –¥–µ–ª–∞–µ–º
                                } else if (LampaUltimate.modules.logos.fallback === 'title' && cardData.title) {
                                    let div = document.createElement('div');
                                    div.className = 'ultimate-logo';
                                    div.textContent = cardData.title;
                                    div.style = logoStyle(LampaUltimate.modules.logos.style) + 'font-size:1.2em;font-weight:bold;letter-spacing:1px;';
                                    el.appendChild(div);
                                }
                            }
                        } catch(e) {}
                    }, 0);
                    return el;
                };
                Lampa.Card._ultimateLogoPatched = true;
            }
            function getLogoUrl(path) {
                if (!path) return '';
                if (/^https?:/.test(path)) return path;
                return 'https://image.tmdb.org/t/p/original' + path;
            }
            function logoStyle(style) {
                let base = 'position:absolute;left:50%;top:50%;transform:translate(-50%,-50%);max-width:70%;max-height:40%;opacity:0.95;z-index:12;pointer-events:none;transition:opacity 0.2s;';
                if (style === 'color') return base + '';
                if (style === 'mono') return base + 'filter: grayscale(1) contrast(1.5);';
                if (style === 'outline') return base + 'filter: grayscale(1) brightness(2) drop-shadow(0 0 2px #fff);';
                return base;
            }
        }
    };

    // --- –ú–æ–¥—É–ª—å "VPN Checker" ---
    LampaUltimate.modules.vpn = Object.assign(LampaUltimate.modules.vpn || {}, {
        mode: 'detailed', // detailed | short
        enabled: false,
        lastResult: null,
        lastCheck: 0,
        cacheTtl: 10 * 60 * 1000, // 10 –º–∏–Ω—É—Ç
        indicator: null,
        init() {
            LampaUltimate.settings.vpn = LampaUltimate.settings.vpn || {
                enabled: false,
                mode: 'detailed'
            };
            this.enabled = LampaUltimate.settings.vpn.enabled;
            this.mode = LampaUltimate.settings.vpn.mode;
            // –ï—Å–ª–∏ –≤–∫–ª—é—á–µ–Ω–æ ‚Äî –∑–∞–ø—É—Å–∫–∞–µ–º –ø—Ä–æ–≤–µ—Ä–∫—É
            if (this.enabled) this.checkAndRender();
        },
        checkAndRender(force) {
            if (!this.enabled) return this.removeIndicator();
            let now = Date.now();
            if (!force && this.lastResult && (now - this.lastCheck < this.cacheTtl)) {
                this.renderIndicator(this.lastResult);
                return;
            }
            this.renderIndicator({status:'loading'});
            this.checkVPN().then(res => {
                this.lastResult = res;
                this.lastCheck = Date.now();
                this.renderIndicator(res);
            }).catch(() => {
                this.renderIndicator({status:'error'});
            });
        },
        async checkVPN() {
            // –ü—Ä–æ–±—É–µ–º –Ω–µ—Å–∫–æ–ª—å–∫–æ API –ø–æ –æ—á–µ—Ä–µ–¥–∏
            let apis = [
                async () => {
                    let r = await fetch('https://ip-api.io/json/');
                    let d = await r.json();
                    return {
                        status: d.security && (d.security.is_vpn || d.security.is_proxy || d.security.is_tor) ? 'vpn' : 'ok',
                        country: d.country_name,
                        city: d.city,
                        asn: d.asn,
                        org: d.org,
                        ip: d.ip,
                        details: d.security
                    };
                },
                async () => {
                    let r = await fetch('https://ipinfo.io/json');
                    let d = await r.json();
                    return {
                        status: d.privacy && (d.privacy.vpn || d.privacy.proxy || d.privacy.tor) ? 'vpn' : 'ok',
                        country: d.country,
                        city: d.city,
                        asn: d.org,
                        org: d.org,
                        ip: d.ip,
                        details: d.privacy
                    };
                },
                async () => {
                    let r = await fetch('https://vpnapi.io/api/?ip=&key=free');
                    let d = await r.json();
                    return {
                        status: d.security && (d.security.vpn || d.security.proxy || d.security.tor) ? 'vpn' : 'ok',
                        country: d.location && d.location.country,
                        city: d.location && d.location.city,
                        asn: d.network && d.network.autonomous_system_number,
                        org: d.network && d.network.organization,
                        ip: d.ip,
                        details: d.security
                    };
                }
            ];
            for (let api of apis) {
                try {
                    let res = await api();
                    if (res && res.status) return res;
                } catch(e) {}
            }
            return {status:'error'};
        },
        renderIndicator(res) {
            this.removeIndicator();
            let ind = document.createElement('div');
            ind.id = 'lampa-ultimate-vpn-indicator';
            ind.style = 'position:fixed;bottom:24px;right:24px;z-index:999999;background:rgba(20,20,40,0.95);color:#fff;padding:12px 20px;border-radius:16px;box-shadow:0 2px 12px #0008;font-size:1.1em;display:flex;align-items:center;gap:12px;cursor:pointer;user-select:none;transition:opacity 0.2s;';
            let icon = '';
            let color = '#00dbde';
            if (res.status === 'loading') {
                icon = '‚è≥';
                color = '#aaa';
            } else if (res.status === 'ok') {
                icon = 'üü¢';
                color = '#00dbde';
            } else if (res.status === 'vpn') {
                icon = 'üî¥';
                color = '#fc00ff';
            } else {
                icon = '‚ö†Ô∏è';
                color = '#ffb300';
            }
            ind.innerHTML = `<span style="font-size:1.5em;">${icon}</span><span>${this.mode==='detailed'?this.statusText(res):this.shortText(res)}</span>`;
            ind.style.border = `2px solid ${color}`;
            // –ö–ª–∏–∫ ‚Äî –ø–æ–∫–∞–∑–∞—Ç—å –ø–æ–¥—Ä–æ–±–Ω–æ—Å—Ç–∏
            ind.onclick = () => {
                if (this.mode === 'detailed' && res.status && res.status !== 'loading') {
                    alert(this.detailedInfo(res));
                } else {
                    this.checkAndRender(true);
                }
            };
            document.body.appendChild(ind);
            this.indicator = ind;
        },
        removeIndicator() {
            if (this.indicator) this.indicator.remove();
            this.indicator = null;
        },
        statusText(res) {
            if (res.status === 'loading') return '–ü—Ä–æ–≤–µ—Ä–∫–∞ VPN...';
            if (res.status === 'ok') return 'VPN –Ω–µ –æ–±–Ω–∞—Ä—É–∂–µ–Ω';
            if (res.status === 'vpn') return '–û–±–Ω–∞—Ä—É–∂–µ–Ω VPN/Proxy/TOR!';
            return '–û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ VPN';
        },
        shortText(res) {
            if (res.status === 'loading') return '–ü—Ä–æ–≤–µ—Ä–∫–∞...';
            if (res.status === 'ok') return 'VPN: –Ω–µ—Ç';
            if (res.status === 'vpn') return 'VPN: –¥–∞!';
            return 'VPN: ?';
        },
        detailedInfo(res) {
            if (!res || !res.status) return '–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö';
            return `IP: ${res.ip||'-'}\n–°—Ç—Ä–∞–Ω–∞: ${res.country||'-'}\n–ì–æ—Ä–æ–¥: ${res.city||'-'}\n–ü—Ä–æ–≤–∞–π–¥–µ—Ä: ${res.org||'-'}\nASN: ${res.asn||'-'}\nVPN/Proxy/TOR: ${res.status==='vpn'?'–î–ê':'–Ω–µ—Ç'}\n\n${res.details?JSON.stringify(res.details,null,2):''}`;
        }
    };

    // --- –ú–æ–¥—É–ª—å "–°–∫—Ä—ã—Ç–∏–µ –ø—Ä–æ—Å–º–æ—Ç—Ä–µ–Ω–Ω—ã—Ö" –∏ –±—ã—Å—Ç—Ä—ã–µ —Ñ–∏–ª—å—Ç—Ä—ã ---
    LampaUltimate.modules.hideWatched = {
        enabled: false,
        onlyNew: false,
        init() {
            LampaUltimate.settings.hideWatched = LampaUltimate.settings.hideWatched || { enabled: false, onlyNew: false };
            this.enabled = LampaUltimate.settings.hideWatched.enabled;
            this.onlyNew = LampaUltimate.settings.hideWatched.onlyNew;
            // –ü–∞—Ç—á–∏–º —Ä–µ–Ω–¥–µ—Ä —Å–ø–∏—Å–∫–æ–≤
            const origRenderList = window.Lampa && Lampa.List && Lampa.List.render;
            if (origRenderList && !Lampa.List._ultimatePatched) {
                Lampa.List.render = function(items, ...args) {
                    let filtered = items;
                    if (LampaUltimate.modules.hideWatched.enabled) {
                        filtered = filtered.filter(card => !isWatched(card));
                    }
                    if (LampaUltimate.modules.hideWatched.onlyNew) {
                        filtered = filtered.filter(card => isNew(card));
                    }
                    return origRenderList.call(this, filtered, ...args);
                };
                Lampa.List._ultimatePatched = true;
            }
            // –ë—ã—Å—Ç—Ä—ã–π —Ñ–∏–ª—å—Ç—Ä –Ω–∞ –≥–ª–∞–≤–Ω–æ–º —ç–∫—Ä–∞–Ω–µ
            setTimeout(() => {
                if (!document.getElementById('ultimate-filter-btn')) {
                    let btn = document.createElement('button');
                    btn.id = 'ultimate-filter-btn';
                    btn.textContent = this.onlyNew ? '–ü–æ–∫–∞–∑–∞—Ç—å –≤—Å–µ' : '–¢–æ–ª—å–∫–æ –Ω–æ–≤—ã–µ';
                    btn.style = 'position:fixed;top:24px;right:24px;z-index:999999;background:#00dbde;color:#fff;padding:10px 18px;border-radius:12px;font-size:1.1em;box-shadow:0 2px 12px #0008;cursor:pointer;user-select:none;';
                    btn.onclick = () => {
                        LampaUltimate.modules.hideWatched.onlyNew = !LampaUltimate.modules.hideWatched.onlyNew;
                        LampaUltimate.settings.hideWatched.onlyNew = LampaUltimate.modules.hideWatched.onlyNew;
                        btn.textContent = LampaUltimate.modules.hideWatched.onlyNew ? '–ü–æ–∫–∞–∑–∞—Ç—å –≤—Å–µ' : '–¢–æ–ª—å–∫–æ –Ω–æ–≤—ã–µ';
                        LampaUltimate.saveSettings();
                        let ev = new Event('ultimate-filter-update');
                        document.dispatchEvent(ev);
                    };
                    document.body.appendChild(btn);
                }
            }, 1000);
            function isWatched(card) {
                return card.watched === true || card.is_watched === true || card.progress === 1 || card.seen === true;
            }
            function isNew(card) {
                if (isWatched(card)) return false;
                if (card.release_date) {
                    let d = new Date(card.release_date);
                    let now = new Date();
                    return (now - d) < 30*24*60*60*1000;
                }
                return true;
            }
        }
    };

    // --- –ú–æ–¥—É–ª—å "–†–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–µ —Ñ–∏–ª—å—Ç—Ä—ã –∏ —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞" ---
    LampaUltimate.modules.filters = {
        enabled: true,
        name: '–§–∏–ª—å—Ç—Ä—ã –∏ —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞',
        filters: {
            quality: '',
            genre: '',
            country: '',
            year: '',
            source: '',
            watched: '', // all | watched | unwatched | new
        },
        sort: 'date', // date | popularity | alpha
        search: '',
        init() {
            LampaUltimate.settings.filters = LampaUltimate.settings.filters || {
                filters: { quality: '', genre: '', country: '', year: '', source: '', watched: '' },
                sort: 'date',
                search: ''
            };
            this.filters = Object.assign({}, LampaUltimate.settings.filters.filters);
            this.sort = LampaUltimate.settings.filters.sort;
            this.search = LampaUltimate.settings.filters.search;
            // –ü–∞—Ç—á–∏–º —Ä–µ–Ω–¥–µ—Ä —Å–ø–∏—Å–∫–æ–≤
            const origRenderList = window.Lampa && Lampa.List && Lampa.List.render;
            if (origRenderList && !Lampa.List._ultimateFilterPatched) {
                Lampa.List.render = function(items, ...args) {
                    let filtered = items;
                    let f = LampaUltimate.modules.filters.filters;
                    if (f.quality) filtered = filtered.filter(card => (card.quality||'').toLowerCase().includes(f.quality));
                    if (f.genre) filtered = filtered.filter(card => (card.genre_ids||[]).includes(f.genre) || (card.genres||[]).includes(f.genre));
                    if (f.country) filtered = filtered.filter(card => (card.country||'').toLowerCase().includes(f.country));
                    if (f.year) filtered = filtered.filter(card => (card.release_date||'').startsWith(f.year));
                    if (f.source) filtered = filtered.filter(card => (card.source||'').toLowerCase().includes(f.source));
                    if (f.watched === 'watched') filtered = filtered.filter(card => isWatched(card));
                    if (f.watched === 'unwatched') filtered = filtered.filter(card => !isWatched(card));
                    if (f.watched === 'new') filtered = filtered.filter(card => isNew(card));
                    let s = (LampaUltimate.modules.filters.search||'').toLowerCase();
                    if (s) filtered = filtered.filter(card => {
                        return (card.title||'').toLowerCase().includes(s) ||
                            (card.original_title||'').toLowerCase().includes(s) ||
                            (card.name||'').toLowerCase().includes(s) ||
                            (card.actors||'').toLowerCase().includes(s) ||
                            (card.genres||[]).join(',').toLowerCase().includes(s);
                    });
                    let sort = LampaUltimate.modules.filters.sort;
                    if (sort === 'date') filtered = filtered.sort((a,b) => (b.release_date||'').localeCompare(a.release_date||''));
                    if (sort === 'popularity') filtered = filtered.sort((a,b) => (b.popularity||0)-(a.popularity||0));
                    if (sort === 'alpha') filtered = filtered.sort((a,b) => (a.title||'').localeCompare(b.title||''));
                    return origRenderList.call(this, filtered, ...args);
                };
                Lampa.List._ultimateFilterPatched = true;
            }
            // –ë—ã—Å—Ç—Ä—ã–π UI-—Ñ–∏–ª—å—Ç—Ä –∏ –ø–æ–∏—Å–∫ –Ω–∞ –≥–ª–∞–≤–Ω–æ–º —ç–∫—Ä–∞–Ω–µ
            setTimeout(() => {
                if (!document.getElementById('ultimate-search-bar')) {
                    let bar = document.createElement('div');
                    bar.id = 'ultimate-search-bar';
                    bar.style = 'position:fixed;top:70px;left:50%;transform:translateX(-50%);z-index:999999;background:#222;color:#fff;padding:8px 18px;border-radius:12px;font-size:1.1em;box-shadow:0 2px 12px #0008;display:flex;gap:10px;align-items:center;';
                    bar.innerHTML = `
                        <input id="ultimate-search-input" type="text" placeholder="–ü–æ–∏—Å–∫..." style="font-size:1em;padding:4px 10px;border-radius:6px;border:none;outline:none;">
                        <select id="ultimate-sort-select">
                            <option value="date">–ü–æ –¥–∞—Ç–µ</option>
                            <option value="popularity">–ü–æ –ø–æ–ø—É–ª—è—Ä–Ω–æ—Å—Ç–∏</option>
                            <option value="alpha">–ü–æ –∞–ª—Ñ–∞–≤–∏—Ç—É</option>
                        </select>
                        <button id="ultimate-clear-search" style="background:#00dbde;color:#fff;border:none;border-radius:6px;padding:4px 10px;">√ó</button>
                    `;
                    document.body.appendChild(bar);
                    let input = bar.querySelector('#ultimate-search-input');
                    let sortSel = bar.querySelector('#ultimate-sort-select');
                    let clearBtn = bar.querySelector('#ultimate-clear-search');
                    input.value = LampaUltimate.modules.filters.search;
                    sortSel.value = LampaUltimate.modules.filters.sort;
                    input.oninput = function() {
                        LampaUltimate.modules.filters.search = input.value;
                        LampaUltimate.settings.filters.search = input.value;
                        LampaUltimate.saveSettings();
                        let ev = new Event('ultimate-filter-update');
                        document.dispatchEvent(ev);
                    };
                    sortSel.onchange = function() {
                        LampaUltimate.modules.filters.sort = sortSel.value;
                        LampaUltimate.settings.filters.sort = sortSel.value;
                        LampaUltimate.saveSettings();
                        let ev = new Event('ultimate-filter-update');
                        document.dispatchEvent(ev);
                    };
                    clearBtn.onclick = function() {
                        input.value = '';
                        LampaUltimate.modules.filters.search = '';
                        LampaUltimate.settings.filters.search = '';
                        LampaUltimate.saveSettings();
                        let ev = new Event('ultimate-filter-update');
                        document.dispatchEvent(ev);
                    };
                }
            }, 1000);
            function isWatched(card) {
                return card.watched === true || card.is_watched === true || card.progress === 1 || card.seen === true;
            }
            function isNew(card) {
                if (isWatched(card)) return false;
                if (card.release_date) {
                    let d = new Date(card.release_date);
                    let now = new Date();
                    return (now - d) < 30*24*60*60*1000;
                }
                return true;
            }
        }
    };

    // --- –ú–æ–¥—É–ª—å "–ò–∑–±—Ä–∞–Ω–Ω–æ–µ –∏ –∫–æ–ª–ª–µ–∫—Ü–∏–∏" ---
    LampaUltimate.modules.collections = {
        enabled: true,
        lists: {}, // {listName: [cardId, ...]}
        init() {
            // –ó–∞–≥—Ä—É–∑–∫–∞ –∫–æ–ª–ª–µ–∫—Ü–∏–π –∏–∑ localStorage
            let saved = localStorage.getItem('lampa_ultimate_collections');
            this.lists = saved ? JSON.parse(saved) : {
                '–°–º–æ—Ç—Ä–µ—Ç—å –ø–æ–∑–∂–µ': [],
                '–õ—é–±–∏–º—ã–µ': [],
                '–î–ª—è —Å–µ–º—å–∏': []
            };
            // –ü–∞—Ç—á–∏–º —Ä–µ–Ω–¥–µ—Ä –∫–∞—Ä—Ç–æ—á–µ–∫ –¥–ª—è –±—ã—Å—Ç—Ä—ã—Ö –¥–µ–π—Å—Ç–≤–∏–π
            const origRender = window.Lampa && Lampa.Card && Lampa.Card.render;
            if (origRender && !Lampa.Card._ultimateCollectionsPatched) {
                Lampa.Card.render = function(cardData, ...args) {
                    let el = origRender.call(this, cardData, ...args);
                    setTimeout(() => {
                        try {
                            if (!el) return;
                            el.querySelectorAll('.ultimate-collection-btn').forEach(b => b.remove());
                            Object.keys(LampaUltimate.modules.collections.lists).forEach(listName => {
                                let btn = document.createElement('button');
                                btn.className = 'ultimate-collection-btn';
                                btn.textContent = LampaUltimate.modules.collections.lists[listName].includes(cardData.id) ? `‚úî ${listName}` : `+ ${listName}`;
                                btn.style = 'position:absolute;bottom:8px;right:8px;background:#00dbde;color:#fff;border:none;border-radius:8px;padding:2px 8px;font-size:0.9em;margin-left:4px;z-index:20;cursor:pointer;opacity:0.9;';
                                btn.onclick = (e) => {
                                    e.stopPropagation();
                                    let lists = LampaUltimate.modules.collections.lists;
                                    let arr = lists[listName];
                                    if (!arr.includes(cardData.id)) arr.push(cardData.id);
                                    else lists[listName] = arr.filter(id => id !== cardData.id);
                                    localStorage.setItem('lampa_ultimate_collections', JSON.stringify(lists));
                                    btn.textContent = arr.includes(cardData.id) ? `‚úî ${listName}` : `+ ${listName}`;
                                };
                                el.appendChild(btn);
                            });
                        } catch(e) {}
                    }, 0);
                    return el;
                };
                Lampa.Card._ultimateCollectionsPatched = true;
            }
        },
        // –ü–æ–ª—É—á–∏—Ç—å —Å–ø–∏—Å–æ–∫ –∫–∞—Ä—Ç–æ—á–µ–∫ –ø–æ –∫–æ–ª–ª–µ–∫—Ü–∏–∏
        getCards(listName, allCards) {
            let ids = this.lists[listName] || [];
            return allCards.filter(card => ids.includes(card.id));
        },
        // –≠–∫—Å–ø–æ—Ä—Ç –∫–æ–ª–ª–µ–∫—Ü–∏–π (JSON)
        export() {
            return JSON.stringify(this.lists);
        },
        // –ò–º–ø–æ—Ä—Ç –∫–æ–ª–ª–µ–∫—Ü–∏–π (JSON)
        import(json) {
            try {
                let data = JSON.parse(json);
                if (typeof data === 'object') {
                    this.lists = data;
                    localStorage.setItem('lampa_ultimate_collections', JSON.stringify(this.lists));
                }
            } catch(e) {}
        },
        // –ì–µ–Ω–µ—Ä–∞—Ü–∏—è —Å—Å—ã–ª–∫–∏ (base64)
        exportLink() {
            return 'lampa-collections://' + btoa(this.export());
        },
        // –ò–º–ø–æ—Ä—Ç –∏–∑ —Å—Å—ã–ª–∫–∏
        importLink(link) {
            if (link.startsWith('lampa-collections://')) {
                let json = atob(link.replace('lampa-collections://',''));
                this.import(json);
            }
        }
    };

    // --- UI –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∫–æ–ª–ª–µ–∫—Ü–∏—è–º–∏ –≤–æ –≤–∫–ª–∞–¥–∫–µ '–ö–æ–ª–ª–µ–∫—Ü–∏–∏' ---
    LampaUltimate.renderCollectionsTab = function(content) {
        let html = `<h3>–ú–æ–∏ –∫–æ–ª–ª–µ–∫—Ü–∏–∏</h3><ul style="list-style:none;padding:0;">`;
        Object.keys(LampaUltimate.modules.collections.lists).forEach(listName => {
            html += `<li style="margin-bottom:10px;"><b>${listName}</b> <button data-list="${listName}" class="ultimate-collection-show">–ü–æ–∫–∞–∑–∞—Ç—å</button> <button data-list="${listName}" class="ultimate-collection-del">–£–¥–∞–ª–∏—Ç—å</button></li>`;
        });
        html += '</ul>';
        html += `<button id="ultimate-collection-add">–î–æ–±–∞–≤–∏—Ç—å –∫–æ–ª–ª–µ–∫—Ü–∏—é</button> <button id="ultimate-collection-export">–≠–∫—Å–ø–æ—Ä—Ç</button> <button id="ultimate-collection-import">–ò–º–ø–æ—Ä—Ç</button> <button id="ultimate-collection-share">–ü–æ–¥–µ–ª–∏—Ç—å—Å—è</button>`;
        content.innerHTML = html;
        // –ü–æ–∫–∞–∑–∞—Ç—å –∫–æ–ª–ª–µ–∫—Ü–∏—é (alert, –º–æ–∂–Ω–æ –¥–æ—Ä–∞–±–æ—Ç–∞—Ç—å –ø–æ–¥ –æ—Ç–¥–µ–ª—å–Ω—ã–π UI)
        content.querySelectorAll('.ultimate-collection-show').forEach(btn => {
            btn.onclick = function() {
                let name = btn.dataset.list;
                let ids = LampaUltimate.modules.collections.lists[name];
                alert(`–í –∫–æ–ª–ª–µ–∫—Ü–∏–∏ "${name}":\n` + ids.join(', '));
            };
        });
        // –£–¥–∞–ª–∏—Ç—å –∫–æ–ª–ª–µ–∫—Ü–∏—é
        content.querySelectorAll('.ultimate-collection-del').forEach(btn => {
            btn.onclick = function() {
                let name = btn.dataset.list;
                if (confirm('–£–¥–∞–ª–∏—Ç—å –∫–æ–ª–ª–µ–∫—Ü–∏—é ' + name + '?')) {
                    delete LampaUltimate.modules.collections.lists[name];
                    localStorage.setItem('lampa_ultimate_collections', JSON.stringify(LampaUltimate.modules.collections.lists));
                    LampaUltimate.renderCollectionsTab(content);
                }
            };
        });
        // –î–æ–±–∞–≤–∏—Ç—å –∫–æ–ª–ª–µ–∫—Ü–∏—é
        let addBtn = content.querySelector('#ultimate-collection-add');
        if (addBtn) addBtn.onclick = function() {
            let name = prompt('–ù–∞–∑–≤–∞–Ω–∏–µ –Ω–æ–≤–æ–π –∫–æ–ª–ª–µ–∫—Ü–∏–∏:');
            if (name && !LampaUltimate.modules.collections.lists[name]) {
                LampaUltimate.modules.collections.lists[name] = [];
                localStorage.setItem('lampa_ultimate_collections', JSON.stringify(LampaUltimate.modules.collections.lists));
                LampaUltimate.renderCollectionsTab(content);
            }
        };
        // –≠–∫—Å–ø–æ—Ä—Ç
        let exportBtn = content.querySelector('#ultimate-collection-export');
        if (exportBtn) exportBtn.onclick = function() {
            prompt('JSON –¥–ª—è —ç–∫—Å–ø–æ—Ä—Ç–∞:', LampaUltimate.modules.collections.export());
        };
        // –ò–º–ø–æ—Ä—Ç
        let importBtn = content.querySelector('#ultimate-collection-import');
        if (importBtn) importBtn.onclick = function() {
            let json = prompt('–í—Å—Ç–∞–≤—å—Ç–µ JSON –¥–ª—è –∏–º–ø–æ—Ä—Ç–∞:');
            if (json) {
                LampaUltimate.modules.collections.import(json);
                LampaUltimate.renderCollectionsTab(content);
            }
        };
        // –ü–æ–¥–µ–ª–∏—Ç—å—Å—è (–≥–µ–Ω–µ—Ä–∞—Ü–∏—è —Å—Å—ã–ª–∫–∏)
        let shareBtn = content.querySelector('#ultimate-collection-share');
        if (shareBtn) shareBtn.onclick = function() {
            prompt('–°—Å—ã–ª–∫–∞ –¥–ª—è –∏–º–ø–æ—Ä—Ç–∞ –∫–æ–ª–ª–µ–∫—Ü–∏–π:', LampaUltimate.modules.collections.exportLink());
        };
    };

    // --- –í—Å—Ç—Ä–∞–∏–≤–∞–µ–º –≤–∫–ª–∞–¥–∫—É '–ö–æ–ª–ª–µ–∫—Ü–∏–∏' –≤ –º–µ–Ω—é ---
    (function patchCollectionsTab() {
        const origRenderMenu = LampaUltimate.renderMenu;
        LampaUltimate.renderMenu = function() {
            origRenderMenu.call(this);
            // –ü–µ—Ä–µ–æ–ø—Ä–µ–¥–µ–ª—è–µ–º —Ä–µ–Ω–¥–µ—Ä –≤–∫–ª–∞–¥–∫–∏ '–ö–æ–ª–ª–µ–∫—Ü–∏–∏'
            let tabsBar = document.getElementById('lampa-ultimate-tabs');
            let content = document.getElementById('lampa-ultimate-content');
            if (!tabsBar || !content) return;
            let origRenderTab = content.renderTab || function(tabId){};
            content.renderTab = function(tabId) {
                if (tabId === 'collections') {
                    LampaUltimate.renderCollectionsTab(content);
                } else {
                    origRenderTab(tabId);
                }
            };
        };
    })();

    // --- –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∫–æ–ª–ª–µ–∫—Ü–∏–π ---
    setTimeout(() => {
        if (LampaUltimate.modules.collections && LampaUltimate.modules.collections.init) LampaUltimate.modules.collections.init();
    }, 1400);

    // --- –î–æ–±–∞–≤–ª—è–µ–º –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ —Ñ–∏–ª—å—Ç—Ä–æ–≤ –∏ —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏ –≤ –º–µ–Ω—é ---
    const origRenderTabFilters = LampaUltimate.renderCustomMenu;
    LampaUltimate.renderCustomMenu = function() {
        origRenderTabFilters.call(this);
        // –î–æ–±–∞–≤–ª—è–µ–º –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –≤–æ –≤–∫–ª–∞–¥–∫—É "–ú–æ–¥—É–ª–∏"
        let content = document.getElementById('lampa-ultimate-content');
        let tabsBar = document.getElementById('lampa-ultimate-tabs');
        if (!content || !tabsBar) return;
        let modulesBtn = Array.from(tabsBar.children).find(btn => btn.dataset.tab === 'modules');
        if (modulesBtn) {
            modulesBtn.onclick = function() {
                // –ü–µ—Ä–µ—Ä–∏—Å–æ–≤—ã–≤–∞–µ–º —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—É—é –≤–∫–ª–∞–¥–∫—É
                let html = '<h3>–ú–æ–¥—É–ª–∏</h3><ul style="list-style:none;padding:0;">';
                Object.entries(LampaUltimate.modules).forEach(([key, mod]) => {
                    html += `<li style="margin-bottom:10px;">
                        <label style="display:flex;align-items:center;gap:10px;">
                            <input type="checkbox" data-mod="${key}" ${mod.enabled ? 'checked' : ''} style="width:20px;height:20px;">
                            <span style="font-size:1.1em;">${mod.name}</span>
                        </label>`;
                    if (key === 'filters') {
                        html += `<div style="margin-left:30px;margin-top:5px;display:flex;flex-wrap:wrap;gap:10px;">
                            <label>–ö–∞—á–µ—Å—Ç–≤–æ: <input id="filter-quality" type="text" value="${mod.filters.quality||''}" style="width:80px;"></label>
                            <label>–ñ–∞–Ω—Ä: <input id="filter-genre" type="text" value="${mod.filters.genre||''}" style="width:80px;"></label>
                            <label>–°—Ç—Ä–∞–Ω–∞: <input id="filter-country" type="text" value="${mod.filters.country||''}" style="width:80px;"></label>
                            <label>–ì–æ–¥: <input id="filter-year" type="text" value="${mod.filters.year||''}" style="width:60px;"></label>
                            <label>–ò—Å—Ç–æ—á–Ω–∏–∫: <input id="filter-source" type="text" value="${mod.filters.source||''}" style="width:80px;"></label>
                            <label>–°—Ç–∞—Ç—É—Å: <select id="filter-watched">
                                <option value="">–í—Å–µ</option>
                                <option value="watched" ${mod.filters.watched==='watched'?'selected':''}>–ü—Ä–æ—Å–º–æ—Ç—Ä–µ–Ω–Ω—ã–µ</option>
                                <option value="unwatched" ${mod.filters.watched==='unwatched'?'selected':''}>–ù–µ–ø—Ä–æ—Å–º–æ—Ç—Ä–µ–Ω–Ω—ã–µ</option>
                            </select></label>
                        </div>`;
                        html += `<div style="margin-left:30px;margin-top:5px;">
                            <label>–°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞:
                                <select id="filter-sort">
                                    <option value="date" ${mod.sort==='date'?'selected':''}>–ü–æ –¥–∞—Ç–µ</option>
                                    <option value="popularity" ${mod.sort==='popularity'?'selected':''}>–ü–æ –ø–æ–ø—É–ª—è—Ä–Ω–æ—Å—Ç–∏</option>
                                    <option value="alpha" ${mod.sort==='alpha'?'selected':''}>–ü–æ –∞–ª—Ñ–∞–≤–∏—Ç—É</option>
                                </select>
                            </label>
                        </div>`;
                    }
                    html += '</li>';
                });
                html += '</ul>';
                content.innerHTML = html;
                // –ü–µ—Ä–µ–∫–ª—é—á–∞—Ç–µ–ª–∏ –º–æ–¥—É–ª–µ–π
                content.querySelectorAll('input[type=checkbox][data-mod]').forEach(chk => {
                    chk.onchange = function() {
                        let mod = chk.dataset.mod;
                        LampaUltimate.modules[mod].enabled = chk.checked;
                        LampaUltimate.saveSettings();
                    };
                });
                // –ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Ñ–∏–ª—å—Ç—Ä–æ–≤
                let q = content.querySelector('#filter-quality');
                let g = content.querySelector('#filter-genre');
                let c = content.querySelector('#filter-country');
                let y = content.querySelector('#filter-year');
                let s = content.querySelector('#filter-source');
                let w = content.querySelector('#filter-watched');
                let sortSel = content.querySelector('#filter-sort');
                if (q) q.oninput = function() { LampaUltimate.modules.filters.filters.quality = q.value.toLowerCase(); LampaUltimate.settings.filters.filters.quality = q.value.toLowerCase(); LampaUltimate.saveSettings(); let ev = new Event('ultimate-filter-update'); document.dispatchEvent(ev); };
                if (g) g.oninput = function() { LampaUltimate.modules.filters.filters.genre = g.value.toLowerCase(); LampaUltimate.settings.filters.filters.genre = g.value.toLowerCase(); LampaUltimate.saveSettings(); let ev = new Event('ultimate-filter-update'); document.dispatchEvent(ev); };
                if (c) c.oninput = function() { LampaUltimate.modules.filters.filters.country = c.value.toLowerCase(); LampaUltimate.settings.filters.filters.country = c.value.toLowerCase(); LampaUltimate.saveSettings(); let ev = new Event('ultimate-filter-update'); document.dispatchEvent(ev); };
                if (y) y.oninput = function() { LampaUltimate.modules.filters.filters.year = y.value; LampaUltimate.settings.filters.filters.year = y.value; LampaUltimate.saveSettings(); let ev = new Event('ultimate-filter-update'); document.dispatchEvent(ev); };
                if (s) s.oninput = function() { LampaUltimate.modules.filters.filters.source = s.value.toLowerCase(); LampaUltimate.settings.filters.filters.source = s.value.toLowerCase(); LampaUltimate.saveSettings(); let ev = new Event('ultimate-filter-update'); document.dispatchEvent(ev); };
                if (w) w.onchange = function() { LampaUltimate.modules.filters.filters.watched = w.value; LampaUltimate.settings.filters.filters.watched = w.value; LampaUltimate.saveSettings(); let ev = new Event('ultimate-filter-update'); document.dispatchEvent(ev); };
                if (sortSel) sortSel.onchange = function() { LampaUltimate.modules.filters.sort = sortSel.value; LampaUltimate.settings.filters.sort = sortSel.value; LampaUltimate.saveSettings(); let ev = new Event('ultimate-filter-update'); document.dispatchEvent(ev); };
            };
        }
    };

    // --- –ú–æ–¥—É–ª—å "–ê–Ω–∞–ª–∏—Ç–∏–∫–∞ –∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞" ---
    LampaUltimate.modules.analytics = {
        enabled: true,
        name: '–ê–Ω–∞–ª–∏—Ç–∏–∫–∞ –∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞',
        stats: {
            totalWatched: 0,
            genres: {},
            timeSpent: 0, // –≤ –º–∏–Ω—É—Ç–∞—Ö
            byCollection: {},
        },
        init() {
            // –°–±–æ—Ä —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ (–ø—Ä–∏–º–µ—Ä–Ω–æ, –º–æ–∂–Ω–æ –¥–æ—Ä–∞–±–æ—Ç–∞—Ç—å –ø–æ–¥ –≤–∞—à—É —Å—Ç—Ä—É–∫—Ç—É—Ä—É)
            let allCards = window.Lampa && Lampa.Data && Lampa.Data.cards ? Lampa.Data.cards : [];
            let watched = allCards.filter(card => isWatched(card));
            this.stats.totalWatched = watched.length;
            this.stats.genres = {};
            this.stats.timeSpent = watched.reduce((sum, card) => sum + (card.runtime||0), 0);
            watched.forEach(card => {
                (card.genres||[]).forEach(g => {
                    this.stats.genres[g] = (this.stats.genres[g]||0)+1;
                });
            });
            // –ü–æ –∫–æ–ª–ª–µ–∫—Ü–∏—è–º
            this.stats.byCollection = {};
            Object.keys(LampaUltimate.modules.collections.lists||{}).forEach(listName => {
                let ids = LampaUltimate.modules.collections.lists[listName];
                this.stats.byCollection[listName] = ids.filter(id => watched.find(card => card.id===id)).length;
            });
            // –ú–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –¥–∏–Ω–∞–º–∏–∫—É –ø–æ –¥–∞—Ç–∞–º, –ª—é–±–∏–º—ã—Ö –∞–∫—Ç–µ—Ä–æ–≤ –∏ —Ç.–¥.
            function isWatched(card) {
                return card.watched === true || card.is_watched === true || card.progress === 1 || card.seen === true;
            }
        },
        // –¢–µ–∫—Å—Ç–æ–≤—ã–π –æ—Ç—á–µ—Ç
        report() {
            let s = this.stats;
            let genres = Object.entries(s.genres).sort((a,b)=>b[1]-a[1]).map(([g,c])=>`${g}: ${c}`).join(', ');
            let byCol = Object.entries(s.byCollection).map(([n,c])=>`${n}: ${c}`).join(', ');
            return `–í—Å–µ–≥–æ –ø—Ä–æ—Å–º–æ—Ç—Ä–µ–Ω–æ: ${s.totalWatched}\n–õ—é–±–∏–º—ã–µ –∂–∞–Ω—Ä—ã: ${genres}\n–í—Ä–µ–º—è –∑–∞ –ø—Ä–æ—Å–º–æ—Ç—Ä–æ–º: ${Math.round(s.timeSpent/60)} —á.\n–ü–æ –∫–æ–ª–ª–µ–∫—Ü–∏—è–º: ${byCol}`;
        }
    };

    // --- –í–∫–ª–∞–¥–∫–∞ "–ê–Ω–∞–ª–∏—Ç–∏–∫–∞" –≤ –º–µ–Ω—é ---
    const origRenderTabAnalytics = LampaUltimate.renderCustomMenu;
    LampaUltimate.renderCustomMenu = function() {
        origRenderTabAnalytics.call(this);
        // –î–æ–±–∞–≤–ª—è–µ–º –≤–∫–ª–∞–¥–∫—É "–ê–Ω–∞–ª–∏—Ç–∏–∫–∞"
        let tabsBar = document.getElementById('lampa-ultimate-tabs');
        if (tabsBar && !Array.from(tabsBar.children).find(btn => btn.dataset.tab === 'analytics')) {
            let btn = document.createElement('button');
            btn.textContent = '–ê–Ω–∞–ª–∏—Ç–∏–∫–∞';
            btn.dataset.tab = 'analytics';
            btn.style = 'background:none;border:none;color:#fff;font-size:1.1em;padding:10px 0 8px 0;cursor:pointer;';
            btn.onclick = () => renderTab('analytics');
            tabsBar.appendChild(btn);
        }
        // –ü–µ—Ä–µ–æ–ø—Ä–µ–¥–µ–ª—è–µ–º —Ä–µ–Ω–¥–µ—Ä –≤–∫–ª–∞–¥–∫–∏
        let content = document.getElementById('lampa-ultimate-content');
        function renderTab(tabId) {
            Array.from(tabsBar.children).forEach(btn => btn.style.borderBottom = 'none');
            let activeBtn = Array.from(tabsBar.children).find(btn => btn.dataset.tab === tabId);
            if (activeBtn) activeBtn.style.borderBottom = '2px solid #00dbde';
            if (tabId === 'analytics') {
                LampaUltimate.modules.analytics.init();
                let s = LampaUltimate.modules.analytics.stats;
                let genres = Object.entries(s.genres).sort((a,b)=>b[1]-a[1]).map(([g,c])=>`${g}: ${c}`).join(', ');
                let byCol = Object.entries(s.byCollection).map(([n,c])=>`${n}: ${c}`).join(', ');
                let html = `<h3>–ê–Ω–∞–ª–∏—Ç–∏–∫–∞</h3>
                <div>–í—Å–µ–≥–æ –ø—Ä–æ—Å–º–æ—Ç—Ä–µ–Ω–æ: <b>${s.totalWatched}</b></div>
                <div>–õ—é–±–∏–º—ã–µ –∂–∞–Ω—Ä—ã: <b>${genres}</b></div>
                <div>–í—Ä–µ–º—è –∑–∞ –ø—Ä–æ—Å–º–æ—Ç—Ä–æ–º: <b>${Math.round(s.timeSpent/60)} —á.</b></div>
                <div>–ü–æ –∫–æ–ª–ª–µ–∫—Ü–∏—è–º: <b>${byCol}</b></div>
                <button id="ultimate-analytics-report">–¢–µ–∫—Å—Ç–æ–≤—ã–π –æ—Ç—á–µ—Ç</button>`;
                content.innerHTML = html;
                let repBtn = content.querySelector('#ultimate-analytics-report');
                if (repBtn) repBtn.onclick = function() {
                    alert(LampaUltimate.modules.analytics.report());
                };
            }
        }
    };

    // --- –ú–æ–¥—É–ª—å "–ü—Ä–æ—Ñ–∏–ª–∏ –∏ —ç–∫—Å–ø–æ—Ä—Ç/–∏–º–ø–æ—Ä—Ç" ---
    LampaUltimate.modules.profiles = {
        enabled: true,
        name: '–ü—Ä–æ—Ñ–∏–ª–∏ –∏ —ç–∫—Å–ø–æ—Ä—Ç/–∏–º–ø–æ—Ä—Ç',
        init() {
            LampaUltimate.settings.profiles = LampaUltimate.settings.profiles || {
                active: 'default',
                list: { 'default': {} }
            };
            // –ï—Å–ª–∏ –Ω–µ—Ç –∞–∫—Ç–∏–≤–Ω–æ–≥–æ –ø—Ä–æ—Ñ–∏–ª—è ‚Äî —Å–æ–∑–¥–∞—ë–º
            if (!LampaUltimate.settings.profiles.active) {
                LampaUltimate.settings.profiles.active = 'default';
            }
            if (!LampaUltimate.settings.profiles.list[LampaUltimate.settings.profiles.active]) {
                LampaUltimate.settings.profiles.list[LampaUltimate.settings.profiles.active] = {};
            }
        },
        // –°–æ—Ö—Ä–∞–Ω–∏—Ç—å —Ç–µ–∫—É—â–∏–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –≤ –ø—Ä–æ—Ñ–∏–ª—å
        saveProfile(name) {
            if (!name) return;
            LampaUltimate.settings.profiles.list[name] = {
                settings: JSON.parse(JSON.stringify(LampaUltimate.settings)),
                collections: JSON.parse(JSON.stringify(LampaUltimate.modules.collections.lists))
            };
            LampaUltimate.settings.profiles.active = name;
            LampaUltimate.saveSettings();
        },
        // –ó–∞–≥—Ä—É–∑–∏—Ç—å –ø—Ä–æ—Ñ–∏–ª—å
        loadProfile(name) {
            let p = LampaUltimate.settings.profiles.list[name];
            if (p) {
                LampaUltimate.settings = JSON.parse(JSON.stringify(p.settings));
                LampaUltimate.modules.collections.lists = JSON.parse(JSON.stringify(p.collections));
                LampaUltimate.settings.profiles.active = name;
                LampaUltimate.saveSettings();
                location.reload();
            }
        },
        // –£–¥–∞–ª–∏—Ç—å –ø—Ä–æ—Ñ–∏–ª—å
        deleteProfile(name) {
            if (name === 'default') return;
            delete LampaUltimate.settings.profiles.list[name];
            if (LampaUltimate.settings.profiles.active === name) {
                LampaUltimate.settings.profiles.active = 'default';
            }
            LampaUltimate.saveSettings();
        },
        // –≠–∫—Å–ø–æ—Ä—Ç –ø—Ä–æ—Ñ–∏–ª—è (JSON)
        exportProfile(name) {
            let p = LampaUltimate.settings.profiles.list[name];
            return p ? JSON.stringify(p) : '';
        },
        // –ò–º–ø–æ—Ä—Ç –ø—Ä–æ—Ñ–∏–ª—è (JSON)
        importProfile(name, json) {
            try {
                let data = JSON.parse(json);
                if (typeof data === 'object') {
                    LampaUltimate.settings.profiles.list[name] = data;
                    LampaUltimate.saveSettings();
                }
            } catch(e) {}
        },
        // –ì–µ–Ω–µ—Ä–∞—Ü–∏—è —Å—Å—ã–ª–∫–∏ (base64)
        exportLink(name) {
            return 'lampa-profile://' + btoa(this.exportProfile(name));
        },
        // –ò–º–ø–æ—Ä—Ç –∏–∑ —Å—Å—ã–ª–∫–∏
        importLink(name, link) {
            if (link.startsWith('lampa-profile://')) {
                let json = atob(link.replace('lampa-profile://',''));
                this.importProfile(name, json);
            }
        }
    };

    // --- –í–∫–ª–∞–¥–∫–∞ "–ü—Ä–æ—Ñ–∏–ª–∏" –≤ –º–µ–Ω—é ---
    const origRenderTabProfiles = LampaUltimate.renderCustomMenu;
    LampaUltimate.renderCustomMenu = function() {
        origRenderTabProfiles.call(this);
        // –ü–µ—Ä–µ–æ–ø—Ä–µ–¥–µ–ª—è–µ–º —Ä–µ–Ω–¥–µ—Ä –≤–∫–ª–∞–¥–∫–∏ "–ü—Ä–æ—Ñ–∏–ª–∏"
        let tabsBar = document.getElementById('lampa-ultimate-tabs');
        let content = document.getElementById('lampa-ultimate-content');
        function renderTab(tabId) {
            Array.from(tabsBar.children).forEach(btn => btn.style.borderBottom = 'none');
            let activeBtn = Array.from(tabsBar.children).find(btn => btn.dataset.tab === tabId);
            if (activeBtn) activeBtn.style.borderBottom = '2px solid #00dbde';
            if (tabId === 'profiles') {
                let profs = LampaUltimate.settings.profiles.list;
                let html = `<h3>–ü—Ä–æ—Ñ–∏–ª–∏</h3><div>–¢–µ–∫—É—â–∏–π –ø—Ä–æ—Ñ–∏–ª—å: <b>${LampaUltimate.settings.profiles.active}</b></div><ul style="list-style:none;padding:0;">`;
                Object.keys(profs).forEach(name => {
                    html += `<li style="margin-bottom:8px;"><b>${name}</b> <button data-profile="${name}" class="ultimate-profile-load">–ó–∞–≥—Ä—É–∑–∏—Ç—å</button> <button data-profile="${name}" class="ultimate-profile-del">–£–¥–∞–ª–∏—Ç—å</button> <button data-profile="${name}" class="ultimate-profile-export">–≠–∫—Å–ø–æ—Ä—Ç</button> <button data-profile="${name}" class="ultimate-profile-import">–ò–º–ø–æ—Ä—Ç</button> <button data-profile="${name}" class="ultimate-profile-share">–ü–æ–¥–µ–ª–∏—Ç—å—Å—è</button></li>`;
                });
                html += '</ul>';
                html += `<button id="ultimate-profile-add">–°–æ–∑–¥–∞—Ç—å –ø—Ä–æ—Ñ–∏–ª—å</button>`;
                content.innerHTML = html;
                // –ó–∞–≥—Ä—É–∑–∏—Ç—å –ø—Ä–æ—Ñ–∏–ª—å
                content.querySelectorAll('.ultimate-profile-load').forEach(btn => {
                    btn.onclick = function() {
                        let name = btn.dataset.profile;
                        if (confirm('–ü–µ—Ä–µ–∫–ª—é—á–∏—Ç—å—Å—è –Ω–∞ –ø—Ä–æ—Ñ–∏–ª—å ' + name + '?')) {
                            LampaUltimate.modules.profiles.loadProfile(name);
                        }
                    };
                });
                // –£–¥–∞–ª–∏—Ç—å –ø—Ä–æ—Ñ–∏–ª—å
                content.querySelectorAll('.ultimate-profile-del').forEach(btn => {
                    btn.onclick = function() {
                        let name = btn.dataset.profile;
                        if (confirm('–£–¥–∞–ª–∏—Ç—å –ø—Ä–æ—Ñ–∏–ª—å ' + name + '?')) {
                            LampaUltimate.modules.profiles.deleteProfile(name);
                            renderTab('profiles');
                        }
                    };
                });
                // –≠–∫—Å–ø–æ—Ä—Ç
                content.querySelectorAll('.ultimate-profile-export').forEach(btn => {
                    btn.onclick = function() {
                        let name = btn.dataset.profile;
                        prompt('JSON –¥–ª—è —ç–∫—Å–ø–æ—Ä—Ç–∞:', LampaUltimate.modules.profiles.exportProfile(name));
                    };
                });
                // –ò–º–ø–æ—Ä—Ç
                content.querySelectorAll('.ultimate-profile-import').forEach(btn => {
                    btn.onclick = function() {
                        let name = btn.dataset.profile;
                        let json = prompt('–í—Å—Ç–∞–≤—å—Ç–µ JSON –¥–ª—è –∏–º–ø–æ—Ä—Ç–∞:');
                        if (json) {
                            LampaUltimate.modules.profiles.importProfile(name, json);
                            renderTab('profiles');
                        }
                    };
                });
                // –ü–æ–¥–µ–ª–∏—Ç—å—Å—è (–≥–µ–Ω–µ—Ä–∞—Ü–∏—è —Å—Å—ã–ª–∫–∏)
                content.querySelectorAll('.ultimate-profile-share').forEach(btn => {
                    btn.onclick = function() {
                        let name = btn.dataset.profile;
                        prompt('–°—Å—ã–ª–∫–∞ –¥–ª—è –∏–º–ø–æ—Ä—Ç–∞ –ø—Ä–æ—Ñ–∏–ª—è:', LampaUltimate.modules.profiles.exportLink(name));
                    };
                });
                // –°–æ–∑–¥–∞—Ç—å –ø—Ä–æ—Ñ–∏–ª—å
                let addBtn = content.querySelector('#ultimate-profile-add');
                if (addBtn) addBtn.onclick = function() {
                    let name = prompt('–ù–∞–∑–≤–∞–Ω–∏–µ –Ω–æ–≤–æ–≥–æ –ø—Ä–æ—Ñ–∏–ª—è:');
                    if (name && !LampaUltimate.settings.profiles.list[name]) {
                        LampaUltimate.modules.profiles.saveProfile(name);
                        renderTab('profiles');
                    }
                };
            }
        }
    };

    // --- –ú–æ–¥—É–ª—å "–¢–µ–º—ã –∏ –∫–∞—Å—Ç–æ–º–∏–∑–∞—Ü–∏—è" ---
    LampaUltimate.modules.themes = {
        enabled: true,
        name: '–¢–µ–º—ã –∏ –∫–∞—Å—Ç–æ–º–∏–∑–∞—Ü–∏—è',
        themes: {
            dark: {
                name: '–¢–µ–º–Ω–∞—è',
                css: 'body { background: #181828 !important; color: #fff !important; } .ultimate-badge, .ultimate-logo, .ultimate-collection-btn { filter: none !important; }'
            },
            light: {
                name: '–°–≤–µ—Ç–ª–∞—è',
                css: 'body { background: #f5f5f5 !important; color: #222 !important; } .ultimate-badge, .ultimate-logo, .ultimate-collection-btn { filter: none !important; }'
            },
            color: {
                name: '–¶–≤–µ—Ç–Ω–∞—è',
                css: 'body { background: linear-gradient(120deg,#00dbde,#fc00ff) !important; color: #fff !important; }'
            }
        },
        current: 'dark',
        elementSize: 'normal', // normal | large | compact
        buttonStyle: 'rounded', // rounded | flat | outline
        iconStyle: 'color', // color | mono | outline
        init() {
            LampaUltimate.settings.themes = LampaUltimate.settings.themes || {
                current: 'dark',
                elementSize: 'normal',
                buttonStyle: 'rounded',
                iconStyle: 'color'
            };
            this.current = LampaUltimate.settings.themes.current;
            this.elementSize = LampaUltimate.settings.themes.elementSize;
            this.buttonStyle = LampaUltimate.settings.themes.buttonStyle;
            this.iconStyle = LampaUltimate.settings.themes.iconStyle;
            this.applyTheme(this.current);
        },
        applyTheme(themeKey) {
            let theme = this.themes[themeKey];
            if (!theme) return;
            let style = document.getElementById('ultimate-theme-style');
            if (!style) {
                style = document.createElement('style');
                style.id = 'ultimate-theme-style';
                document.head.appendChild(style);
            }
            style.innerHTML = theme.css;
            this.current = themeKey;
            LampaUltimate.settings.themes.current = themeKey;
            LampaUltimate.saveSettings();
        }
    };

    // --- –í–∫–ª–∞–¥–∫–∞ "–í–Ω–µ—à–Ω–∏–π –≤–∏–¥" –≤ –º–µ–Ω—é ---
    const origRenderTabAppearance = LampaUltimate.renderCustomMenu;
    LampaUltimate.renderCustomMenu = function() {
        origRenderTabAppearance.call(this);
        // –ü–µ—Ä–µ–æ–ø—Ä–µ–¥–µ–ª—è–µ–º —Ä–µ–Ω–¥–µ—Ä –≤–∫–ª–∞–¥–∫–∏ "–í–Ω–µ—à–Ω–∏–π –≤–∏–¥"
        let tabsBar = document.getElementById('lampa-ultimate-tabs');
        let content = document.getElementById('lampa-ultimate-content');
        function renderTab(tabId) {
            Array.from(tabsBar.children).forEach(btn => btn.style.borderBottom = 'none');
            let activeBtn = Array.from(tabsBar.children).find(btn => btn.dataset.tab === tabId);
            if (activeBtn) activeBtn.style.borderBottom = '2px solid #00dbde';
            if (tabId === 'appearance') {
                let t = LampaUltimate.modules.themes;
                let html = `<h3>–í–Ω–µ—à–Ω–∏–π –≤–∏–¥</h3>
                <label>–¢–µ–º–∞:
                    <select id="ultimate-theme-select">
                        ${Object.keys(t.themes).map(key => `<option value="${key}" ${t.current===key?'selected':''}>${t.themes[key].name}</option>`).join('')}
                    </select>
                </label>
                <label style="margin-left:20px;">–†–∞–∑–º–µ—Ä —ç–ª–µ–º–µ–Ω—Ç–æ–≤:
                    <select id="ultimate-size-select">
                        <option value="normal" ${t.elementSize==='normal'?'selected':''}>–û–±—ã—á–Ω—ã–π</option>
                        <option value="large" ${t.elementSize==='large'?'selected':''}>–ö—Ä—É–ø–Ω—ã–π</option>
                        <option value="compact" ${t.elementSize==='compact'?'selected':''}>–ö–æ–º–ø–∞–∫—Ç–Ω—ã–π</option>
                    </select>
                </label>
                <label style="margin-left:20px;">–°—Ç–∏–ª—å –∫–Ω–æ–ø–æ–∫:
                    <select id="ultimate-btn-style">
                        <option value="rounded" ${t.buttonStyle==='rounded'?'selected':''}>–°–∫—Ä—É–≥–ª–µ–Ω–Ω—ã–µ</option>
                        <option value="flat" ${t.buttonStyle==='flat'?'selected':''}>–ü–ª–æ—Å–∫–∏–µ</option>
                        <option value="outline" ${t.buttonStyle==='outline'?'selected':''}>Outline</option>
                    </select>
                </label>
                <label style="margin-left:20px;">–°—Ç–∏–ª—å –∏–∫–æ–Ω–æ–∫:
                    <select id="ultimate-icon-style">
                        <option value="color" ${t.iconStyle==='color'?'selected':''}>–¶–≤–µ—Ç–Ω—ã–µ</option>
                        <option value="mono" ${t.iconStyle==='mono'?'selected':''}>–ú–æ–Ω–æ—Ö—Ä–æ–º</option>
                        <option value="outline" ${t.iconStyle==='outline'?'selected':''}>Outline</option>
                    </select>
                </label>
                <hr><div style="margin-top:10px;">Drag&drop –¥–ª—è –ø–∞–Ω–µ–ª–∏ –±—ã—Å—Ç—Ä–æ–≥–æ –¥–æ—Å—Ç—É–ø–∞ –∏ –ø–æ—Ä—è–¥–∫–∞ –º–æ–¥—É–ª–µ–π (–±–∞–∑–æ–≤–∞—è –¥–µ–º–æ):</div>
                <ul id="ultimate-modules-dnd" style="list-style:none;padding:0;display:flex;gap:10px;">${Object.keys(LampaUltimate.modules).map(m=>`<li draggable="true" data-mod="${m}" style="background:#333;padding:6px 14px;border-radius:8px;cursor:grab;">${LampaUltimate.modules[m].name||m}</li>`).join('')}</ul>`;
                content.innerHTML = html;
                // –°–µ–ª–µ–∫—Ç—ã —Ç–µ–º –∏ —Å—Ç–∏–ª–µ–π
                let themeSel = content.querySelector('#ultimate-theme-select');
                let sizeSel = content.querySelector('#ultimate-size-select');
                let btnStyleSel = content.querySelector('#ultimate-btn-style');
                let iconStyleSel = content.querySelector('#ultimate-icon-style');
                if (themeSel) themeSel.onchange = function() { t.applyTheme(themeSel.value); };
                if (sizeSel) sizeSel.onchange = function() { t.elementSize = sizeSel.value; LampaUltimate.settings.themes.elementSize = sizeSel.value; LampaUltimate.saveSettings(); };
                if (btnStyleSel) btnStyleSel.onchange = function() { t.buttonStyle = btnStyleSel.value; LampaUltimate.settings.themes.buttonStyle = btnStyleSel.value; LampaUltimate.saveSettings(); };
                if (iconStyleSel) iconStyleSel.onchange = function() { t.iconStyle = iconStyleSel.value; LampaUltimate.settings.themes.iconStyle = iconStyleSel.value; LampaUltimate.saveSettings(); };
                // Drag&drop –º–æ–¥—É–ª–µ–π (–±–∞–∑–æ–≤–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è)
                let dnd = content.querySelector('#ultimate-modules-dnd');
                if (dnd) {
                    let dragSrc = null;
                    dnd.querySelectorAll('li').forEach(li => {
                        li.ondragstart = function(e) { dragSrc = li; li.style.opacity = 0.5; };
                        li.ondragend = function(e) { dragSrc = null; li.style.opacity = 1; };
                        li.ondragover = function(e) { e.preventDefault(); };
                        li.ondrop = function(e) {
                            e.preventDefault();
                            if (dragSrc && dragSrc !== li) {
                                dnd.insertBefore(dragSrc, li.nextSibling);
                                // –ú–æ–∂–Ω–æ —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –ø–æ—Ä—è–¥–æ–∫ –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö
                            }
                        };
                    });
                }
            }
        }
    };

    // --- –ú–æ–¥—É–ª—å "–≠–∫—Å–ø–µ—Ä–∏–º–µ–Ω—Ç—ã" ---
    LampaUltimate.modules.experiments = {
        enabled: true,
        name: '–≠–∫—Å–ø–µ—Ä–∏–º–µ–Ω—Ç—ã',
        options: {
            showFPS: false,
            altCardRender: false
        },
        init() {
            LampaUltimate.settings.experiments = LampaUltimate.settings.experiments || {
                showFPS: false,
                altCardRender: false
            };
            this.options = Object.assign({}, LampaUltimate.settings.experiments);
            // –ü—Ä–∏–º–µ—Ä: –ø–æ–∫–∞–∑–∞—Ç—å —Å—á–µ—Ç—á–∏–∫ FPS
            if (this.options.showFPS && !document.getElementById('ultimate-fps-counter')) {
                let fpsDiv = document.createElement('div');
                fpsDiv.id = 'ultimate-fps-counter';
                fpsDiv.style = 'position:fixed;bottom:8px;left:8px;z-index:999999;background:#222;color:#fff;padding:4px 12px;border-radius:8px;font-size:1em;opacity:0.8;';
                document.body.appendChild(fpsDiv);
                let last = performance.now(), frames = 0, fps = 0;
                function loop() {
                    frames++;
                    let now = performance.now();
                    if (now - last > 1000) {
                        fps = frames; frames = 0; last = now;
                        fpsDiv.textContent = 'FPS: ' + fps;
                    }
                    if (document.getElementById('ultimate-fps-counter')) requestAnimationFrame(loop);
                }
                loop();
            } else if (!this.options.showFPS && document.getElementById('ultimate-fps-counter')) {
                document.getElementById('ultimate-fps-counter').remove();
            }
            // –ü—Ä–∏–º–µ—Ä: –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–π —Ä–µ–Ω–¥–µ—Ä –∫–∞—Ä—Ç–æ—á–µ–∫ (–∑–∞–≥–ª—É—à–∫–∞)
            if (this.options.altCardRender) {
                // –ú–æ–∂–Ω–æ —Ä–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–π —Å—Ç–∏–ª—å –∫–∞—Ä—Ç–æ—á–µ–∫
            }
        }
    };

    // --- –í–∫–ª–∞–¥–∫–∞ "–≠–∫—Å–ø–µ—Ä–∏–º–µ–Ω—Ç—ã" –≤ –º–µ–Ω—é ---
    const origRenderTabExperiments = LampaUltimate.renderCustomMenu;
    LampaUltimate.renderCustomMenu = function() {
        origRenderTabExperiments.call(this);
        // –ü–µ—Ä–µ–æ–ø—Ä–µ–¥–µ–ª—è–µ–º —Ä–µ–Ω–¥–µ—Ä –≤–∫–ª–∞–¥–∫–∏ "–≠–∫—Å–ø–µ—Ä–∏–º–µ–Ω—Ç—ã"
        let tabsBar = document.getElementById('lampa-ultimate-tabs');
        let content = document.getElementById('lampa-ultimate-content');
        function renderTab(tabId) {
            Array.from(tabsBar.children).forEach(btn => btn.style.borderBottom = 'none');
            let activeBtn = Array.from(tabsBar.children).find(btn => btn.dataset.tab === tabId);
            if (activeBtn) activeBtn.style.borderBottom = '2px solid #00dbde';
            if (tabId === 'experiments') {
                let e = LampaUltimate.modules.experiments;
                let html = `<h3>–≠–∫—Å–ø–µ—Ä–∏–º–µ–Ω—Ç–∞–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏</h3>
                <label><input type="checkbox" id="exp-fps" ${e.options.showFPS?'checked':''}> –ü–æ–∫–∞–∑–∞—Ç—å —Å—á–µ—Ç—á–∏–∫ FPS</label><br>
                <label><input type="checkbox" id="exp-altcard" ${e.options.altCardRender?'checked':''}> –ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–π —Ä–µ–Ω–¥–µ—Ä –∫–∞—Ä—Ç–æ—á–µ–∫ (–¥–µ–º–æ)</label><br>
                <div style="margin-top:10px;color:#aaa;">–í–∫–ª—é—á–∞–π—Ç–µ —ç–∫—Å–ø–µ—Ä–∏–º–µ–Ω—Ç–∞–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ –Ω–∞ —Å–≤–æ–π —Å—Ç—Ä–∞—Ö –∏ —Ä–∏—Å–∫!</div>`;
                content.innerHTML = html;
                let fpsChk = content.querySelector('#exp-fps');
                let altChk = content.querySelector('#exp-altcard');
                if (fpsChk) fpsChk.onchange = function() {
                    e.options.showFPS = fpsChk.checked;
                    LampaUltimate.settings.experiments.showFPS = fpsChk.checked;
                    LampaUltimate.saveSettings();
                    e.init();
                };
                if (altChk) altChk.onchange = function() {
                    e.options.altCardRender = altChk.checked;
                    LampaUltimate.settings.experiments.altCardRender = altChk.checked;
                    LampaUltimate.saveSettings();
                    e.init();
                };
            }
        }
    };

    // –ü—Ä–∏–º–µ—Ä –∑–∞–≥–ª—É—à–∫–∏ –º–æ–¥—É–ª—è (—Ä–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å –∫–∞–∂–¥—ã–π –º–æ–¥—É–ª—å –æ—Ç–¥–µ–ª—å–Ω–æ)
    LampaUltimate.registerModule('badges', {
        enabled: true,
        name: '–ë–µ–π–¥–∂–∏ –∫–∞—á–µ—Å—Ç–≤–∞ –∏ —Å–µ—Ä–∏–π',
        init() {
            // TODO: –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å —Ä–µ–Ω–¥–µ—Ä –±–µ–π–¥–∂–µ–π –Ω–∞ –∫–∞—Ä—Ç–æ—á–∫–∞—Ö
        }
    });
    LampaUltimate.registerModule('logos', {
        enabled: true,
        name: '–û—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–µ –ª–æ–≥–æ—Ç–∏–ø—ã',
        init() {
            // TODO: –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –ø–æ–ª—É—á–µ–Ω–∏–µ –∏ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –ª–æ–≥–æ—Ç–∏–ø–æ–≤
        }
    });
    LampaUltimate.registerModule('vpn', {
        enabled: false,
        name: 'VPN Checker',
        init() {
            // TODO: –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å –ø—Ä–æ–≤–µ—Ä–∫—É VPN —Å –º—É–ª—å—Ç–∏-API –∏ –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏–µ–π
        }
    });
    // ... –¥—Ä—É–≥–∏–µ –º–æ–¥—É–ª–∏ –ø–æ –∞–Ω–∞–ª–æ–≥–∏–∏

    // --- –ù–∞—Å—Ç—Ä–æ–π–∫–∏ Telegram-–±–æ—Ç–∞ ---
    LampaUltimate.settings.telegram = LampaUltimate.settings.telegram || {
        botToken: '', // <-- —Å—é–¥–∞ –≤—Å—Ç–∞–≤–∏—Ç—å —Ç–æ–∫–µ–Ω –≤–∞—à–µ–≥–æ Telegram-–±–æ—Ç–∞
        chatId: '',   // <-- —Å—é–¥–∞ –≤—Å—Ç–∞–≤–∏—Ç—å chat_id (–≤–∞—à –∏–ª–∏ –∫–∞–Ω–∞–ª–∞)
        supportLink: 'https://t.me/your_channel_or_chat' // —Å—Å—ã–ª–∫–∞ –Ω–∞ –ø–æ–¥–¥–µ—Ä–∂–∫—É/–Ω–æ–≤–æ—Å—Ç–∏
    };
    // –î–ª—è –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è Telegram-–±–æ—Ç–∞:
    // 1. –ü–æ–ª—É—á–∏—Ç–µ —Ç–æ–∫–µ–Ω —É @BotFather –∏ –≤—Å—Ç–∞–≤—å—Ç–µ –≤ botToken
    // 2. –£–∑–Ω–∞–π—Ç–µ chat_id —á–µ—Ä–µ–∑ @userinfobot –∏–ª–∏ API –∏ –≤—Å—Ç–∞–≤—å—Ç–µ –≤ chatId
    // 3. –£–∫–∞–∂–∏—Ç–µ —Å—Å—ã–ª–∫—É –Ω–∞ –∫–∞–Ω–∞–ª/—á–∞—Ç –¥–ª—è –∫–Ω–æ–ø–∫–∏ –ø–æ–¥–¥–µ—Ä–∂–∫–∏

    // --- –°–µ–∫—Ü–∏—è –¥–ª—è –∫–∞—Å—Ç–æ–º–Ω—ã—Ö SVG/PNG –∏–∫–æ–Ω–æ–∫/–ª–æ–≥–æ ---
    // –ü—Ä–∏–º–µ—Ä: LampaUltimate.icons = { myIcon: 'data:image/svg+xml;utf8,<svg .../svg>' }
    // –ú–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å —Å–≤–æ–∏ SVG/PNG –∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –∏—Ö –≤ UI (—Å–º. –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ –≤ –∫–æ–¥–µ)
    LampaUltimate.icons = {
        // myIcon: 'data:image/svg+xml;utf8,<svg .../svg>'
    };

    // --- –ú–æ–¥—É–ª—å "–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏" ---
    LampaUltimate.modules.recommendations = {
        enabled: true,
        name: '–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏',
        lastRandom: null,
        getPersonalized(allCards) {
            // –ü—Ä–∏–º–µ—Ä: —Ç–æ–ø-10 –∂–∞–Ω—Ä–æ–≤ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            let genres = {};
            let watched = allCards.filter(card => card.watched || card.is_watched || card.progress === 1);
            watched.forEach(card => (card.genres||[]).forEach(g => genres[g] = (genres[g]||0)+1));
            let topGenre = Object.entries(genres).sort((a,b)=>b[1]-a[1])[0]?.[0];
            return allCards.filter(card => (card.genres||[]).includes(topGenre) && !watched.includes(card)).slice(0,10);
        },
        getSimilar(card, allCards) {
            // –ü—Ä–∏–º–µ—Ä: –ø–æ—Ö–æ–∂–∏–µ –ø–æ –∂–∞–Ω—Ä—É
            return allCards.filter(c => c.id!==card.id && (c.genres||[]).some(g => (card.genres||[]).includes(g))).slice(0,10);
        },
        getRandom(allCards) {
            let unwatched = allCards.filter(card => !(card.watched || card.is_watched || card.progress === 1));
            this.lastRandom = unwatched[Math.floor(Math.random()*unwatched.length)];
            return this.lastRandom;
        }
    };

    // --- –ú–æ–¥—É–ª—å "–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è" ---
    LampaUltimate.modules.notifications = {
        enabled: true,
        name: '–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è',
        reminders: [], // [{title, time, cardId}]
        addReminder(title, time, cardId) {
            this.reminders.push({title, time, cardId});
            this.save();
        },
        save() {
            localStorage.setItem('lampa_ultimate_reminders', JSON.stringify(this.reminders));
        },
        load() {
            let r = localStorage.getItem('lampa_ultimate_reminders');
            this.reminders = r ? JSON.parse(r) : [];
        },
        checkReminders() {
            let now = Date.now();
            this.reminders.forEach(rem => {
                if (rem.time && now >= rem.time && !rem.notified) {
                    this.notify(rem.title);
                    rem.notified = true;
                    // Telegram push
                    LampaUltimate.modules.telegram.sendMessage(`–ù–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ: ${rem.title}`);
                }
            });
            this.save();
        },
        notify(msg) {
            if (window.Notification && Notification.permission === 'granted') {
                new Notification('Lampa', { body: msg });
            } else {
                alert(msg);
            }
        },
        requestPermission() {
            if (window.Notification && Notification.permission !== 'granted') {
                Notification.requestPermission();
            }
        },
        init() {
            this.load();
            this.requestPermission();
            setInterval(()=>this.checkReminders(), 60000);
        }
    };

    // --- –ú–æ–¥—É–ª—å "Telegram-–∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è" ---
    LampaUltimate.modules.telegram = {
        enabled: true,
        name: 'Telegram',
        sendMessage(msg) {
            let token = LampaUltimate.settings.telegram.botToken;
            let chat = LampaUltimate.settings.telegram.chatId;
            if (!token || !chat) return;
            fetch(`https://api.telegram.org/bot${token}/sendMessage`, {
                method: 'POST',
                headers: {'Content-Type':'application/json'},
                body: JSON.stringify({ chat_id: chat, text: msg })
            });
        },
        exportToTelegram(data, caption) {
            this.sendMessage((caption||'–≠–∫—Å–ø–æ—Ä—Ç –¥–∞–Ω–Ω—ã—Ö:') + '\n' + data);
        },
        importFromTelegram() {
            // –ú–æ–∂–Ω–æ —Ä–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å —á–µ—Ä–µ–∑ –∫–æ–º–∞–Ω–¥—É –±–æ—Ç—É –∏–ª–∏ —Å—Å—ã–ª–∫—É
        },
        supportLink() {
            return LampaUltimate.settings.telegram.supportLink;
        }
    };

    // --- –í–∫–ª–∞–¥–∫–∞ "–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏" –≤ –º–µ–Ω—é ---
    const origRenderTabRecommendations = LampaUltimate.renderCustomMenu;
    LampaUltimate.renderCustomMenu = function() {
        origRenderTabRecommendations.call(this);
        let tabsBar = document.getElementById('lampa-ultimate-tabs');
        let content = document.getElementById('lampa-ultimate-content');
        function renderTab(tabId) {
            Array.from(tabsBar.children).forEach(btn => btn.style.borderBottom = 'none');
            let activeBtn = Array.from(tabsBar.children).find(btn => btn.dataset.tab === tabId);
            if (activeBtn) activeBtn.style.borderBottom = '2px solid #00dbde';
            if (tabId === 'recommendations') {
                let allCards = window.Lampa && Lampa.Data && Lampa.Data.cards ? Lampa.Data.cards : [];
                let rec = LampaUltimate.modules.recommendations;
                let pers = rec.getPersonalized(allCards);
                let html = `<h3>–ü–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏</h3><ul style="list-style:none;padding:0;">`;
                pers.forEach(card => { html += `<li>${card.title||card.name||card.original_title}</li>`; });
                html += '</ul>';
                html += `<button id="ultimate-random-btn">–°–ª—É—á–∞–π–Ω—ã–π —Ñ–∏–ª—å–º</button>`;
                content.innerHTML = html;
                let randBtn = content.querySelector('#ultimate-random-btn');
                if (randBtn) randBtn.onclick = function() {
                    let rnd = rec.getRandom(allCards);
                    alert('–°–ª—É—á–∞–π–Ω—ã–π —Ñ–∏–ª—å–º: ' + (rnd?.title||rnd?.name||rnd?.original_title||'–Ω–µ—Ç'));
                };
            }
            if (tabId === 'notifications') {
                let n = LampaUltimate.modules.notifications;
                let html = `<h3>–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –∏ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è</h3><ul style="list-style:none;padding:0;">`;
                n.reminders.forEach(rem => { html += `<li>${rem.title} (${new Date(rem.time).toLocaleString()})</li>`; });
                html += '</ul>';
                html += `<button id="ultimate-add-reminder">–î–æ–±–∞–≤–∏—Ç—å –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ</button>`;
                content.innerHTML = html;
                let addBtn = content.querySelector('#ultimate-add-reminder');
                if (addBtn) addBtn.onclick = function() {
                    let title = prompt('–¢–µ–∫—Å—Ç –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è:');
                    let time = prompt('–í—Ä–µ–º—è (YYYY-MM-DD HH:MM):');
                    if (title && time) {
                        let t = new Date(time.replace(' ', 'T')).getTime();
                        n.addReminder(title, t);
                        alert('–ù–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ –¥–æ–±–∞–≤–ª–µ–Ω–æ!');
                    }
                };
            }
            if (tabId === 'telegram') {
                let t = LampaUltimate.modules.telegram;
                let html = `<h3>–ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å Telegram</h3>
                <div>–ë–æ—Ç: <b>${LampaUltimate.settings.telegram.botToken ? '–ü–æ–¥–∫–ª—é—á–µ–Ω' : '–ù–µ –ø–æ–¥–∫–ª—é—á–µ–Ω'}</b></div>
                <div>–ß–∞—Ç/–∫–∞–Ω–∞–ª: <b>${LampaUltimate.settings.telegram.chatId||'-'}</b></div>
                <div><a href="${t.supportLink()}" target="_blank" style="color:#00dbde;">–ü–æ–¥–¥–µ—Ä–∂–∫–∞/–ù–æ–≤–æ—Å—Ç–∏</a></div>
                <button id="ultimate-tg-export">–≠–∫—Å–ø–æ—Ä—Ç –ø—Ä–æ—Ñ–∏–ª—è –≤ Telegram</button>`;
                content.innerHTML = html;
                let expBtn = content.querySelector('#ultimate-tg-export');
                if (expBtn) expBtn.onclick = function() {
                    let name = LampaUltimate.settings.profiles.active;
                    let data = LampaUltimate.modules.profiles.exportProfile(name);
                    t.exportToTelegram(data, '–≠–∫—Å–ø–æ—Ä—Ç –ø—Ä–æ—Ñ–∏–ª—è: ' + name);
                    alert('–ü—Ä–æ—Ñ–∏–ª—å –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω –≤ Telegram!');
                };
            }
        }
    };

    // --- –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å –Ω–∞—Å—Ç—Ä–æ–π–∫–∞–º–∏ Lampa (–∫–∞–∫ —É Bywolf88) ---
    function addUltimateSettingsComponent() {
        Lampa.SettingsApi.addComponent({
            component: 'lampa_ultimate',
            name: 'Ultimate Modular',
            icon: '<svg width="24" height="24" viewBox="0 0 24 24"><circle cx="12" cy="12" r="10" fill="#00dbde"/><text x="12" y="17" text-anchor="middle" font-size="10" fill="#fff">ULT</text></svg>'
        });
        // –ö–Ω–æ–ø–∫–∞ –¥–ª—è –æ—Ç–∫—Ä—ã—Ç–∏—è –∫–∞—Å—Ç–æ–º–Ω–æ–≥–æ –º–µ–Ω—é
        Lampa.SettingsApi.addParam({
            component: 'lampa_ultimate',
            param: { type: 'button', component: 'open_menu' },
            field: { name: '–û—Ç–∫—Ä—ã—Ç—å –º–µ–Ω—é Ultimate', description: '–ù–∞—Å—Ç—Ä–æ–π—Ç–µ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å, –º–æ–¥—É–ª–∏, –ø—Ä–æ—Ñ–∏–ª–∏ –∏ –≤–Ω–µ—à–Ω–∏–π –≤–∏–¥' },
            onChange: () => {
                if (LampaUltimate.renderCustomMenu) LampaUltimate.renderCustomMenu();
            }
        });
        // –ü—Ä–∏–º–µ—Ä –ø–∞—Ä–∞–º–µ—Ç—Ä–∞: –≤–∫–ª—é—á–µ–Ω–∏–µ/–≤—ã–∫–ª—é—á–µ–Ω–∏–µ –±–µ–π–¥–∂–µ–π
        Lampa.SettingsApi.addParam({
            component: 'lampa_ultimate',
            param: { name: 'badges_enabled', type: 'trigger', default: true },
            field: { name: '–ë–µ–π–¥–∂–∏ –∫–∞—á–µ—Å—Ç–≤–∞ –∏ —Å–µ—Ä–∏–π', description: '–ü–æ–∫–∞–∑—ã–≤–∞—Ç—å –±–µ–π–¥–∂–∏ –Ω–∞ –∫–∞—Ä—Ç–æ—á–∫–∞—Ö' },
            onChange: (val) => {
                if (LampaUltimate.modules.badges) {
                    LampaUltimate.modules.badges.enabled = val;
                    LampaUltimate.settings.badges = LampaUltimate.settings.badges || {};
                    LampaUltimate.settings.badges.enabled = val;
                    LampaUltimate.saveSettings();
                }
            }
        });
        // –ü—Ä–∏–º–µ—Ä –ø–∞—Ä–∞–º–µ—Ç—Ä–∞: –≤–∫–ª—é—á–µ–Ω–∏–µ/–≤—ã–∫–ª—é—á–µ–Ω–∏–µ –ª–æ–≥–æ—Ç–∏–ø–æ–≤
        Lampa.SettingsApi.addParam({
            component: 'lampa_ultimate',
            param: { name: 'logos_enabled', type: 'trigger', default: true },
            field: { name: '–û—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–µ –ª–æ–≥–æ—Ç–∏–ø—ã', description: '–ü–æ–∫–∞–∑—ã–≤–∞—Ç—å –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–µ –ª–æ–≥–æ—Ç–∏–ø—ã –Ω–∞ –∫–∞—Ä—Ç–æ—á–∫–∞—Ö' },
            onChange: (val) => {
                if (LampaUltimate.modules.logos) {
                    LampaUltimate.modules.logos.enabled = val;
                    LampaUltimate.settings.logos = LampaUltimate.settings.logos || {};
                    LampaUltimate.settings.logos.enabled = val;
                    LampaUltimate.saveSettings();
                }
            }
        });
        // –ú–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –¥—Ä—É–≥–∏–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –ø–æ –∞–Ω–∞–ª–æ–≥–∏–∏ (VPN, —Ñ–∏–ª—å—Ç—Ä—ã, –∫–æ–ª–ª–µ–∫—Ü–∏–∏ –∏ —Ç.–¥.)
    }

    // --- –ê–≤—Ç–æ–∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –≤–∫–ª–∞–¥–∫–∏ –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö ---
    setTimeout(() => {
        if (window.Lampa && Lampa.SettingsApi) {
            addUltimateSettingsComponent();
        }
        if (LampaUltimate.init) LampaUltimate.init();
    }, 1000);

    // –≠–∫—Å–ø–æ—Ä—Ç –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏
    window.LampaUltimate = LampaUltimate;
})();