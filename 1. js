(function () {
  "use strict";

  // Стартуем плагин только когда Lampa уже инициализирована
  function init() {
    if (typeof Lampa === "undefined") return;

    // Базовая конфигурация плагина (можно расширять в следующих частях)
        var SuperMenuConfig = {
      DEBUG: false,
      VERBOSE_LOGGING: false,

      // Профиль производительности (базовый)
      PERFORMANCE: {
        DEBOUNCE_DELAY: 300,
        THROTTLE_LIMIT: 100,
        MUTATION_THROTTLE: 50
      },

      // Поведение в разных средах
      PLATFORM: {
        isAndroid: Lampa.Platform.is("android"),
        isWebOS: Lampa.Platform.is("webos"),
        isTizen: Lampa.Platform.is("tizen"),
        isBrowser: Lampa.Platform.is("browser"),
        isTV: Lampa.Platform.is("android")
          || Lampa.Platform.is("tizen")
          || Lampa.Platform.is("webos")
          || Lampa.Platform.is("orsay")
          || Lampa.Platform.is("netcast")
      },

      // Цветовые схемы для меток качества и типа
      LABEL_COLORS: {
        // базовая схема (яркая)
        vivid: {
          TYPE: {
            movie: "#FFD54F",   // фильм
            tv:    "#4CAF50",   // сериал
            anime: "#E91E63"
          },
          QUALITY: {
            "4K":    "#FF5722",
            "2160p": "#FF5722",
            "1080p": "#03A9F4",
            "720p":  "#B0BEC5",
            "SD":    "#90A4AE",
            "CAM":   "#FF7043",
            "HDR":   "#FFC107"
          }
        },
        // более спокойная схема
        soft: {
          TYPE: {
            movie: "#FFE082",
            tv:    "#A5D6A7",
            anime:"#F48FB1"
          },
          QUALITY: {
            "4K":    "#FFAB91",
            "2160p": "#FFAB91",
            "1080p": "#81D4FA",
            "720p":  "#CFD8DC",
            "SD":    "#B0BEC5",
            "CAM":   "#FFAB91",
            "HDR":   "#FFD54F"
          }
        }
      },

      LABEL_SCHEME: "vivid", // текущая схема

      // Включение/выключение подсистем (настраиваемые в Settings)
      FEATURES: {
        madness: true,
        ratings_tmdb: true,
        ratings_imdb: true,
        ratings_kp: true,
        ratings_other: false,
        label_colors: true,
        voiceover_tracking: false,
        topbar_exit_menu: true
      }
    };


    // Профиль производительности для Android TV (более щадящий)
    if (SuperMenuConfig.PLATFORM.isAndroid) {
      SuperMenuConfig.PERFORMANCE.DEBOUNCE_DELAY = 500;
      SuperMenuConfig.PERFORMANCE.THROTTLE_LIMIT = 150;
      SuperMenuConfig.PERFORMANCE.MUTATION_THROTTLE = 80;
    }

    // Небольшие утилиты
    function log() {
      if (!SuperMenuConfig.DEBUG && !SuperMenuConfig.VERBOSE_LOGGING) return;
      try {
        console.log.apply(console, ["[SuperMenu]"].concat([].slice.call(arguments)));
      } catch (e) {}
    }

    function debounce(fn, delay) {
      var timeout;
      return function () {
        var ctx = this;
        var args = arguments;
        clearTimeout(timeout);
        timeout = setTimeout(function () {
          fn.apply(ctx, args);
        }, delay);
      };
    }

    function throttle(fn, limit) {
      var inThrottle;
      var lastArgs;
      var lastCtx;
      return function () {
        lastCtx = this;
        lastArgs = arguments;
        if (!inThrottle) {
          fn.apply(lastCtx, lastArgs);
          inThrottle = true;
          setTimeout(function () {
            inThrottle = false;
            if (lastArgs) {
              fn.apply(lastCtx, lastArgs);
              lastArgs = null;
            }
          }, limit);
        }
      };
    }

    // === Настройки плагина в интерфейсе Lampa ===

    // === Меню выхода (адаптация логики из menus.js) ===

    // Конфиг пунктов меню выхода
    var ExitMenuConfig = {
      visibilityValues: {1: "Скрыть", 2: "Отобразить"},
      items: [
        {name: "exit",          defaultValue: "2", title: "Закрыть приложение"},
        {name: "reboot",        defaultValue: "2", title: "Перезагрузить"},
        {name: "switch_server", defaultValue: "2", title: "Сменить сервер"},
        {name: "clear_cache",   defaultValue: "2", title: "Очистить кэш"},
        {name: "youtube",       defaultValue: "1", title: "YouTube"},
        {name: "rutube",        defaultValue: "1", title: "RuTube"},
        {name: "drm_play",      defaultValue: "1", title: "DRM Play"},
        {name: "twitch",        defaultValue: "1", title: "Twitch"},
        {name: "fork_player",   defaultValue: "1", title: "ForkPlayer"},
        {name: "speedtest",     defaultValue: "1", title: "Speed Test"}
      ]
    };

    // Значения по умолчанию (shimya из menus.js)
    function exitMenuEnsureDefaults() {
      try {
        var defaults = {
          back_plug: true,
          exit: "2",
          reboot: "2",
          switch_server: "2",
          clear_cache: "2",
          youtube: "1",
          rutube: "1",
          drm_play: "1",
          twitch: "1",
          fork_player: "1",
          speedtest: "1"
        };

        Object.keys(defaults).forEach(function (key) {
          if (!localStorage.getItem(key)) {
            localStorage.setItem(key, defaults[key]);
          }
        });
      } catch (e) {
        log("Ошибка в exitMenuEnsureDefaults:", e);
      }
    }

    // Действие: выход из приложения (season из menus.js/Obf.js)
    function exitMenuSeason() {
      try {
        if (Lampa.Platform.is("apple_tv")) {
          window.location.assign("exit://exit");
        }
        if (Lampa.Platform.is("tizen")) {
          tizen.application.getCurrentApplication().exit();
        }
        if (Lampa.Platform.is("webos")) {
          window.close();
        }
        if (Lampa.Platform.is("android")) {
          Lampa.Android.exit();
        }
        if (Lampa.Platform.is("orsay")) {
          Lampa.Orsay.exit();
        }
        if (Lampa.Platform.is("netcast")) {
          window.NetCastBack();
        }
        if (Lampa.Platform.is("noname")) {
          window.history.back();
        }
        if (Lampa.Platform.is("browser")) {
          window.close();
        }
        if (Lampa.Platform.is("nw")) {
          nw.Window.get().close();
        }
      } catch (e) {
        log("Ошибка при выходе (season):", e);
      }
    }

    // Действие: SpeedTest (nitza)
    function exitMenuSpeedTest() {
      try {
        var crissie = $('<div style="text-align:right;"><div style="min-height:360px;"><iframe id="speedtest-iframe" width="100%" height="100%" frameborder="0"></iframe></div></div>');
        Lampa.Modal.open({
          title: "",
          html: crissie,
          size: "medium",
          mask: true,
          onBack: function () {
            Lampa.Modal.close();
            Lampa.Controller.toggle("content");
          },
          onSelect: function () {}
        });
        var iframe = document.getElementById("speedtest-iframe");
        if (iframe) iframe.src = "http://speedtest.vokino.tv/?R=3";
      } catch (e) {
        log("Ошибка SpeedTest (exitMenuSpeedTest):", e);
      }
    }

    // Действие: очистка кэша (aubreanna)
    function exitMenuClearCache() {
      try {
        Lampa.Storage.clear();
        Lampa.Noty.show("Кэш Лампы очищен");
      } catch (e) {
        log("Ошибка очистки кэша:", e);
      }
    }

    // Действие: смена сервера (lakeeta)
    function exitMenuSwitchServer() {
      try {
        var proto = location.protocol === "https:" ? "https://" : "http://";
        Lampa.Input.edit(
          {
            title: "Укажите cервер",
            value: "",
            free: true
          },
          function (value) {
            if (value && value.trim() !== "") {
              window.location.href = proto + value.trim();
            }
          }
        );
      } catch (e) {
        log("Ошибка смены сервера:", e);
      }
    }

    // Открытие внешних сервисов
    function exitMenuOpenExternal(url) {
      try {
        window.location.href = url;
      } catch (e) {
        log("Ошибка при открытии URL:", url, e);
      }
    }

    // Возвращает HTML с иконкой и подписью для пункта меню выхода (иконки из menus.js)
    function exitMenuIconHtml(id) {
      switch (id) {
        case "exit":
          return '<div class="settings-folder" style="padding:0!important">'
            + '<div style="width:2.2em;height:1.7em;padding-right:.5em">'
            + '<svg width="256px" height="256px" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">'
            + '<g id="SVGRepo_bgCarrier" stroke-width="0"></g>'
            + '<g id="SVGRepo_tracerCarrier" stroke-linecap="round" stroke-linejoin="round"></g>'
            + '<g id="SVGRepo_iconCarrier">'
            + '<path d="M14.5 9.50002L9.5 14.5M9.49998 9.5L14.5 14.5" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"></path>'
            + '<path d="M22 12C22 16.714 22 19.0711 20.5355 20.5355C19.0711 22 16.714 22 12 22C7.28595 22 4.92893 22 3.46447 20.5355C2 19.0711 2 16.714 2 12C2 7.28595 2 4.92893 3.46447 3.46447C4.92893 2 7.28595 2 12 2C16.714 2 19.0711 2 20.5355 3.46447C21.5093 4.43821 21.8356 5.80655 21.9449 8" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"></path>'
            + '</g></svg></div>'
            + '<div style="font-size:1.3em">Закрыть приложение</div></div>';
        case "reboot":
          return '<div class="settings-folder" style="padding:0!important">'
            + '<div style="width:2.2em;height:1.7em;padding-right:.5em">'
            + '<svg viewBox="0 0 22 22" xmlns:dc="http://purl.org/dc/elements/1.1/" xmlns:cc="http://creativecommons.org/ns#" xmlns:rdf="http://www.w3.org/1999/02/22-rdf-syntax-ns#" xmlns="http://www.w3.org/2000/svg" id="svg4183" version="1.1" fill="currentColor">'
            + '<g id="SVGRepo_bgCarrier" stroke-width="0"></g>'
            + '<g id="SVGRepo_tracerCarrier" stroke-linecap="round" stroke-linejoin="round"></g>'
            + '<g id="SVGRepo_iconCarrier">'
            + '<metadata id="metadata4188"></metadata>'
            + '<g id="layer1" transform="rotate(-90 -504.181 526.181)">'
            + '<path style="opacity:1;fill:currentColor;stroke:none;stroke-width:4;stroke-linecap:square;stroke-linejoin:round;stroke-miterlimit:4;stroke-dasharray:none;stroke-dashoffset:3.2;stroke-opacity:.55" d="M11 2a9 9 0 0 0-4.676 1.324l1.461 1.461A7 7 0 0 1 11 4a7 7 0 0 1 7 7 7 7 0 0 1-.787 3.213l1.465 1.465A9 9 0 0 0 20 11a9 9 0 0 0-9-9zM3.322 6.322A9 9 0 0 0 2 11a9 9 0 0 0 9 9 9 9 0 0 0 4.676-1.324l-1.461-1.461A7 7 0 0 1 11 18a7 7 0 0 1-7-7 7 7 0 0 1 .787-3.213z" transform="translate(0 1030.362)" id="path840"></path>'
            + '<path style="fill:currentColor;stroke:none;stroke-width:1px" d="m7 1034.362 3 3 1-1-3-3z" id="path850"></path>'
            + '<path style="fill:currentColor;stroke:none;stroke-width:1px" d="m11 1046.362 3 3 1-1-3-3z" id="path850-3"></path>'
            + '</g></g></svg></div>'
            + '<div style="font-size:1.3em">Перезагрузить</div></div>';
        case "switch_server":
          return '<div class="settings-folder" style="padding:0!important">'
            + '<div style="width:2.2em;height:1.7em;padding-right:.5em">'
            + '<svg width="256px" height="256px" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg">'
            + '<g id="SVGRepo_bgCarrier" stroke-width="0"></g>'
            + '<g id="SVGRepo_tracerCarrier" stroke-linecap="round" stroke-linejoin="round"></g>'
            + '<g id="SVGRepo_iconCarrier">'
            + '<path d="M13 21.75C13.4142 21.75 13.75 21.4142 13.75 21C13.75 20.5858 13.4142 20.25 13 20.25V21.75ZM3.17157 19.8284L3.7019 19.2981H3.7019L3.17157 19.8284ZM20.8284 4.17157L20.2981 4.7019V4.7019L20.8284 4.17157ZM21.25 13C21.25 13.4142 21.5858 13.75 22 13.75C22.4142 13.75 22.75 13.4142 22.75 13H21.25ZM10 3.75H14V2.25H10V3.75Z" fill="currentColor"></path>'
            + '<path d="M13.5 7.5L18 7.5" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"></path>'
            + '<path d="M6 17.5L6 15.5" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"></path>'
            + '<path d="M6 8.5L6 6.5" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"></path>'
            + '<path d="M9 17.5L9 15.5" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"></path>'
            + '<path d="M9 8.5L9 6.5" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"></path>'
            + '</g></svg></div>'
            + '<div style="font-size:1.3em">Сменить сервер</div></div>';
        case "clear_cache":
          return '<div class="settings-folder" style="padding:0!important">'
            + '<div style="width:2.2em;height:1.7em;padding-right:.5em">'
            + '<svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 32 32">'
            + '<path fill="currentColor" d="M26 20h-6v-2h6zm4 8h-6v-2h6zm-2-4h-6v-2h6z"/>'
            + '<path fill="currentColor" d="M17.003 20a4.9 4.9 0 0 0-2.404-4.173L22 3l-1.73-1l-7.577 13.126a5.7 5.7 0 0 0-5.243 1.503C3.706 20.24 3.996 28.682 4.01 29.04a1 1 0 0 0 1 .96h14.991a1 1 0 0 0 .6-1.8c-3.54-2.656-3.598-8.146-3.598-8.2m-5.073-3.003A3.11 3.11 0 0 1 15.004 20c0 .038.002.208.017.469l-5.9-2.624a3.8 3.8 0 0 1 2.809-.848M15.45 28A5.2 5.2 0 0 1 14 25h-2a6.5 6.5 0 0 0 .968 3h-2.223A16.6 16.6 0 0 1 10 24H8a17.3 17.3 0 0 0 .665 4H6c.031-1.836.29-5.892 1.803-8.553l7.533 3.35A13 13 0 0 0 17.596 28Z"/>'
            + '</svg></div>'
            + '<div style="font-size:1.3em">Очистить кэш</div></div>';
        case "youtube":
          return '<div class="settings-folder" style="padding:0!important">'
            + '<div style="width:2.2em;height:1.7em;padding-right:.5em">'
            + '<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 20 20">'
            + '<path fill="currentColor" d="M10 2.3C.172 2.3 0 3.174 0 10s.172 7.7 10 7.7s10-.874 10-7.7s-.172-7.7-10-7.7m3.205 8.034l-4.49 2.096c-.393.182-.715-.022-.715-.456V8.026c0-.433.322-.638.715-.456l4.49 2.096c.393.184.393.484 0 .668"/>'
            + '</svg></div>'
            + '<div style="font-size:1.3em">YouTube</div></div>';
        case "rutube":
          return '<div class="settings-folder" style="padding:0!important">'
            + '<div style="width:2.2em;height:1.7em;padding-right:.5em">'
            + '<svg width="256px" height="256px" viewBox="0 0 192 192" xmlns="http://www.w3.org/2000/svg" fill="none">'
            + '<g id="SVGRepo_bgCarrier" stroke-width="0"></g>'
            + '<g id="SVGRepo_tracerCarrier" stroke-linecap="round" stroke-linejoin="round"></g>'
            + '<g id="SVGRepo_iconCarrier">'
            + '<path fill="#ffffff" d="M128.689 47.57H20.396v116.843h30.141V126.4h57.756l26.352 38.013h33.75l-29.058-38.188c9.025-1.401 15.522-4.73 19.493-9.985 3.97-5.255 5.956-13.664 5.956-24.875v-8.759c0-6.657-.721-11.912-1.985-15.941-1.264-4.029-3.43-7.533-6.498-10.686-3.249-2.978-6.858-5.08-11.19-6.481-4.332-1.226-9.747-1.927-16.424-1.927z" style="display:inline;fill:none;stroke:#ffffff;stroke-width:12;stroke-linecap:round;stroke-linejoin:round" transform="translate(1.605 -1.99)"></path>'
            + '<path fill="#ffffff" d="M162.324 45.568c5.52 0 9.998-4.477 9.998-10s-4.478-10-9.998-10c-5.524 0-10.002 4.477-10.002 10s4.478 10 10.002 10z" style="display:inline;fill:#ffffff;stroke:none;stroke-width:10.6667" transform="translate(1.605 -1.99)"></path>'
            + '</g></svg></div>'
            + '<div style="font-size:1.3em">RuTube</div></div>';
        case "drm_play":
          return '<div class="settings-folder" style="padding:0!important">'
            + '<div style="width:2.2em;height:1.7em;padding-right:.5em">'
            + '<svg fill="#ffffff" width="256px" height="256px" viewBox="0 -6 46 46" xmlns="http://www.w3.org/2000/svg" stroke="#ffffff" stroke-width="2.3">'
            + '<g id="SVGRepo_bgCarrier" stroke-width="0"></g>'
            + '<g id="SVGRepo_tracerCarrier" stroke-linecap="round" stroke-linejoin="round"></g>'
            + '<g id="SVGRepo_iconCarrier">'
            + '<path id="_24.TV" d="M46,37H2a1,1,0,0,1-1-1V8A1,1,0,0,1,2,7H46a1,1,0,0,1,1,1V36A1,1,0,0,1,46,37ZM45,9H3V35H45ZM21,16a.975.975,0,0,1,.563.2l7.771,4.872a.974.974,0,0,1,.261,1.715l-7.974,4.981A.982.982,0,0,1,21,28a1,1,0,0,1-1-1V17A1,1,0,0,1,21,16ZM15,39H33a1,1,0,0,1,0,2H15a1,1,0,0,1,0-2Z" transform="translate(-1 -7)" fill-rule="evenodd"></path>'
            + '</g></svg></div>'
            + '<div style="font-size:1.3em">DRM Play</div></div>';
        case "twitch":
          return '<div class="settings-folder" style="padding:0!important">'
            + '<div style="width:2.2em;height:1.7em;padding-right:.5em">'
            + '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24">'
            + '<path fill="currentColor" d="M3.774 2L2.45 5.452v14.032h4.774V22h2.678l2.548-2.548h3.871l5.226-5.226V2zm15.968 11.323l-3 3h-4.743L9.452 18.87v-2.548H5.42V3.774h14.32zm-2.968-6.097v5.226h-1.775V7.226zm-4.775 0v5.226h-1.774V7.226z"/>'
            + '</svg></div>'
            + '<div style="font-size:1.3em">Twitch</div></div>';
        case "fork_player":
          return '<div class="settings-folder" style="padding:0!important">'
            + '<div style="width:2.2em;height:1.7em;padding-right:.5em">'
            + '<svg width="256px" height="256px" viewBox="0 0 32 32" xmlns="http://www.w3.org/2000/svg" fill="#000000" stroke="#000000" stroke-width="0.00032">'
            + '<g id="SVGRepo_bgCarrier" stroke-width="0"></g>'
            + '<g id="SVGRepo_tracerCarrier" stroke-linecap="round" stroke-linejoin="round"></g>'
            + '<g id="SVGRepo_iconCarrier">'
            + '<g fill="none" fill-rule="evenodd">'
            + '<path d="m0 0h32v32h-32z"></path>'
            + '<g fill="#ffffff" fill-rule="nonzero">'
            + '<path d="m32 16c0-8.836-7.164-16-16-16S0 7.164 0 16s7.164 16 16 16s16-7.164 16-16zM1.455 16C1.455 7.967 7.967 1.455 16 1.455S30.545 7.967 30.545 16 24.033 30.545 16 30.545 1.455 24.033 1.455 16z"></path>'
            + '<path d="M16.614 25.235v-9.235h3.047l.481-3.06h-3.529v-1.535c0-.799.262-1.56 1.408-1.56h2.291V6.79h-3.252c-2.735 0-3.481 1.801-3.481 4.297v1.852H11.3v3.062h1.876v9.235z"></path>'
            + '</g></g></g></svg></div>'
            + '<div style="font-size:1.3em">ForkPlayer</div></div>';
        case "speedtest":
          return '<div class="settings-folder" style="padding:0!important">'
            + '<div style="width:2.2em;height:1.7em;padding-right:.5em">'
            + '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24">'
            + '<path fill="currentColor" d="M10.45 15.5q.625.625 1.575.588T13.4 15.4L19 7l-8.4 5.6q-.65.45-.712 1.362t.562 1.538M5.1 20q-.55 0-1.012-.238t-.738-.712q-.65-1.175-1-2.437T2 14q0-2.075.788-3.9t2.137-3.175T8.1 4.788T12 4q2.05 0 3.85.775T19 6.888t2.15 3.125t.825 3.837q.025 1.375-.312 2.688t-1.038 2.512q-.275.475-.737.713T18.874 20z"/>'
            + '</svg></div>'
            + '<div style="font-size:1.3em">Speed Test</div></div>';
        default:
          return id;
      }
    }


        // Построение списка пунктов меню выхода (с иконками из exitMenuIconHtml)
    function exitMenuBuildItems() {
      var items = [];

      if (localStorage.getItem("exit") !== "1") {
        items.push({
          id: "exit",
          title: exitMenuIconHtml("exit")
        });
      }

      if (localStorage.getItem("reboot") !== "1") {
        items.push({
          id: "reboot",
          title: exitMenuIconHtml("reboot")
        });
      }

      if (localStorage.getItem("switch_server") !== "1") {
        items.push({
          id: "switch_server",
          title: exitMenuIconHtml("switch_server")
        });
      }

      if (localStorage.getItem("clear_cache") !== "1") {
        items.push({
          id: "clear_cache",
          title: exitMenuIconHtml("clear_cache")
        });
      }

      if (localStorage.getItem("youtube") !== "1") {
        items.push({
          id: "youtube",
          title: exitMenuIconHtml("youtube")
        });
      }

      if (localStorage.getItem("rutube") !== "1") {
        items.push({
          id: "rutube",
          title: exitMenuIconHtml("rutube")
        });
      }

      if (localStorage.getItem("drm_play") !== "1") {
        items.push({
          id: "drm_play",
          title: exitMenuIconHtml("drm_play")
        });
      }

      if (localStorage.getItem("twitch") !== "1") {
        items.push({
          id: "twitch",
          title: exitMenuIconHtml("twitch")
        });
      }

      if (localStorage.getItem("fork_player") !== "1") {
        items.push({
          id: "fork_player",
          title: exitMenuIconHtml("fork_player")
        });
      }

      if (localStorage.getItem("speedtest") !== "1") {
        items.push({
          id: "speedtest",
          title: exitMenuIconHtml("speedtest")
        });
      }

      return items;
    }


    // Основная функция: открыть меню выхода (через Lampa.Select)
    function exitMenuOpen() {
      try {
        exitMenuEnsureDefaults();

        var items = exitMenuBuildItems();

        if (!items.length) {
          Lampa.Noty.show("Все пункты меню выхода скрыты в настройках");
          return;
        }

        Lampa.Select.show({
          title: "Меню выхода",
          items: items,
          onBack: function () {
            Lampa.Controller.toggle("content");
          },
          onSelect: function (selected) {
            switch (selected.id) {
              case "exit":
                exitMenuSeason();
                break;
              case "reboot":
                location.reload();
                break;
              case "switch_server":
                exitMenuSwitchServer();
                break;
              case "clear_cache":
                exitMenuClearCache();
                break;
              case "youtube":
                exitMenuOpenExternal("https://youtube.com/tv");
                break;
              case "rutube":
                exitMenuOpenExternal("https://rutube.ru/tv-release/rutube.server-22.0.0/webos/");
                break;
              case "drm_play":
                exitMenuOpenExternal("https://ott.drm-play.com");
                break;
              case "twitch":
                exitMenuOpenExternal("https://webos.tv.twitch.tv");
                break;
              case "fork_player":
                exitMenuOpenExternal("http://browser.appfxml.com");
                break;
              case "speedtest":
                exitMenuSpeedTest();
                break;
            }
          }
        });
      } catch (e) {
        log("Ошибка при открытии меню выхода:", e);
      }
    }


    // Добавляем раздел настроек только один раз
    function registerSettings() {
      try {
        // Основной переключатель MADNESS
        Lampa.SettingsApi.addParam({
          component: "more",
          param: {
            name: "drxaos_supermenu_madness",
            type: "toggle",
            default: SuperMenuConfig.FEATURES.madness
          },
          field: {
            name: "MADNESS режим",
            description: "Визуальные эффекты и расширенные украшения интерфейса"
          }
        });

        // Режим производительности (для слабых устройств)
        Lampa.SettingsApi.addParam({
          component: "more",
          param: {
            name: "drxaos_supermenu_perf_mode",
            type: "select",
            values: {
              normal: "Обычный режим",
              android_perf: "Щадящий режим (Android TV)"
            },
            default: SuperMenuConfig.PLATFORM.isAndroid ? "android_perf" : "normal"
          },
          field: {
            name: "Производительность плагина",
            description: "Настройка отзывчивости интерфейса и нагрузки на устройство"
          }
        });

        // Рейтинги: TMDB, IMDb, КиноПоиск, другие
        Lampa.SettingsApi.addParam({
          component: "more",
          param: {
            name: "drxaos_supermenu_ratings_tmdb",
            type: "toggle",
            default: SuperMenuConfig.FEATURES.ratings_tmdb
          },
          field: {
            name: "Рейтинг TMDB",
            description: "Отображать рейтинг TMDB на карточках"
          }
        });

        Lampa.SettingsApi.addParam({
          component: "more",
          param: {
            name: "drxaos_supermenu_ratings_imdb",
            type: "toggle",
            default: SuperMenuConfig.FEATURES.ratings_imdb
          },
          field: {
            name: "Рейтинг IMDb",
            description: "Отображать рейтинг IMDb на карточках"
          }
        });

        Lampa.SettingsApi.addParam({
          component: "more",
          param: {
            name: "drxaos_supermenu_ratings_kp",
            type: "toggle",
            default: SuperMenuConfig.FEATURES.ratings_kp
          },
          field: {
            name: "Рейтинг КиноПоиск",
            description: "Отображать рейтинг КиноПоиск (требуется внешнее API)"
          }
        });

        // Цвета меток качества и типа
        Lampa.SettingsApi.addParam({
          component: "more",
          param: {
            name: "drxaos_supermenu_label_colors",
            type: "toggle",
            default: SuperMenuConfig.FEATURES.label_colors
          },
          field: {
            name: "Цветные метки качества и типа",
            description: "Раскраска текста качества и типа (фильм/сериал)"
          }
        });

        // Включение/выключение интеграции меню выхода в верхнюю панель
        Lampa.SettingsApi.addParam({
          component: "more",
          param: {
            name: "drxaos_supermenu_topbar_exit",
            type: "toggle",
            default: SuperMenuConfig.FEATURES.topbar_exit_menu
          },
          field: {
            name: "Меню выхода в верхней панели",
            description: "Добавить кнопку меню выхода рядом с консолью и перезагрузкой"
          }
        });
      } catch (e) {
        log("Ошибка при регистрации настроек:", e);
      }
    }

    // === Заготовка под интеграцию меню выхода (из menus.js) в верхнюю панель ===

    function registerTopBarButton() {
      try {
        if (!SuperMenuConfig.FEATURES.topbar_exit_menu) {
          return;
        }

        // Здесь мы не трогаем стандартные кнопки, а аккуратно добавляем свою.
        // В следующих частях вместо stub-вызова будет подключена логика из menus.js.
        // Псевдокод: Lampa.Panel.addButton / изменение существующей панели.
        if (Lampa && Lampa.Panel && Lampa.Panel.add) {
          Lampa.Panel.add({
            name: "drxaos_supermenu_exit",
            title: "Меню выхода",
            // TODO: сюда вставим иконку из menus.js (SVG) в следующей части
            icon: '<svg viewBox="0 0 24 24" fill="currentColor"><path d="M14.5 9.5L9.5 14.5M9.5 9.5L14.5 14.5"></path><path d="M22 12C22 16.7 22 19.1 20.5 20.5C19.1 22 16.7 22 12 22C7.3 22 4.9 22 3.5 20.5C2 19.1 2 16.7 2 12C2 7.3 2 4.9 3.5 3.5C4.9 2 7.3 2 12 2C16.7 2 19.1 2 20.5 3.5C21.5 4.4 21.8 5.8 21.9 8"></path></svg>',
            onClick: function () {
              exitMenuOpen();
            }

          });
        } else {
          log("Panel API недоступен, кнопка верхней панели не будет добавлена");
        }
      } catch (e) {
        log("Ошибка при добавлении верхней кнопки:", e);
      }
    }

    // === Применение настроек пользователя (считывание из Lampa.Storage) ===

    function applyUserSettings() {
      try {
        var madness = Lampa.Storage.get("drxaos_supermenu_madness", SuperMenuConfig.FEATURES.madness ? "true" : "false") === "true";
        var perfMode = Lampa.Storage.get("drxaos_supermenu_perf_mode", SuperMenuConfig.PLATFORM.isAndroid ? "android_perf" : "normal");
        var ratingsTmdb = Lampa.Storage.get("drxaos_supermenu_ratings_tmdb", SuperMenuConfig.FEATURES.ratings_tmdb ? "true" : "false") === "true";
        var ratingsImdb = Lampa.Storage.get("drxaos_supermenu_ratings_imdb", SuperMenuConfig.FEATURES.ratings_imdb ? "true" : "false") === "true";
        var ratingsKp = Lampa.Storage.get("drxaos_supermenu_ratings_kp", SuperMenuConfig.FEATURES.ratings_kp ? "true" : "false") === "true";
        var labelColors = Lampa.Storage.get("drxaos_supermenu_label_colors", SuperMenuConfig.FEATURES.label_colors ? "true" : "false") === "true";
        var topbarExit = Lampa.Storage.get("drxaos_supermenu_topbar_exit", SuperMenuConfig.FEATURES.topbar_exit_menu ? "true" : "false") === "true";

        SuperMenuConfig.FEATURES.madness = madness;
        SuperMenuConfig.FEATURES.ratings_tmdb = ratingsTmdb;
        SuperMenuConfig.FEATURES.ratings_imdb = ratingsImdb;
        SuperMenuConfig.FEATURES.ratings_kp = ratingsKp;
        SuperMenuConfig.FEATURES.label_colors = labelColors;
        SuperMenuConfig.FEATURES.topbar_exit_menu = topbarExit;

        if (perfMode === "android_perf") {
          SuperMenuConfig.PERFORMANCE.DEBOUNCE_DELAY = 500;
          SuperMenuConfig.PERFORMANCE.THROTTLE_LIMIT = 150;
          SuperMenuConfig.PERFORMANCE.MUTATION_THROTTLE = 80;
        }

        log("Применены пользовательские настройки SuperMenu:", SuperMenuConfig);
      } catch (e) {
        log("Ошибка при применении пользовательских настроек:", e);
      }
    }

    // Регистрируем настройки и верхнюю кнопку
    registerSettings();
    applyUserSettings();
    registerTopBarButton();

    // В следующих частях:
    // - подключим реальную логику меню выхода из menus.js в onClick верхней кнопки
    // - интегрируем цвета меток, рейтинги, MADNESS и новую тему
  }

  if (window.appready) {
    init();
  } else {
    Lampa.Listener.follow("app", function (e) {
      if (e.type === "ready") init();
    });
  }
}());
